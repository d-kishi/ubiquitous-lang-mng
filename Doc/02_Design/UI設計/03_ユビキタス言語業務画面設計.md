# ユビキタス言語業務画面設計

**作成日**: 2025-06-27  
**対象**: ユビキタス言語管理システム  
**カテゴリ**: ユビキタス言語業務関連画面（3画面）  

## 1. 共通レイアウト要素

### 1.1 基本構成
- **ヘッダー**: システム名、ユーザー名、ログアウトボタン
- **サイドメニュー**: 開閉可能な左サイドバー（権限別表示制御）
- **メインコンテンツエリア**: 各画面の主要コンテンツ
- **フッター**: シンプルなフッター（著作権表示等）

### 1.2 業務画面共通の特徴
- **ホーム画面**: ユビキタス言語一覧がログイン直後の表示画面
- **リアルタイム通知**: 承認依頼時のトースター通知（承認者のみ）
- **競合処理**: 先勝ち方式、競合時は警告表示
- **エクスポート機能**: AI向けMarkdown、CSV出力

### 1.3 権限別アクセス制御
- **一般ユーザー**: 一覧表示、入力・編集
- **ドメイン承認者以上**: 一覧表示、入力・編集、承認
- **プロジェクト管理者以上**: 表示プロジェクト切り替え、削除操作

## 2. 画面別詳細設計

### 2.1 ユビキタス言語一覧画面（ホーム画面）

#### 画面概要
- **目的**: 承認済みユビキタス言語の一覧確認・検索・エクスポート
- **アクセス**: ログイン直後の初期画面、サイドメニュー > ホーム
- **権限**: 全ユーザー（表示データは権限により制限）

#### UI構成
```
┌─ サイドメニュー ─┬─────────────────────────────────┐
│ ☰ メニュー       │      ユビキタス言語一覧          │
│                  │                                 │
│ ホーム           │ ┌─────────────────────────────┐ │
│ 入力・編集       │ │        検索・フィルタ        │ │
│ 承認             │ │ プロジェクト: [ECサイト ▼]    │ │
│ ユーザー管理     │ │ ドメイン: [すべて ▼]          │ │
│ プロジェクト管理 │ │ 和名: [____] 意味: [____]      │ │
│ ドメイン管理     │ │ [検索]                       │ │
│ プロフィール変更 │ └─────────────────────────────┘ │
│ パスワード変更   │                                 │
│ ログアウト       │ ┌─────────────────────────────┐ │
│                  │ │ [AI向けエクスポート] [CSV出力] │ │
│                  │ └─────────────────────────────┘ │
│                  │                                 │
│                  │ ┌─────────────────────────────┐ │
│                  │ │和名   │英名   │意味     │機会 │ │
│                  │ │注文   │Order  │顧客要求 │MTG  │ │
│                  │ │商品   │Product│販売対象 │要件 │ │
│                  │ │顧客   │Customer│購入者  │分析 │ │
│                  │ │ ↑クリックで詳細ポップアップ   │ │
│                  │ └─────────────────────────────┘ │
│                  │                                 │
│                  │ ┌─ ページング ─────────────────┐ │
│                  │ │ << 前 1 2 3 次 >> 100件/頁 │ │
│                  │ └─────────────────────────────┘ │
└──────────────────┴─────────────────────────────────┘
```

#### 表示項目・機能

##### 検索・フィルタ機能
- **プロジェクト**: プルダウン選択（権限により表示プロジェクト制限）
- **ドメイン**: プルダウン選択（「すべてのドメイン」含む）
- **和名**: 部分一致検索
- **意味**: 部分一致検索

##### 一覧表示項目
- **和名**: 必須項目、ソート可能
- **英名**: 必須項目、ソート可能
- **意味**: 必須項目
- **発生機会**: 任意項目

##### エクスポート機能
- **AI向けエクスポート**: Markdown形式、現在の検索条件で絞り込んだデータを出力
- **CSV出力**: CSV形式、現在の検索条件で絞り込んだデータを出力

##### 詳細表示機能
- **行クリック**: 詳細情報ポップアップ表示
- **ポップアップ内容**: 全項目 + 関連用語 + 備考 + 変更履歴

#### 権限別表示制御
- **スーパーユーザー**: 全プロジェクトを選択可能
- **プロジェクト管理者**: 担当プロジェクトのみ選択可能
- **ドメイン承認者・一般ユーザー**: 所属プロジェクトのみ選択可能

#### 詳細表示ポップアップ

```
┌───────────────────────────────────────┐
│            用語詳細情報               │
│                                      │
│ 和名: 注文                           │
│ 英名: Order                          │
│ 意味: 顧客からの商品購入依頼          │
│ ドメイン: 注文管理                   │
│ 発生機会: EC要件定義MTG              │
│ 関連用語: 商品、顧客、決済           │
│ 備考: 複数商品の同時注文も可能       │
│                                      │
│ ┌─ 変更履歴（最新5件）──────────┐  │
│ │日時      │変更者│変更内容      │  │
│ │2025/06/20│田中  │英名を修正     │  │
│ │2025/06/15│佐藤  │意味を詳細化   │  │
│ │2025/06/10│鈴木  │新規作成      │  │
│ │          ↓（スクロール）         │  │
│ └──────────────────────────────┘  │
│                                      │
│              [閉じる]                │
└───────────────────────────────────────┘
```

### 2.2 ユビキタス言語入力・編集画面

#### 画面概要
- **目的**: ユビキタス言語の高速入力・編集・承認申請
- **アクセス**: サイドメニュー > 入力・編集
- **権限**: 全ユーザー（削除操作は承認者以上）
- **特徴**: Excel風インライン編集、リアルタイム保存

#### UI構成
```
┌─ サイドメニュー ─┬─────────────────────────────────┐
│ ☰ メニュー       │     ユビキタス言語入力・編集      │
│                  │                                 │
│ ホーム           │ ┌─────────────────────────────┐ │
│ 入力・編集       │ │        検索・フィルタ        │ │
│ 承認             │ │ プロジェクト: [ECサイト ▼]    │ │
│ ユーザー管理     │ │ ドメイン: [注文管理 ▼]        │ │
│ プロジェクト管理 │ │ 状態: [ドラフト ▼]            │ │
│ ドメイン管理     │ │ 和名: [____] [検索]           │ │
│ プロフィール変更 │ └─────────────────────────────┘ │
│ パスワード変更   │                                 │
│ ログアウト       │ ┌─────────────────────────────┐ │
│                  │ │          [新規追加]          │ │
│                  │ └─────────────────────────────┘ │
│                  │                                 │
│                  │ ┌─ Excel風編集テーブル ───────┐ │
│                  │ │和名*│英名 │意味*│ドメイン*│状態│ │
│                  │ │注文 │Order│購入 │注文管理 │承認│ │
│                  │ │商品 │[___]│[編集中___]│[注文▼]│草稿│ │
│                  │ │[新規行_____________]│      │    │ │
│                  │ │              [申請] [削除]   │ │
│                  │ └─────────────────────────────┘ │
│                  │                                 │
│                  │ ┌─ ページング ─────────────────┐ │
│                  │ │ << 前 1 2 3 次 >> 50件/頁  │ │
│                  │ └─────────────────────────────┘ │
└──────────────────┴─────────────────────────────────┘
```

#### 入力・編集機能

##### Excel風インライン編集
- **セル単位編集**: 各項目をクリックで編集モード
- **Tab移動**: 横方向のセル移動
- **Enter確定**: 編集内容確定、下のセルに移動
- **新規行追加**: テーブル最下行で新規ドラフト自動作成

##### 自動保存機能
- **保存タイミング**: 行からフォーカスが外れた際
- **保存対象**: 同一行内での移動では保存されない
- **競合処理**: 保存時に競合検知、先勝ち方式
- **保存状態表示**: 保存中・保存完了・エラーの視覚的表示

##### 表示項目・編集制御
- **和名**: 必須、編集可能
- **英名**: 任意、編集可能
- **意味**: ドラフト時任意・正式版時必須、編集可能
- **ドメイン**: 必須、プルダウン選択
- **発生機会**: 任意、編集可能
- **関連用語**: 任意、複数選択
- **備考**: 任意、複数行テキスト
- **状態**: 表示のみ（ドラフト/承認待ち/承認済み）

##### 操作ボタン・アクション
- **申請ボタン**: ドラフト状態の用語を承認申請
- **削除ボタン**: 状態・権限に応じた表示制御
- **新規追加ボタン**: 新しいドラフト行をテーブル最上部に追加

##### 削除ボタンの権限制御
- **状態がドラフトの場合**:
  - 一般ユーザー: 自身が作成したデータのみ削除可能（物理削除）
  - ドメイン承認者以上: すべてのドラフトデータ削除可能（物理削除）
- **状態が承認待ちの場合**:
  - 全ユーザー: 削除不可（削除ボタン非表示）
- **状態が承認済みの場合**:
  - ドメイン承認者以上: 削除可能（論理削除）
  - 一般ユーザー: 削除不可（削除ボタン非表示）

#### 状態管理・ワークフロー

##### 用語の状態遷移
```
新規作成 → ドラフト → 承認申請 → 承認待ち → 承認済み
                          ↓
                        却下 → ドラフト（却下理由付き）
```

##### 承認申請の条件
- **必須項目入力**: 和名、英名、意味、ドメイン
- **申請実行**: 承認申請ボタンで状態を「承認待ち」に変更
- **通知発送**: 対象ドメインの承認者にリアルタイム通知

##### 編集権限・制約
- **ドラフト**: 全ユーザーが編集可能（他人作成分も含む）
- **承認待ち**: 編集不可
- **承認済み**: 編集時は新ドラフト自動作成

#### 競合エラー処理

##### エラー検知・表示
```
┌─────────────────────────────────────┐
│              競合エラー             │
│                                     │
│ 他のユーザーが同時編集中です。      │
│ 画面を更新してください。            │
│                                     │
│              [OK]                   │
└─────────────────────────────────────┘
```

##### 対処方法
- **エラー発生**: 保存処理をキャンセル
- **ユーザー操作**: F5キーでブラウザ更新
- **編集内容**: 編集中データは失われる（警告表示）

### 2.3 ユビキタス言語承認画面

#### 画面概要
- **目的**: 承認待ちユビキタス言語の承認・却下処理
- **アクセス**: サイドメニュー > 承認
- **権限**: ドメイン承認者以上
- **機能**: 個別承認・一括承認、却下理由入力

#### UI構成
```
┌─ サイドメニュー ─┬─────────────────────────────────┐
│ ☰ メニュー       │      ユビキタス言語承認          │
│                  │                                 │
│ ホーム           │ ┌─────────────────────────────┐ │
│ 入力・編集       │ │        検索・フィルタ        │ │
│ 承認             │ │ プロジェクト: [ECサイト ▼]    │ │
│ ユーザー管理     │ │ ドメイン: [注文管理 ▼]        │ │
│ プロジェクト管理 │ │ 和名: [____] 意味: [____]      │ │
│ ドメイン管理     │ │ [検索]                       │ │
│ プロフィール変更 │ └─────────────────────────────┘ │
│ パスワード変更   │                                 │
│ ログアウト       │ ┌─────────────────────────────┐ │
│                  │ │☐ 全選択                     │ │
│                  │ │[一括承認] [一括却下]          │ │
│                  │ └─────────────────────────────┘ │
│                  │                                 │
│                  │ ┌─ 承認待ち一覧 ──────────────┐ │
│                  │ │☐│和名│英名│意味   │申請者│日時│ │
│                  │ │☐│注文│Order│購入要求│田中│6/25│ │
│                  │ │☐│配送│Ship│商品輸送│佐藤│6/24│ │
│                  │ │☐│決済│Pay │支払処理│鈴木│6/23│ │
│                  │ │  │    │    │[承認][却下]    │ │
│                  │ └─────────────────────────────┘ │
│                  │                                 │
│                  │ ┌─ ページング ─────────────────┐ │
│                  │ │ << 前 1 2 3 次 >> 100件/頁 │ │
│                  │ └─────────────────────────────┘ │
└──────────────────┴─────────────────────────────────┘
```

#### 表示項目・機能

##### 検索・フィルタ機能
- **プロジェクト**: 承認者の担当プロジェクトに限定
- **ドメイン**: 承認者の担当ドメインに限定
- **和名・意味**: 部分一致検索
- **申請者**: 申請者による絞り込み

##### 承認待ち一覧表示
- **チェックボックス**: 一括操作用の選択
- **和名**: 必須項目
- **英名**: 必須項目  
- **意味**: 必須項目
- **発生機会**: 任意項目
- **関連用語**: 任意項目
- **備考**: 任意項目
- **却下理由**: 却下された場合のみ表示
- **申請者氏名**: 申請実行者
- **申請日時**: 承認申請日時

##### ソート機能
- **デフォルト**: 申請日時降順（新しい順）
- **選択可能**: 和名、英名、発生機会、申請者氏名、申請日時

#### 承認・却下処理

##### 個別操作
- **承認ボタン**: 行単位での承認実行
- **却下ボタン**: 行単位での却下実行（理由入力必須）

##### 一括操作の流れ
1. **選択**: チェックボックスで対象行を選択
2. **実行**: 「一括承認」または「一括却下」ボタン押下
3. **確認**: 確認ダイアログ表示
4. **処理**: 実行ボタンで承認・却下処理実行

#### 承認確認ダイアログ

```
┌─────────────────────────────────────┐
│              承認確認               │
│                                     │
│ 選択した3件の用語を承認します。     │
│ 承認してよろしいですか？            │
│                                     │
│          [承認]  [キャンセル]        │
└─────────────────────────────────────┘
```

#### 却下理由入力ダイアログ

```
┌─────────────────────────────────────┐
│              却下理由               │
│                                     │
│ 却下理由を入力してください。        │
│                                     │
│ ┌─────────────────────────────────┐ │
│ │意味の説明が不十分です。          │ │
│ │より具体的な定義をお願いします。  │ │
│ │                                 │ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│          [却下]  [キャンセル]        │
└─────────────────────────────────────┘
```

#### 通知機能

##### リアルタイム通知
- **対象**: 承認権限を持つユーザーのみ
- **タイミング**: 承認申請が実行された際
- **表示方式**: 画面右下のトースター表示
- **メッセージ**: 「新規承認依頼が届きました。」（具体的内容は不要）
- **表示時間**: 5秒間

##### 通知の技術実装
- **SignalR**: Blazor Server のリアルタイム通信機能
- **対象判定**: ユーザーの承認権限・担当ドメインに基づく配信制御
- **接続管理**: ログイン中ユーザーの接続状態管理

## 3. 画面遷移図

```
ログイン画面
    ↓（認証成功）
ユビキタス言語一覧画面（ホーム）
    ↓（サイドメニュー）
┌─ ユビキタス言語入力・編集画面
│       ↓（承認申請）
└─ ユビキタス言語承認画面
       ↓（承認・却下）
   ユビキタス言語一覧画面（更新反映）

ホーム画面（一覧）
    ↓（行クリック）
詳細表示ポップアップ
    ↓（閉じる）
ホーム画面（一覧）

入力・編集画面
    ↓（エクスポートボタン）
ファイルダウンロード（自動）
```

## 4. エクスポート機能詳細

### 4.1 AI向けエクスポート（Markdown）

#### 出力形式
```markdown
# ECサイト ユビキタス言語辞書

## 注文管理ドメイン

### 注文 (Order)
- **定義**: 顧客からの商品購入依頼
- **発生機会**: EC要件定義MTG
- **関連用語**: 商品、顧客
- **上位概念**: 取引

### 商品 (Product)
- **定義**: 販売対象となるアイテム
- **発生機会**: 商品企画会議
- **関連用語**: 注文、在庫
```

#### 出力条件
- **対象データ**: 承認済み正式版のみ
- **絞り込み**: 現在の検索条件を適用
- **ファイル名**: `{プロジェクト名}-ubiquitous-language.md`

### 4.2 CSV出力

#### 出力形式
```csv
和名,英名,意味,ドメイン,発生機会,関連用語,備考
注文,Order,顧客からの商品購入依頼,注文管理,EC要件定義MTG,商品;顧客,複数商品対応
商品,Product,販売対象となるアイテム,商品管理,商品企画会議,注文;在庫,カテゴリ分類有り
```

#### 出力条件
- **対象データ**: 現在の検索条件を適用
- **文字エンコード**: UTF-8 BOM付き
- **ファイル名**: `{プロジェクト名}-ubiquitous-language-{YYYYMMDD}.csv`

## 5. 技術仕様・実装考慮事項

### 5.1 リアルタイム機能
- **SignalR Hub**: 承認通知用のリアルタイム通信
- **接続グループ**: ドメイン別の通知グループ管理
- **セッション管理**: ユーザーの接続状態・権限情報の管理

### 5.2 Excel風UI実装
- **Blazor Component**: テーブル形式の編集可能コンポーネント
- **フォーカス管理**: Tab/Enter キーでのセル移動制御
- **バリデーション**: リアルタイムバリデーション・エラー表示
- **状態管理**: 編集中・保存中・エラー状態の視覚的表現

### 5.3 競合制御
- **楽観ロック**: RowVersion/Timestamp による競合検知
- **エラーハンドリング**: 競合エラー時の適切なメッセージ表示
- **データ整合性**: 先勝ち方式による一貫性保証

### 5.4 パフォーマンス
- **遅延ロード**: 大量データの段階的ロード
- **検索最適化**: インデックス設計・クエリ最適化
- **キャッシュ**: プロジェクト・ドメイン情報のメモリキャッシュ

### 5.5 セキュリティ
- **認可制御**: 画面・操作レベルでの詳細権限チェック
- **データフィルタ**: ユーザー権限に基づくデータ表示制限
- **入力検証**: XSS・SQLインジェクション対策

## 6. ユーザビリティ・アクセシビリティ

### 6.1 ユーザビリティ
- **高速入力**: Excel風操作によるミーティング中の素早い入力
- **視覚的フィードバック**: 保存状態・エラー状態の明確な表示
- **ショートカットキー**: Tab/Enter/Esc等の標準的なキー操作

### 6.2 アクセシビリティ
- **キーボード操作**: マウスなしでの全機能利用
- **スクリーンリーダー**: aria-label等の適切な設定
- **色覚サポート**: 色のみに依存しない状態表示

## 7. エラーハンドリング・メッセージ一覧

### 7.1 バリデーションエラー
- **必須項目未入力**: 「○○は必須項目です」
- **文字数制限**: 「○○は△△文字以内で入力してください」
- **重複チェック**: 「この用語名は既に存在します」

### 7.2 業務エラー
- **権限エラー**: 「この操作の権限がありません」
- **競合エラー**: 「他のユーザーが同時編集中です。画面を更新してください。」
- **データ不整合**: 「データの整合性エラーが発生しました」

### 7.3 成功メッセージ
- **保存成功**: 「保存しました」
- **承認成功**: 「承認が完了しました」
- **申請成功**: 「承認申請を送信しました」

---

**関連文書**:
- 要件定義書: `/Doc/01_Requirements/要件定義書.md`
- 追加要件: `/Doc/01_Requirements/Draft/画面構成設計_追加要件.md`
- 01_認証・ユーザー管理画面設計.md
- 02_プロジェクト・ドメイン管理画面設計.md

**次回作業**:
- データベース設計書の作成
- API設計書の作成
- システム設計書との整合性確認
- 技術PoC（F# + EF Core + Blazor Server）の実施