# プロジェクト管理機能 権限制御テストマトリックス

**作成日**: 2025-09-25
**目的**: Phase B1実装における権限制御の完全テスト設計
**対象**: プロジェクト管理機能（作成・編集・削除・参照）

## 📋 権限マトリックス表

### 4ロール × 4機能 = 16パターンテストケース

| ユーザーロール | プロジェクト作成 | プロジェクト編集 | プロジェクト削除 | プロジェクト参照 |
|---------------|----------------|----------------|----------------|----------------|
| **SuperUser** | ✅ 許可 | ✅ 全プロジェクト | ✅ 全プロジェクト | ✅ 全プロジェクト |
| **ProjectManager** | ❌ 禁止 | ✅ 担当プロジェクトのみ | ❌ 禁止 | ✅ 担当プロジェクトのみ |
| **DomainApprover** | ❌ 禁止 | ❌ 禁止 | ❌ 禁止 | ✅ 所属プロジェクトのみ |
| **GeneralUser** | ❌ 禁止 | ❌ 禁止 | ❌ 禁止 | ✅ 所属プロジェクトのみ |

## 🧪 詳細テストケース仕様

### 1. SuperUser権限テスト（4ケース）

#### TC-SU-01: プロジェクト作成
- **期待結果**: 成功
- **検証項目**: プロジェクト作成フォーム表示・実行成功
- **データ**: 新規プロジェクト「テストプロジェクトA」作成

#### TC-SU-02: プロジェクト編集
- **期待結果**: 全プロジェクト編集可能
- **検証項目**: 他ユーザー作成プロジェクトも編集可能
- **データ**: プロジェクト説明変更

#### TC-SU-03: プロジェクト削除
- **期待結果**: 全プロジェクト削除可能
- **検証項目**: 削除確認ダイアログ→論理削除実行
- **データ**: テスト用プロジェクト削除

#### TC-SU-04: プロジェクト参照
- **期待結果**: 全プロジェクト一覧表示
- **検証項目**: システム内全プロジェクト表示確認

### 2. ProjectManager権限テスト（4ケース）

#### TC-PM-01: プロジェクト作成
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: 作成ボタン非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-PM-02: プロジェクト編集
- **期待結果**: 担当プロジェクトのみ成功
- **検証項目**: 担当プロジェクト○・他プロジェクト×
- **データ**: 担当プロジェクト編集成功・他プロジェクト403エラー

#### TC-PM-03: プロジェクト削除
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: 削除ボタン非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-PM-04: プロジェクト参照
- **期待結果**: 担当プロジェクトのみ表示
- **検証項目**: 一覧画面で担当プロジェクトのみ表示
- **データ**: フィルタリング動作確認

### 3. DomainApprover権限テスト（4ケース）

#### TC-DA-01: プロジェクト作成
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: メニュー項目非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-DA-02: プロジェクト編集
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: 編集ボタン非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-DA-03: プロジェクト削除
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: 削除ボタン非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-DA-04: プロジェクト参照
- **期待結果**: 所属プロジェクトのみ表示
- **検証項目**: 一覧画面で所属プロジェクトのみ表示
- **データ**: 所属外プロジェクト非表示確認

### 4. GeneralUser権限テスト（4ケース）

#### TC-GU-01: プロジェクト作成
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: メニュー項目非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-GU-02: プロジェクト編集
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: 編集ボタン非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-GU-03: プロジェクト削除
- **期待結果**: 禁止（403 Forbidden）
- **検証項目**: 削除ボタン非表示・直接アクセス拒否
- **エラーメッセージ**: 「権限がありません。」

#### TC-GU-04: プロジェクト参照
- **期待結果**: 所属プロジェクトのみ表示
- **検証項目**: 一覧画面で所属プロジェクトのみ表示
- **データ**: 所属外プロジェクト非表示確認

## 🎭 境界値テストケース

### エッジケース追加テスト

#### TC-EDGE-01: 複数プロジェクト担当ProjectManager
- **シナリオ**: ProjectManagerが3つのプロジェクトを担当
- **期待結果**: 担当3プロジェクト全てで編集可能・他プロジェクト不可

#### TC-EDGE-02: プロジェクト削除済み後のアクセス
- **シナリオ**: 削除済みプロジェクトへのアクセス試行
- **期待結果**: 404 Not Found または権限エラー

#### TC-EDGE-03: ユーザーロール変更後の権限確認
- **シナリオ**: GeneralUser→ProjectManagerへロール変更
- **期待結果**: セッション更新後に新権限が適用

#### TC-EDGE-04: 未所属ユーザーのプロジェクトアクセス
- **シナリオ**: どのプロジェクトにも所属していないユーザー
- **期待結果**: プロジェクト一覧は空表示・作成ボタン非表示

## 🔧 テスト実装指針

### 統合テストでの実装パターン
```csharp
[Theory]
[InlineData("SuperUser", "Create", true)]
[InlineData("ProjectManager", "Create", false)]
[InlineData("DomainApprover", "Create", false)]
[InlineData("GeneralUser", "Create", false)]
public async Task ProjectAccess_WithUserRole_ReturnsExpectedResult(
    string userRole, string action, bool expectedSuccess)
{
    // Arrange: ユーザー・プロジェクトセットアップ

    // Act: 権限制御アクション実行

    // Assert: 期待結果確認
}
```

### UI要素表示制御テスト
```csharp
[Fact]
public async Task ProjectListPage_AsGeneralUser_HidesManagementButtons()
{
    // Arrange: GeneralUserでログイン

    // Act: プロジェクト一覧画面表示

    // Assert: 作成・編集・削除ボタンが非表示
}
```

## 📊 テスト実行チェックリスト

### 実行前準備
- [ ] テストユーザー4種類作成（各ロール1名ずつ）
- [ ] テストプロジェクト3個作成
- [ ] プロジェクト所属・担当関係設定

### テスト実行
- [ ] 16個の基本テストケース実行
- [ ] 4個のエッジケーステスト実行
- [ ] UI表示制御確認（各ロール）
- [ ] エラーメッセージ内容確認

### 実行後確認
- [ ] 全テストケース PASS確認
- [ ] ログ出力内容確認（権限エラーログ）
- [ ] データ整合性確認（不正データ作成なし）

---

**関連仕様**:
- `/Doc/01_Requirements/機能仕様書.md` 3章: プロジェクト・ドメイン管理機能
- `/Doc/01_Requirements/機能仕様書.md` 10章: セキュリティ・権限制御

**実装時参照**:
- Phase B1実装時に本マトリックスに基づく統合テスト作成
- UI権限制御コンポーネント設計時の仕様確認