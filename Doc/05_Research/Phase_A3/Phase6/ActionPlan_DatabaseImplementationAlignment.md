# データベース設計・実装整合性修正 対応方針

**対応対象**: Phase A1～A3 データベース設計書との完全整合化  
**作成日**: 2025-07-28  
**対応方針**: ADR_013準拠による組織的対応  
**緊急度**: 🚨 Critical（Phase継続の前提条件）  

## 🎯 対応方針概要

### 基本方針
1. **データベース設計書を絶対的真実とする**
2. **ADR_013組織管理サイクル運用規則に準拠**
3. **テストファースト開発（TDD）の厳格な適用**
4. **仕様準拠マトリックスによる品質保証**

### 対応Phase分類
**複雑Phase適用**: 技術領域横断・依存関係多数・品質影響大

## 📋 Step6組織設計（6専門役割並列分析）

### 1. データベーススキーマ専門家
**🎯 責務**: データベース設計書との完全整合化分析
```
- AspNetUsersテーブル列定義詳細分析・修正計画
- マイグレーション vs init/スキーマ不整合解決策
- PostgreSQL固有機能・制約整合性確認
- データ移行リスク・手順分析
```

### 2. エンティティ・ORM専門家  
**🎯 責務**: ApplicationUser・DbContext整合性修正
```
- ApplicationUserプロパティ詳細修正計画
- EF Core設定・アノテーション整合性修正
- F#↔C#境界エンティティマッピング確認
- Clean Architecture Entity設計原則準拠確認
```

### 3. テスト戦略・TDD専門家
**🎯 責務**: テスト修正戦略・TDD実践計画
```
- 破綻テスト特定・修正優先度策定
- Red-Green-Refactorサイクル詳細計画
- テストカバレッジ80%維持戦略
- 統合テスト・品質保証計画
```

### 4. Phase A3機能実装専門家
**🎯 責務**: 認証拡張機能完全実装
```
- パスワードリセット機能実装計画（DB列追加後）
- Remember Me機能実装状況確認・完成計画
- メール送信機能（smtp4dev連携）完全実装
- ASP.NET Core Identity拡張機能統合
```

### 5. Clean Architecture・F#↔C#境界専門家
**🎯 責務**: アーキテクチャ整合性・型変換確認
```
- Contracts層実装状況詳細確認
- F# Domain/Application層実装確認
- 型変換ロジック実装・動作確認
- 依存関係逆転原則準拠確認
```

### 6. 仕様準拠・品質保証専門家
**🎯 責務**: 仕様準拠確認・品質保証戦略
```
- 仕様準拠マトリックス作成（肯定的・否定的仕様）
- データベース設計書100%準拠確認
- Phase A1-A3機能仕様完全準拠確認
- 品質保証チェックリスト策定・継続監視
```

## 🔄 Step実行計画（3-4セッション想定）

### Session 1: Step1 並列分析・統合計画
**目的**: 6専門役割による徹底的問題分析・統合解決策策定
```
1. 並列分析実行（各専門役割30分）
2. 分析結果統合・優先順位付け（30分）
3. 詳細実装計画策定・依存関係整理（60分）
4. 仕様準拠マトリックス作成（30分）
5. TDD実践詳細計画確定（30分）
```

### Session 2: Step2 データベース・エンティティ修正
**目的**: 最優先の基盤修正（マイグレーション・エンティティ）
```
1. マイグレーション削除・init/スキーマ適用
2. ApplicationUser修正（TDD適用）
3. DbContext設定修正（TDD適用） 
4. 基盤テスト修正・成功確認
5. 中間品質確認
```

### Session 3: Step3 Phase A3機能実装・テスト完成
**目的**: 認証拡張機能の完全実装
```
1. パスワードリセット機能実装（TDD適用）
2. Remember Me機能確認・実装（TDD適用）
3. メール送信機能実装（TDD適用）
4. F#↔C#境界確認・修正
5. 統合テスト実行・品質保証
```

### Session 4: Step4 最終品質保証・完了確認
**目的**: 仕様準拠100%・品質基準達成確認
```
1. 仕様準拠マトリックス100%達成確認
2. テストカバレッジ80%以上確認
3. Clean Architecture準拠100%確認
4. 技術負債記録・管理完了
5. Phase A3完全完了宣言
```

## 📊 TDD実践詳細戦略

### Red-Green-Refactorサイクル適用箇所

#### 1. ApplicationUser修正
```
Red: 新しいプロパティ要求テスト作成・失敗確認
Green: PasswordResetToken/PasswordResetExpiry追加・テスト成功
Refactor: 不要プロパティ削除・テスト継続成功
```

#### 2. パスワードリセット機能
```
Red: パスワードリセット要求テスト作成・失敗確認
Green: 最小限サービス実装・テスト成功
Refactor: セキュリティ・エラーハンドリング強化
```

#### 3. メール送信機能
```
Red: メール送信要求テスト作成・失敗確認
Green: smtp4dev連携実装・テスト成功
Refactor: テンプレート・履歴管理機能追加
```

## 🎯 仕様準拠マトリックス

### データベース設計書準拠項目
```
□ AspNetUsersテーブル列定義100%一致
□ PasswordResetToken列の正しい実装
□ PasswordResetExpiry列の正しい実装  
□ 余計な列（CreatedAt等）の完全削除
□ マイグレーション vs init/スキーマ完全一致
```

### 機能仕様書準拠項目（Phase A3）
```
□ パスワードリセット機能100%実装
□ Remember Me機能100%実装
□ メール送信機能100%実装
□ セキュリティ要件100%準拠
□ UI/UX仕様100%準拠
```

### Clean Architecture準拠項目
```
□ Domain層の純粋性維持
□ Application層のユースケース実装
□ Infrastructure層の技術実装分離
□ F#↔C#境界の正しい実装
□ 依存関係逆転原則100%準拠
```

## 🚨 リスク管理・緊急時対応

### データベースリスク
**リスク**: 既存データ消失・マイグレーション失敗
**対策**: バックアップ作成・段階的適用・ロールバック手順確立

### テスト破綻リスク  
**リスク**: ApplicationUser変更による大量テスト破綻
**対策**: TDD適用・段階的修正・継続的テスト実行

### 実装遅延リスク
**リスク**: Phase A3機能実装の複雑性による遅延
**対策**: 優先度明確化・MVP実装・段階的機能追加

## ✅ 完了判定基準

### 技術的完了基準
1. ✅ データベーススキーマ設計書100%一致
2. ✅ ApplicationUser定義設計書100%一致  
3. ✅ Phase A3全機能100%実装・動作確認
4. ✅ 全テスト成功・カバレッジ80%以上
5. ✅ F#↔C#境界100%動作確認

### 品質完了基準
1. ✅ 仕様準拠マトリックス100%達成
2. ✅ Clean Architecture原則100%準拠
3. ✅ 技術負債適切記録・管理完了
4. ✅ セキュリティ要件100%準拠
5. ✅ 継続的監視体制確立

## 📚 実行時参照ドキュメント

### 必須参照（絶対的真実）
- `/Doc/02_Design/データベース設計書.md` - データベース設計絶対基準
- `/Doc/01_Requirements/機能仕様書.md` - Phase A3機能要件
- `/init/01_create_schema.sql` - 正しいスキーマ定義

### 実装参照
- `/Doc/02_Design/システム設計書.md` - Clean Architecture詳細
- `/Doc/02_Design/Application層インターフェース設計書.md` - F#↔C#境界
- `/Doc/07_Decisions/ADR_013_組織管理サイクル運用規則.md` - 組織運用規則

### 品質保証参照
- `/Doc/08_Organization/Rules/組織管理運用マニュアル.md` - Step実行手順
- `/Doc/08_Organization/Rules/テスト戦略ガイド.md` - TDD詳細実践