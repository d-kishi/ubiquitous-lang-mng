# ユビキタス言語管理システム 機能仕様書

**プロジェクト名**: ユビキタス言語管理システム  
**バージョン**: 1.0  
**作成日**: 2025-06-28  
**最終更新**: 2025-06-28  
**承認者**: プロジェクトオーナー  

## 目次

1. [システム概要・機能概要](#1-システム概要機能概要)
2. [ユーザー管理・認証機能](#2-ユーザー管理認証機能)
3. [プロジェクト・ドメイン管理機能](#3-プロジェクトドメイン管理機能)
4. [ユビキタス言語管理機能](#4-ユビキタス言語管理機能)
5. [承認ワークフロー機能](#5-承認ワークフロー機能)
6. [外部連携・エクスポート機能](#6-外部連携エクスポート機能)
7. [データ整合性・バリデーション](#7-データ整合性バリデーション)
8. [通知・メッセージ機能](#8-通知メッセージ機能)
9. [検索・ソート・フィルタ機能](#9-検索ソートフィルタ機能)
10. [セキュリティ・権限制御](#10-セキュリティ権限制御)

---

## 1. システム概要・機能概要

### 1.1 システムの目的

ドメイン駆動設計（DDD）におけるユビキタス言語の管理を効率化するWebアプリケーション。用語の一元管理、承認ワークフローによる品質担保、外部ツール連携による効率化を実現する。

### 1.2 主要機能概要

#### 基本機能群
- **用語管理**: ドラフト用語の作成・編集、承認申請、正式用語化
- **プロジェクト・ドメイン管理**: 階層構造での用語分類管理
- **ユーザー・権限管理**: 4段階の階層的権限管理（スーパーユーザー、プロジェクト管理者、ドメイン承認者、一般ユーザー）
- **承認ワークフロー**: ドラフト → 承認申請 → 承認・却下 → 正式版作成
- **外部連携**: Claude Code向けMarkdown出力、CSV出力

#### データ階層構造
```
プロジェクト（最上位）
├── ドメイン領域A（承認者設定）
│   ├── ドラフト用語（一時データ）
│   ├── 承認申請用語（承認待ち）
│   └── 正式用語（確定データ）
└── ドメイン領域B
    └── 正式用語
```

### 1.3 対象ユーザー・権限体系

#### ユーザーロール
1. **スーパーユーザー**: システム全体の管理者
2. **プロジェクト管理者**: プロジェクト単位の管理者
3. **ドメイン承認者**: 特定ドメインの承認権限者
4. **一般ユーザー**: 用語の作成・編集を行う開発者・ビジネス関係者

#### 権限階層
- 上位ユーザーは下位ユーザーの権限を包含
- 権限設定は階層的に管理（上位者が下位者を管理）
- 多対多関係：1ユーザーが複数プロジェクト・複数ドメインを担当可能

---

## 2. ユーザー管理・認証機能

### 2.0 初期データ管理

#### 2.0.1 初期スーパーユーザー登録
**概要**: システム初期化時の管理者ユーザー自動登録

**データ取得方法**:
- メールアドレス：アプリケーション設定ファイルから読み込み
- 氏名：アプリケーション設定ファイルから読み込み
- 初期パスワード：固定値 "su"

**登録処理**:
- システム初期化時に自動実行
- 既存データが存在する場合は登録をスキップ
- ユーザーロール：スーパーユーザー
- 所属プロジェクト：初期登録時は未設定

**セキュリティ要件**:
- 初回ログイン時のパスワード変更必須（他のユーザーと同様）
- 設定ファイルのアクセス権限制御必須

### 2.1 認証機能

#### 2.1.1 ログイン機能
**概要**: メールアドレス・パスワードによる独自認証

**入力項目**:
- メールアドレス（ログインID）
- パスワード
- ログイン状態保持チェックボックス

**処理フロー**:
1. ユーザーがメールアドレス・パスワードを入力
2. システムがユーザー情報を認証
3. 認証成功時：ユビキタス言語一覧画面（ホーム）に遷移
4. 認証失敗時：エラーメッセージ表示

**ビジネスルール**:
- ログイン失敗によるロックアウト機構は設けない
- 自動ログイン機能あり（チェックボックス選択時）
- セッション管理：業務時間内での利用を想定

#### 2.1.2 パスワード変更機能
**概要**: ログインユーザー自身のパスワード変更

**入力項目**:
- 現在のパスワード
- 新しいパスワード
- 新しいパスワード（確認）

**処理フロー**:
1. 現在のパスワード認証
2. 新しいパスワードのバリデーション
3. パスワード更新・成功メッセージ表示

**ビジネスルール**:
- 初回ログイン時はパスワード変更必須（全ユーザー共通）
- パスワード要件：8文字以上、英数字混在推奨

#### 2.1.3 パスワードリセット機能
**概要**: パスワード失念時のリセット機能

**処理フロー**:
1. **リセット申請**:
   - ログイン画面から「パスワードリセット」リンクをクリック
   - メールアドレス入力
   - 未登録メールアドレス時はエラー表示

2. **リセット実行**:
   - メール受信後、リンクからリセット画面に遷移
   - 新しいパスワード入力
   - パスワード更新完了後、ログイン画面に遷移

**ビジネスルール**:
- リセットリンク有効期限：24時間（設定変更可能）
- リセット後は自動でログイン画面に遷移

### 2.2 ユーザー管理機能

#### 2.2.1 ユーザー登録機能
**概要**: 新規ユーザーの登録

**登録権限**:
- **スーパーユーザー**: 全ロールのユーザーを登録可能
- **プロジェクト管理者**: 担当プロジェクトの承認者・一般ユーザーを登録可能

**入力項目**:
- メールアドレス（ログインID、必須）
- 初期パスワード（必須）
- 氏名（必須）
- 所属プロジェクト（必須、複数選択可能）
- ユーザーロール（必須）

**処理フロー**:
1. 登録権限チェック
2. 入力内容バリデーション
3. メールアドレス重複チェック
4. ユーザー情報登録
5. 成功メッセージ表示・ユーザー一覧に戻る

**ビジネスルール**:
- メールアドレスはシステム内で一意
- 初期パスワードは平文で設定（初回ログイン時変更必須）
- 所属プロジェクトは登録者の権限範囲内で選択

#### 2.2.2 ユーザー編集機能
**概要**: 既存ユーザー情報の編集

**編集権限**:
- **スーパーユーザー**: 全ユーザーの編集可能
- **プロジェクト管理者**: 担当プロジェクト内ユーザーの編集可能
- **本人**: 自身のプロフィール情報のみ編集可能

**編集可能項目**:
- 氏名
- 所属プロジェクト（権限に応じて）
- ユーザーロール（権限に応じて）
- パスワードリセット実行

**処理フロー**:
1. 編集権限チェック
2. 編集内容バリデーション
3. ユーザー情報更新
4. 成功メッセージ表示

**ビジネスルール**:
- メールアドレス変更不可（システム内一意性維持）
- 自分自身のロール変更不可（権限昇格防止）

#### 2.2.3 ユーザー削除機能
**概要**: ユーザーの論理削除

**削除権限**:
- **スーパーユーザー**: 全ユーザーの削除可能
- **プロジェクト管理者**: 担当プロジェクト内ユーザーの削除可能

**処理フロー**:
1. 削除権限チェック
2. 関連データ存在チェック（作成・更新したユビキタス言語）
3. 削除確認ダイアログ表示
4. 論理削除実行（deleted_at フィールドに削除日時設定）
5. 成功メッセージ表示

**ビジネルール**:
- 論理削除（物理削除なし）
- 削除済みユーザーによる作成・更新データは保持
- 削除済みユーザー表示切り替え機能あり

---

## 3. プロジェクト・ドメイン管理機能

### 3.1 プロジェクト管理機能

#### 3.1.1 プロジェクト一覧機能
**概要**: システム管理対象プロジェクトの一覧表示・管理

**表示権限**:
- **スーパーユーザー**: 全プロジェクト表示
- **プロジェクト管理者**: 担当プロジェクトのみ表示

**表示項目**:
- プロジェクト名
- プロジェクト説明
- プロジェクト管理者名
- 作成日時
- 最終更新日時
- 所属ユーザー数
- ドメイン数

**操作機能**:
- プロジェクト登録（新規作成）
- プロジェクト編集
- プロジェクト削除（論理削除）
- 削除済みプロジェクト表示切り替え

#### 3.1.2 プロジェクト登録機能
**概要**: 新規プロジェクトの作成

**登録権限**:
- **スーパーユーザーのみ**

**入力項目**:
- プロジェクト名（必須、最大50文字）
- プロジェクト説明（任意、最大200文字）

**処理フロー**:
1. 登録権限チェック
2. 入力内容バリデーション
3. プロジェクト名重複チェック
4. プロジェクト情報登録
5. 成功メッセージ表示・プロジェクト一覧に戻る

**ビジネスルール**:
- プロジェクト名はシステム内で一意
- プロジェクト管理者はユーザー登録時にロール・所属プロジェクト指定で設定
- 登録時に自動でデフォルトドメイン作成（「共通」ドメイン）

**デフォルトドメイン自動作成仕様**:
- **原子性保証**: プロジェクト作成とデフォルトドメイン「共通」作成は同一トランザクション内で実行
- **F# ドメインサービス設計**: ProjectDomainService にて実装
- **失敗時ロールバック**: プロジェクト作成またはデフォルトドメイン作成失敗時は全処理をロールバック
- **実装パターン**: Railway-oriented Programming を適用したResult型による成功・失敗の制御

**実装例**:
```fsharp
module ProjectDomainService =
    let createProjectWithDefaultDomain (command: CreateProjectCommand) =
        result {
            let! project = Project.create command.Name command.Description
            let! defaultDomain = Domain.createDefault project.Id "共通" "プロジェクトの共通ドメイン"
            return ProjectCreated.create project defaultDomain
        }
```

#### 3.1.3 プロジェクト編集機能
**概要**: 既存プロジェクト情報の編集

**編集権限**:
- **スーパーユーザー**: 全プロジェクトの編集可能
- **プロジェクト管理者**: 担当プロジェクトの編集可能

**編集可能項目**:
- プロジェクト説明

**処理フロー**:
1. 編集権限チェック
2. 編集内容バリデーション
3. プロジェクト情報更新
4. 成功メッセージ表示

**ビジネスルール**:
- プロジェクト名変更不可（一意性・整合性維持）
- プロジェクト管理者の変更はユーザー編集画面で実施

#### 3.1.4 プロジェクト削除機能
**概要**: プロジェクトの論理削除

**削除権限**:
- **スーパーユーザーのみ**

**処理フロー**:
1. 削除権限チェック
2. 関連データ存在チェック（ドメイン、ユビキタス言語）
3. 削除確認ダイアログ表示（関連データ数表示）
4. 論理削除実行
5. 成功メッセージ表示

**ビジネスルール**:
- 論理削除（関連データは保持）
- 削除済みプロジェクトのデータは非表示
- 削除済みプロジェクト表示切り替え機能あり

### 3.2 ドメイン管理機能

#### 3.2.1 ドメイン一覧機能
**概要**: プロジェクト内ドメイン領域の一覧表示・管理

**表示権限**:
- **スーパーユーザー**: 全プロジェクトのドメイン表示
- **プロジェクト管理者**: 担当プロジェクトのドメインのみ表示

**表示項目**:
- プロジェクト名
- ドメイン名
- ドメイン説明
- 承認者名（複数表示）
- 用語数（ドラフト・承認済み別）
- 作成日時
- 最終更新日時

**フィルタ機能**:
- プロジェクト選択（必須）
- 削除済みドメイン表示切り替え

#### 3.2.2 ドメイン登録機能
**概要**: プロジェクト内への新規ドメイン作成

**登録権限**:
- **スーパーユーザー**: 全プロジェクトにドメイン作成可能
- **プロジェクト管理者**: 担当プロジェクトにドメイン作成可能

**入力項目**:
- 所属プロジェクト（必須）
- ドメイン名（必須、最大30文字）
- ドメイン説明（任意、最大200文字）
- 承認者（必須、複数選択可能）

**処理フロー**:
1. 登録権限チェック
2. 入力内容バリデーション
3. ドメイン名重複チェック（同一プロジェクト内）
4. ドメイン情報登録
5. 成功メッセージ表示・ドメイン一覧に戻る

**ビジネスルール**:
- ドメイン名は同一プロジェクト内で一意
- 最低1名の承認者設定必須
- 承認者は同一プロジェクト内のユーザーから選択

#### 3.2.3 ドメイン編集機能
**概要**: 既存ドメイン情報の編集

**編集権限**:
- **スーパーユーザー**: 全ドメインの編集可能
- **プロジェクト管理者**: 担当プロジェクト内ドメインの編集可能

**編集可能項目**:
- ドメイン説明
- 承認者（追加・削除）

**処理フロー**:
1. 編集権限チェック
2. 編集内容バリデーション
3. ドメイン情報更新
4. 成功メッセージ表示

**ビジネスルール**:
- ドメイン名・所属プロジェクト変更不可
- 最低1名の承認者必須
- 承認者変更時は承認待ちデータの承認権限も自動調整

#### 3.2.4 ドメイン削除機能
**概要**: ドメインの論理削除

**削除権限**:
- **スーパーユーザー**: 全ドメインの削除可能
- **プロジェクト管理者**: 担当プロジェクト内ドメインの削除可能

**処理フロー**:
1. 削除権限チェック
2. 関連データ存在チェック（ユビキタス言語）
3. 削除確認ダイアログ表示（関連データ数表示）
4. 論理削除実行
5. 成功メッセージ表示

**ビジネスルール**:
- 論理削除（関連データは保持）
- 削除済みドメインのデータは非表示
- プロジェクトのデフォルトドメイン（「共通」）は削除不可

### 3.3 禁止事項（否定的仕様）

#### 3.3.1 プロジェクト管理における禁止事項

**プロジェクト名変更禁止**:
- 登録済みプロジェクトの名前変更は一切禁止
- 理由：システム内一意性・データ整合性維持のため
- エラーメッセージ：「プロジェクト名は変更できません。」

**参照中プロジェクト削除禁止**:
- 関連データ（ドメイン・ユビキタス言語）が存在するプロジェクトの削除禁止
- 削除前に関連データ削除または他プロジェクトへ移行必須
- エラーメッセージ：「関連するデータが存在するため削除できません。先に関連データを削除してください。」

**空文字・空白プロジェクト名禁止**:
- 空文字列・空白文字のみのプロジェクト名登録禁止
- 半角・全角スペースのみの名前も禁止
- エラーメッセージ：「プロジェクト名は必須です。」

**デフォルトドメイン削除禁止**:
- プロジェクト作成時に自動作成される「共通」ドメインの削除禁止
- システムが自動作成する基本ドメインの保護
- エラーメッセージ：「デフォルトドメイン『共通』は削除できません。」

**権限外プロジェクト操作禁止**:
- 担当外・所属外プロジェクトへの編集・削除操作禁止
- ユーザーロールに応じた権限制御の厳格適用
- エラーメッセージ：「このプロジェクトを操作する権限がありません。」

#### 3.3.2 ドメイン管理における禁止事項

**ドメイン名変更禁止**:
- 登録済みドメインの名前変更は禁止
- 理由：ユビキタス言語データとの整合性維持
- エラーメッセージ：「ドメイン名は変更できません。」

**参照中ドメイン削除禁止**:
- ユビキタス言語が存在するドメインの削除禁止
- 削除前に関連ユビキタス言語の削除または他ドメインへ移行必須
- エラーメッセージ：「関連するユビキタス言語が存在するため削除できません。」

**承認者なしドメイン作成禁止**:
- 承認者が設定されていないドメインの作成・保存禁止
- 最低1名の承認者設定必須
- エラーメッセージ：「承認者を1名以上設定してください。」

#### 3.3.3 セキュリティ関連禁止事項

**SQLインジェクション攻撃禁止**:
- プロジェクト名・説明・ドメイン名でのSQLクエリ実行文字列入力禁止
- 危険な文字列パターンの自動検出・ブロック
- エラーメッセージ：「不正な文字が含まれています。」

**XSS攻撃文字列禁止**:
- JavaScript実行コード・HTMLタグの入力禁止
- 自動エスケープ処理・サニタイゼーション適用
- エラーメッセージ：「HTMLタグまたはスクリプトは入力できません。」

**パス・ディレクトリ指定禁止**:
- ファイルパス・ディレクトリ参照文字列（../等）の入力禁止
- ディレクトリトラバーサル攻撃防止
- エラーメッセージ：「パス指定文字は使用できません。」

---

## 4. ユビキタス言語管理機能

### 4.1 ユビキタス言語一覧機能（ホーム画面）

#### 4.1.1 概要・画面構成
**概要**: 承認済みユビキタス言語の一覧表示・検索・参照機能

**画面特性**:
- システムのホーム画面（ログイン直後の表示画面）
- 検索・ソート・表示機能のみ（編集・削除は一切不可）
- 承認済みデータのみ表示（ドラフト・承認待ちは非表示）

**表示権限・データ範囲**:
- **スーパーユーザー**: 全プロジェクトのユビキタス言語を表示可能
- **プロジェクト管理者**: 担当プロジェクトのユビキタス言語のみ表示可能
- **ドメイン承認者・一般ユーザー**: 所属プロジェクトのユビキタス言語のみ表示可能

#### 4.1.2 表示項目・一覧仕様
**基本表示項目**:
- 和名
- 英名
- 意味
- 発生機会

**詳細表示機能**:
- 一覧上の各データクリックでポップアップ画面表示
- ポップアップ内容：関連用語、備考、変更履歴等の全データ

**ページング仕様**:
- 従来型ページャ使用
- 表示件数選択：50件/100件/200件
- ページ番号による直接遷移

#### 4.1.3 検索・フィルタ機能
**必須条件**:
- プロジェクト選択（ドロップダウンリスト）

**任意条件**:
- ドメイン（「すべてのドメイン」選択肢を含むドロップダウンリスト）
- 和名（部分一致検索）
- 英名（部分一致検索）
- 発生機会（部分一致検索）

**検索実行**:
- 条件変更時の自動検索
- 検索条件クリア機能

### 4.2 ユビキタス言語入力・編集機能

#### 4.2.1 概要・画面構成
**概要**: ドラフト用語の一覧形式での新規登録・編集・申請・削除機能

**画面特性**:
- Excel風テーブル型インライン編集
- 新規登録・編集・承認申請・削除を同一画面で実行
- ドラフトデータ・承認申請データ・承認済みデータを状態別表示

**表示権限・データ範囲**:
- **スーパーユーザー**: 全プロジェクトのデータ表示・編集可能
- **プロジェクト管理者**: 担当プロジェクトのデータ表示・編集可能
- **ドメイン承認者・一般ユーザー**: 所属プロジェクトのデータ表示・編集可能

#### 4.2.2 データ表示・状態管理
**表示データ状態**:
- **ドラフト**: 編集中の一時データ
- **承認申請**: 承認待ち状態
- **承認済み**: 確定済みデータ（編集不可、参照のみ）

**状態別操作可能性**:
```
ドラフト: 編集○ 承認申請○ 削除○
承認申請: 編集× 承認申請取消× 削除×
承認済み: 編集× 承認申請× 削除○（ドメイン承認者以上）
```

#### 4.2.3 編集機能・保存仕様
**インライン編集仕様**:
- セル単位での直接編集
- 行単位での自動保存（行からフォーカスが外れた際）
- 編集中行のハイライト表示

**承認済みデータの編集**:
- 承認済みデータを編集した場合、フォーカスアウト時に新規ドラフトデータを作成
- 元の承認済みデータは変更せず保持
- GitFlowのフォーク→プルリクエストと同様のワークフロー
- 作成されたドラフトデータは通常の承認フローで処理

**入力項目・必須性**:
```
必須項目（ドラフト保存時）:
- 和名

必須項目（承認申請時）:
- 和名
- 英名  
- 意味
- ドメイン領域

任意項目:
- 発生機会
- 関連用語
- 備考
```

**保存処理フロー**:
1. 行からフォーカスアウト時に自動保存実行
2. 楽観ロック（RowVersion）による競合チェック
3. 競合検知時：「他のユーザーが同時編集中です。画面を更新してください。」表示
4. 保存成功時：無音での保存完了（UI更新のみ）

#### 4.2.4 新規登録機能
**新規行追加**:
- 「新規追加」ボタンで空行をテーブル最上部に追加
- 初期状態：ドラフト状態、最低限必須項目のみ入力可能

**処理フロー**:
1. 新規行追加ボタンクリック
2. 空行生成・フォーカス設定
3. 必要項目入力
4. 行フォーカスアウト時に自動保存

#### 4.2.5 承認申請機能
**申請実行**:
- 行単位での「承認申請」ボタン
- 複数行選択での一括承認申請

**申請時バリデーション**:
- 全必須項目入力チェック
- ドメイン内和名重複チェック（承認済みデータとの重複のみ）
- バリデーション失敗時は申請実行不可

**処理フロー**:
1. 承認申請ボタンクリック
2. 必須項目・重複チェック実行
3. バリデーション成功時：状態を「承認申請」に更新
4. 担当ドメイン承認者にリアルタイム通知（トースター表示）

#### 4.2.6 削除機能
**削除権限・対象**:
- **ドラフトデータ**: 全ユーザーが削除可能（物理削除）
- **承認済みデータ**: ドメイン承認者以上が削除可能（論理削除）
- **承認申請データ**: 削除不可

**処理フロー**:
1. 削除ボタンクリック
2. 削除確認ダイアログ表示
3. 確認後、対象データの削除実行
4. 成功メッセージ表示

### 4.3 データ構造・エンティティ仕様

#### 4.3.1 ドラフト用語エンティティ
**基本項目**:
- ID（システム生成）
- 和名（必須、最大30文字）
- 英名（任意、最大50文字、半角英数・ハイフン・アンダースコアのみ）
- 意味・説明（任意、最大200文字、改行可能）
- ドメイン領域（必須、ドメインID参照）
- 発生機会（任意、最大50文字、改行不可）
- 関連用語（任意、複数選択、和名での関連付け）
- 備考（任意、最大200文字、改行可能）

**システム項目**:
- 状態（ドラフト/承認申請）
- 最終更新者ID  
- 最終更新日時
- RowVersion（競合制御用）

#### 4.3.2 正式用語エンティティ
**基本項目**:
- ID（システム生成）
- 和名（必須、最大30文字）
- 英名（必須、最大50文字）
- 意味・説明（必須、最大200文字、改行可能）
- ドメイン領域（必須、ドメインID参照）
- 発生機会（任意、最大50文字、改行不可）
- 関連用語（任意、複数選択、和名での関連付け）
- 備考（任意、最大200文字、改行可能）

**システム項目**:
- 最終更新者ID
- 最終更新日時
- 承認者ID
- 承認日時
- RowVersion（競合制御用）
- 削除フラグ（論理削除用）
- 削除者ID
- 削除日時

---

## 5. 承認ワークフロー機能

### 5.1 承認機能概要

#### 5.1.1 承認フロー
**基本フロー**:
```
ドラフト作成 → 承認申請 → 承認待ち → 承認・却下判定 → 正式版作成 or 却下処理
```

**状態遷移**:
```
新規: ドラフト → 清書（必須項目入力）→ 承認申請 → 承認 → 正式版作成
編集: 正式版 → ドラフト作成（編集用）→ 清書 → 承認申請 → 承認 → 正式版更新
```

#### 5.1.2 承認権限体系
**承認可能ユーザー**:
- **ドメイン承認者**: 担当ドメインの承認申請のみ承認可能
- **プロジェクト管理者**: 担当プロジェクト内全ドメインの承認申請を承認可能  
- **スーパーユーザー**: 全プロジェクト・全ドメインの承認申請を承認可能

### 5.2 ユビキタス言語承認画面

#### 5.2.1 画面概要・表示データ
**概要**: 承認待ち状態のユビキタス言語に対する承認・却下操作

**表示データ対象**:
- 承認申請状態のデータのみ表示
- 承認者の権限に応じたデータフィルタリング

**表示項目**:
- 和名
- 英名
- 意味
- 発生機会
- 関連用語
- 備考
- 却下理由（却下時のみ）
- 申請者氏名
- 申請日時

#### 5.2.2 フィルタ・ソート機能
**フィルタ機能**:
- プロジェクト（権限に応じた選択肢）
- ドメイン（選択したプロジェクト内ドメイン）
- 和名（部分一致検索）
- 意味（部分一致検索）

**ソート機能**:
- 和名（昇順・降順）
- 英名（昇順・降順）
- 発生機会（昇順・降順）
- 申請者氏名（昇順・降順）
- 申請日時（昇順・降順、画面初期表示時の既定値は降順）

#### 5.2.3 承認操作
**承認実行方法**:
- **単一承認**: 行単位での「承認」ボタン
- **一括承認**: 複数行チェックボックス選択後の「一括承認」ボタン

**承認処理フロー**:
1. 承認ボタンクリック
2. 実行確認ダイアログ表示（「承認してよろしいですか？」）
3. 確認後、承認処理実行：
   - 正式用語エンティティに新規追加 or 既存更新
   - 変更履歴テーブルに承認内容記録
   - 承認されたドラフトデータを物理削除
4. 成功メッセージ表示

**承認時の処理詳細**:
- **新規データ**: 正式用語テーブルに新規レコード作成
- **既存データ更新**: 正式用語の該当レコードを更新（ドメイン変更不可）
- **変更履歴記録**: 承認後の全データを履歴テーブルに保存
- **関連用語更新**: 関連付けられた用語の関連用語表示名を自動更新

#### 5.2.4 却下操作
**却下実行方法**:
- **単一却下**: 行単位での「却下」ボタン
- **一括却下**: 複数行チェックボックス選択後の「一括却下」ボタン

**却下処理フロー**:
1. 却下ボタンクリック
2. 却下理由入力ダイアログ表示
3. 却下理由入力後、実行確認ダイアログ表示
4. 確認後、却下処理実行：
   - ドラフトデータの状態を「ドラフト」に戻す
   - 却下理由をドラフトデータに記録
5. 申請者にトースター通知：「{和名}の申請が却下されました。」
6. 成功メッセージ表示

### 5.3 通知機能

#### 5.3.1 承認申請時通知
**通知対象**: 対象ドメインの承認者のみ

**通知方法**: 画面右下リアルタイムトースター表示

**通知メッセージ**: 「新規承認依頼が届きました。」

**技術仕様**: SignalR によるリアルタイム通信

#### 5.3.2 却下通知
**通知対象**: 申請者のみ

**通知方法**: 画面右下トースター表示

**通知メッセージ**: 「{和名}の申請が却下されました。」

**表示タイミング**: 却下処理完了時・申請者がシステムにアクセス中の場合

#### 5.3.3 承認完了通知
**通知要否**: 不要

**理由**: 承認完了は承認済み一覧で確認可能なため

### 5.4 データ整合性・制約

#### 5.4.1 重複制約
**同一プロジェクト・ドメイン内での和名重複**:
- 承認済みデータ同士：重複禁止（完全一致検索）
- ドラフトデータ同士：重複許可
- ドラフト vs 承認済み：重複禁止（承認申請時チェック）

**英名重複**: 全ケースで許可

**プロジェクト跨ぎ重複**: 全ケースで許可

#### 5.4.2 関連用語制約
**削除済み用語への関連付け**:
- 承認済み用語削除時：関連付けを自動削除
- 削除された関連用語：表示対象から除外

#### 5.4.3 ドメイン変更制約
**承認済み用語のドメイン変更**: 変更不可

**ドメイン変更を含む更新の処理**:
- ドラフトでドメイン変更 → 承認申請 → 承認時に正式版更新
- 元の正式版レコードは変更履歴に記録後、新ドメインで更新

---

## 6. 外部連携・エクスポート機能

### 6.1 エクスポート機能概要

#### 6.1.1 出力形式・用途
**AI向けMarkdown出力**:
- 目的：Claude Code等のAIツールへの情報提供
- 形式：構造化Markdownファイル
- 出力権限：全ユーザー

**CSV出力**:
- 目的：Excel等での二次加工・分析
- 形式：UTF-8 BOM付きCSVファイル
- 出力権限：全ユーザー

#### 6.1.2 出力データ範囲
**対象データ**: 承認済みユビキタス言語のみ

**フィルタ条件**: ユビキタス言語一覧画面の検索条件を適用

### 6.2 AI向けMarkdown出力機能

#### 6.2.1 出力項目
**出力項目**:
- ドメイン名
- 和名
- 英名
- 意味・説明
- 関連用語の和名（カンマ区切り）

#### 6.2.2 ファイル形式・構造
**ファイル命名規則**:
```
全ドメイン出力: {プロジェクト名}-全ドメイン-ubiquitous-language-{YYYYMMDD}.md
特定ドメイン出力: {プロジェクト名}-{ドメイン名}-ubiquitous-language-{YYYYMMDD}.md
```

**Markdown構造例**:
```markdown
# {プロジェクト名} ユビキタス言語辞書

生成日時: 2025-06-28
出力範囲: {ドメイン名 or 全ドメイン}

## {ドメイン名}

### {和名} ({英名})
**意味**: {意味・説明}
**関連用語**: {関連用語1}, {関連用語2}

---
```

#### 6.2.3 出力処理フロー
1. ユビキタス言語一覧画面で「AI向けエクスポート」ボタンクリック
2. 現在の検索・フィルタ条件を取得
3. 対象データをMarkdown形式で生成
4. ファイル自動ダウンロード実行
5. 結果通知は不要（自動ダウンロードのみ）

### 6.3 CSV出力機能

#### 6.3.1 出力項目
**出力項目**:
- ドメイン名
- 和名
- 英名
- 意味・説明
- 関連用語の和名（カンマ区切り）
- 発生機会
- 備考
- 最終更新日時
- 最終更新者名

#### 6.3.2 ファイル形式詳細
**ファイル命名規則**:
```
全ドメイン出力: {プロジェクト名}-全ドメイン-ubiquitous-language-{YYYYMMDD}.csv
特定ドメイン出力: {プロジェクト名}-{ドメイン名}-ubiquitous-language-{YYYYMMDD}.csv
```

**CSV形式仕様**:
- 文字エンコード：UTF-8 BOM付き
- 改行コード：LF
- 区切り文字：カンマ（,）
- 文字列囲み：ダブルクォート（"）

#### 6.3.3 出力処理フロー
1. ユビキタス言語一覧画面で「CSVエクスポート」ボタンクリック
2. 現在の検索・フィルタ条件を取得
3. 対象データをCSV形式で生成
4. ファイル自動ダウンロード実行
5. 結果通知は不要（自動ダウンロードのみ）

### 6.4 出力条件・権限制御

#### 6.4.1 出力条件設定
**出力対象の決定**:
- ユビキタス言語一覧画面の検索・フィルタ条件をそのまま適用
- プロジェクト・ドメイン絞り込みに応じたファイル名生成
- 出力専用画面は設けない

#### 6.4.2 権限別出力範囲
**データアクセス権限に準拠**:
- **スーパーユーザー**: 全プロジェクト・全ドメインの出力可能
- **プロジェクト管理者**: 担当プロジェクトのデータのみ出力可能
- **ドメイン承認者・一般ユーザー**: 所属プロジェクトのデータのみ出力可能

---

## 7. データ整合性・バリデーション

### 7.1 バリデーションルール詳細

#### 7.1.1 文字制限・形式制限
**和名の制限**:
- 最大文字数：30文字
- 文字パターン：制限なし（ひらがな、カタカナ、漢字、英数字、記号すべて許可）
- 改行：禁止
- 必須性：ドラフト時任意、承認申請時必須

**英名の制限**:
- 最大文字数：50文字
- 文字パターン：半角英数字、ハイフン（-）、アンダースコア（_）のみ許可
- 先頭文字：半角英字のみ許可
- 改行：禁止
- 必須性：ドラフト時任意、承認申請時必須

**意味・説明の制限**:
- 最大文字数：200文字
- 文字パターン：制限なし
- 改行：可能
- 必須性：ドラフト時任意、承認申請時必須

**発生機会の制限**:
- 最大文字数：50文字
- 文字パターン：制限なし
- 改行：禁止
- 必須性：任意

**備考の制限**:
- 最大文字数：200文字
- 文字パターン：制限なし
- 改行：可能
- 必須性：任意

#### 7.1.2 バリデーション実行タイミング

**リアルタイムバリデーション**:
- 実行対象：文字数制限（HTMLのmaxlength属性で制限）
- 実行タイミング：入力時リアルタイム
- エラー表示：入力不可（制限文字数に達した時点で入力停止）

**保存時バリデーション**:
- 実行対象：必須入力チェック（ドラフト保存時は緩い条件）
- 実行タイミング：行フォーカスアウト時の自動保存時
- エラー表示：項目上下左右の吹き出しポップアップ

**承認申請時バリデーション**:
- 実行対象：全必須項目入力チェック + 重複チェック
- 実行タイミング：承認申請ボタンクリック時
- エラー表示：申請実行不可 + 詳細エラーメッセージ

#### 7.1.3 重複チェック詳細

**承認済みデータ間の重複チェック**:
- 対象：同一プロジェクト・ドメイン内での和名完全一致
- 実行タイミング：承認申請時・承認実行時
- エラー時処理：申請・承認を実行不可

**ドラフトデータの重複許可**:
- ドラフト同士：重複許可（作業用データのため）
- ドラフト vs 承認済み：承認申請時に重複チェック実行

### 7.2 データ整合性管理

#### 7.2.1 関連用語の整合性

**関連用語の自動更新**:
- 用語名変更時：関連用語として参照している箇所の表示名を自動更新
- 更新タイミング：承認済みデータの更新完了時
- 更新範囲：同一プロジェクト内の全ドメイン

**削除済み用語への関連付け処理**:
- 承認済み用語削除時：関連付けを自動削除（物理削除）
- 表示時処理：削除済み関連用語は表示対象から除外
- ログ記録：関連付け削除の履歴を変更履歴テーブルに記録

#### 7.2.2 ドメイン・プロジェクト変更時の影響

**ドメイン名変更時の処理**:
- 既存データ：変更なし（名前変更のみ）
- 表示への影響：新しいドメイン名での表示
- 履歴への影響：変更履歴テーブルには旧ドメイン名で記録済み

**プロジェクト削除時の処理**:
- 既存データ：論理削除（物理削除なし）
- 表示への影響：削除済みプロジェクトのデータは非表示
- アクセス権限：削除済みプロジェクトのユーザーはアクセス不可

### 7.3 競合制御・同時編集対策

#### 7.3.1 楽観ロック制御

**RowVersionによる制御**:
- 全編集対象テーブルにRowVersionカラム追加
- 編集開始時にRowVersionを取得・保持
- 保存時にRowVersionの整合性をチェック

**競合検知時の処理**:
- エラーメッセージ：「他のユーザーが同時編集中です。画面を更新してください。」
- ユーザー操作：F5キー等でブラウザ更新
- データ保護：競合時は保存実行せず、ユーザーに更新を促す

#### 7.3.2 先勝ち方式の実装

**基本方針**: 先に保存したユーザーの更新を優先

**処理フロー**:
1. ユーザーA・Bが同一データを同時編集開始
2. ユーザーAが先に保存実行 → 成功
3. ユーザーBが保存実行 → 競合エラー
4. ユーザーBは画面更新後、ユーザーAの更新内容を確認して再編集

### 7.4 データ削除・物理削除管理

#### 7.4.1 論理削除の実装

**対象テーブル**:
- ユーザーテーブル
- プロジェクトテーブル
- ドメインテーブル
- 正式用語テーブル

**削除フィールド**:
- deleted_at（削除日時、NULL = 未削除）
- deleted_by（削除者ID）

**表示制御**:
- 通常表示：deleted_at IS NULL の条件で絞り込み
- 削除済み表示：deleted_at IS NOT NULL も含めて表示

#### 7.4.2 物理削除の実装

**対象データ**:
- ドラフトデータ（承認時・ユーザー削除時）
- 一時作業データ（セッション管理等）

**削除実行タイミング**:
- 承認処理完了時：承認されたドラフトデータを自動物理削除
- ユーザー削除実行時：選択されたドラフトデータを物理削除

---

## 8. 通知・メッセージ機能

### 8.1 リアルタイム通知機能

#### 8.1.1 承認申請通知

**通知対象**:
- 対象ドメインの承認者のみ
- プロジェクト管理者・スーパーユーザーには通知しない

**通知メッセージ**: 「新規承認依頼が届きました。」

**表示方式**:
- 画面右下にトースター表示
- 表示時間：5秒間
- 自動消去：5秒後に自動的に非表示

**技術実装**:
- SignalR による双方向通信
- 承認者がオンライン時のみ通知表示
- オフライン時は次回ログイン時に未読件数表示（将来拡張）

#### 8.1.2 却下通知

**通知対象**: 申請者のみ

**通知メッセージ**: 「{和名}の申請が却下されました。」

**表示方式**:
- 画面右下にトースター表示
- 表示時間：5秒間
- カラー：エラー系の配色（赤系統）

**表示タイミング**: 却下処理完了時、申請者がオンラインの場合のみ

### 8.2 成功・失敗メッセージ表示

#### 8.2.1 成功メッセージ

**表示対象操作**:
- データ保存成功
- 承認・却下処理完了
- 各種登録・更新・削除処理完了

**表示方式**:
- 画面中央下部にトースター表示
- 表示時間：5秒間
- カラー：成功系の配色（緑系統）

**メッセージ例**:
- 「保存しました。」
- 「承認しました。」
- 「却下しました。」
- 「削除しました。」

#### 8.2.2 失敗・エラーメッセージ

**表示対象操作**:
- バリデーションエラー
- 権限エラー
- システムエラー
- 競合エラー

**表示方式**:
- 画面中央下部にトースター表示
- 表示時間：5秒間
- カラー：エラー系の配色（赤系統）

**メッセージ例**:
- 「必須項目が入力されていません。」
- 「他のユーザーが同時編集中です。画面を更新してください。」
- 「権限がありません。」
- 「システムエラーが発生しました。」

### 8.3 バリデーションエラー表示

#### 8.3.1 エラー表示方式

**表示方法**: 吹き出し型ポップアップ

**表示位置**: エラー項目の上下左右いずれか（自動判定）

**表示タイミング**: 対象DOM要素にフォーカスが当たっている時のみ

**表示色**: Firebrick（エラー色統一）

#### 8.3.2 エラー項目のハイライト

**ハイライト方式**: 薄い赤系の色でエラー項目を強調

**ハイライト対象**: 入力フィールドの背景色・ボーダー色

**解除タイミング**: エラー解消時に自動的にハイライト解除

#### 8.3.3 エラーメッセージの内容

**メッセージ方針**: 簡潔で分かりやすいメッセージ

**メッセージ例**:
- 「必須項目です。」
- 「30文字以内で入力してください。」
- 「半角英数字・ハイフン・アンダースコアのみ使用可能です。」
- 「先頭は英字で入力してください。」
- 「同じ名前の用語が既に存在します。」

### 8.4 期限管理・催促機能

#### 8.4.1 承認期限管理

**期限設定**: 不要

**理由**: 業務特性上、厳密な期限管理は不要

#### 8.4.2 催促機能

**催促通知**: 不要

**理由**: 承認者は定期的にシステムにアクセスするため

---

## 9. 検索・ソート・フィルタ機能

### 9.1 検索機能仕様

#### 9.1.1 基本検索機能

**検索対象画面**:
- ユビキタス言語一覧画面
- ユビキタス言語入力・編集画面
- ユビキタス言語承認画面

**検索対象項目**:
- 和名（部分一致検索）
- 英名（部分一致検索）
- 意味・説明（部分一致検索）
- 発生機会（部分一致検索）

**検索方式**:
- 大文字・小文字区別なし
- 前方一致・中間一致・後方一致すべて対象
- 複数キーワードのAND検索（スペース区切り）

#### 9.1.2 高度な検索機能

**実装要否**: 不要

**理由**: 基本的な部分一致検索で十分な検索精度を確保可能

### 9.2 フィルタ機能仕様

#### 9.2.1 必須フィルタ

**プロジェクト選択**:
- UI：ドロップダウンリスト
- 必須性：必須選択
- 選択肢：ユーザーの権限に応じたプロジェクト一覧
- 初期値：ユーザーの主所属プロジェクト

#### 9.2.2 任意フィルタ

**ドメイン選択**:
- UI：ドロップダウンリスト
- 必須性：任意選択
- 選択肢：選択したプロジェクト内のドメイン + 「すべてのドメイン」
- 初期値：「すべてのドメイン」

**状態フィルタ**（入力・編集画面のみ）:
- UI：チェックボックス（複数選択可能）
- 選択肢：ドラフト、承認申請、承認済み
- 初期値：すべて選択状態
- 機能：選択した状態のデータを同時表示

#### 9.2.3 日付範囲フィルタ

**作成日時・更新日時での絞り込み**: 不要

**理由**: 通常の業務では日付での絞り込み需要が低い

### 9.3 ソート機能仕様

#### 9.3.1 単一列ソート

**ソート対応**: 単一列のみ（複数列ソート不要）

**ソート対象列**:
- 和名（昇順・降順）
- 英名（昇順・降順）
- 発生機会（昇順・降順）
- 申請者氏名（昇順・降順、承認画面のみ）
- 申請日時（昇順・降順、承認画面のみ）

**初期ソート順**:
- ユビキタス言語一覧：和名昇順
- 入力・編集画面：最終更新日時降順
- 承認画面：申請日時降順

#### 9.3.2 ソート優先順位制御

**実装要否**: なし

**理由**: 単一列ソートのため優先順位制御は不要

### 9.4 検索実行・パフォーマンス

#### 9.4.1 検索実行タイミング

**自動検索**:
- フィルタ条件変更時：即座に検索実行
- 検索テキスト入力時：1秒のデバウンス後に自動検索

**手動検索**:
- 検索ボタンクリック時：即座に検索実行
- Enterキー押下時：即座に検索実行

#### 9.4.2 検索条件クリア

**クリア機能**: 「条件クリア」ボタン

**クリア対象**:
- 検索テキストボックス：空文字に設定
- ドメイン選択：「すべてのドメイン」に設定
- 状態フィルタ：すべて選択状態に設定
- プロジェクト選択：変更なし（必須のため）

#### 9.4.3 検索パフォーマンス対策

**データベースインデックス**:
- 和名フィールド：部分一致検索用インデックス
- プロジェクトID・ドメインID：結合検索用インデックス
- 削除フラグ・状態フィールド：絞り込み用インデックス

**検索結果制限**:
- 最大表示件数：1000件
- 超過時：「検索結果が多すぎます。条件を絞り込んでください。」表示

---

## 10. セキュリティ・権限制御

### 10.1 認証・セキュリティ基盤

#### 10.1.1 認証方式

**基本認証方式**: ユーザーID（メールアドレス）・パスワードによる独自認証

**セッション管理**:
- セッションタイムアウト：2時間（設定変更可能）
- 自動ログイン：チェックボックス選択時に7日間有効
- セッション固定攻撃対策：ログイン成功時にセッションID再生成

**パスワード要件**:
- 最小文字数：8文字以上
- 文字種類：英数字混在推奨（必須ではない）
- パスワード履歴：前回と同一パスワード禁止

#### 10.1.2 セキュリティ対策

**CSRF対策**:
- すべてのフォーム送信時にCSRFトークン検証
- Blazor Server の標準CSRF対策機能を使用

**XSS対策**:
- ユーザー入力内容の自動エスケープ処理
- HTMLタグの無害化処理

**SQLインジェクション対策**:
- Entity Framework Core のパラメータクエリ使用
- 動的SQL生成の禁止

**セキュリティヘッダ**:
- X-Content-Type-Options: nosniff
- X-Frame-Options: DENY
- X-XSS-Protection: 1; mode=block

### 10.2 権限制御システム

#### 10.2.1 ロールベースアクセス制御（RBAC）

**4段階ユーザーロール**:
1. **スーパーユーザー**: システム全体の管理権限
2. **プロジェクト管理者**: 担当プロジェクトの管理権限
3. **ドメイン承認者**: 担当ドメインの承認権限
4. **一般ユーザー**: 用語作成・編集権限

**権限継承**: 上位ロールは下位ロールの権限を包含

#### 10.2.2 データアクセス権限

**プロジェクトレベル権限**:
- **スーパーユーザー**: 全プロジェクトへのアクセス可能
- **プロジェクト管理者**: 担当プロジェクトのみアクセス可能
- **ドメイン承認者・一般ユーザー**: 所属プロジェクトのみアクセス可能

**ドメインレベル権限**:
- **承認権限**: ドメイン承認者は担当ドメインの承認申請のみ承認可能
- **参照権限**: 同一プロジェクト内の他ドメインは参照可能
- **編集権限**: 全ユーザーが全ドメインのドラフト用語作成・編集可能

#### 10.2.3 機能別アクセス制御

**ユーザー管理機能**:
- 表示：プロジェクト管理者以上
- 登録・編集・削除：権限に応じた範囲で実行可能

**プロジェクト管理機能**:
- 表示：プロジェクト管理者以上
- 登録・削除：スーパーユーザーのみ
- 編集：権限に応じた範囲で実行可能

**ドメイン管理機能**:
- 表示：プロジェクト管理者以上
- 登録・編集・削除：権限に応じた範囲で実行可能

**承認機能**:
- 承認実行：ドメイン承認者以上、権限範囲内のみ
- 承認一覧表示：ドメイン承認者以上

### 10.3 UI権限制御

#### 10.3.1 メニュー・ナビゲーション制御

**全ユーザー共通表示**:
- ログアウト
- ユビキタス言語一覧
- ユビキタス言語入力・編集
- プロフィール変更
- パスワード変更

**権限別表示制御**:
- **ドメイン承認者以上**: ユビキタス言語承認
- **プロジェクト管理者以上**: ユーザー一覧、プロジェクト一覧、ドメイン一覧

#### 10.3.2 ボタン・操作要素制御

**条件付き表示・操作制限**:
- **プロジェクト削除**: スーパーユーザーのみ
- **ドメイン削除**: プロジェクト管理者以上
- **ユビキタス言語削除**: ドメイン承認者以上（承認済みデータのみ）
- **プロジェクト切替**: プロジェクト管理者以上

**動的制御**: ユーザーの権限に応じてボタン・リンクの表示/非表示を切り替え

### 10.4 データ保護・プライバシー

#### 10.4.1 個人情報保護

**個人情報の範囲**:
- ユーザーのメールアドレス
- ユーザーの氏名
- ログイン履歴

**保護対策**:
- パスワードのハッシュ化保存（bcrypt使用）
- 個人情報の適切なアクセス制御
- 削除済みユーザー情報の論理削除保持

#### 10.4.2 機密情報管理

**業務機密情報の範囲**:
- プロジェクト名・内容
- ドメイン設計情報
- ユビキタス言語定義

**保護対策**:
- 所属プロジェクト外のデータへのアクセス制限
- 権限に基づく表示データの自動フィルタリング
- エクスポート機能の権限制御

### 10.5 変更履歴管理機能

#### 10.5.1 変更履歴管理

**履歴記録対象**:
- 承認済みユビキタス言語の全変更
- ユーザー・プロジェクト・ドメインの重要変更

**履歴記録内容**:
- 変更前後のデータ全体
- 変更実行者・承認者
- 変更日時・承認日時
- 変更理由（却下理由含む）

**履歴保持期間**: 論理削除により永続保持（将来的にアーカイブ機能検討）

---

**承認履歴**
- 2025-06-28: Claude Code作成

**関連文書**
- 要件定義書: `/Doc/01_Requirements/要件定義書.md`
- 画面設計書: `/Doc/02_Design/UI設計/`
- 追加要件: `/Doc/01_Requirements/Draft/機能仕様書_追加要件.md`
- 申し送り事項: `/Doc/03_Meetings/申し送り事項.md`

**次工程**
- ユーザーストーリー作成 (`/Doc/01_Requirements/ユーザーストーリー.md`)
- データベース設計書作成 (`/Doc/02_Design/データベース設計書.md`)
- システム設計書作成 (`/Doc/02_Design/システム設計書.md`)