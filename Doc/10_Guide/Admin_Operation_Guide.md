# 管理者向け運用ガイド - Phase A2

**作成日**: 2025-07-20  
**対象**: システム管理者・プロジェクト管理者  
**Phase**: A2ユーザー管理機能  

## 📋 システム概要

### 実装完了機能（Phase A2）
- ✅ **基本認証システム**（Phase A1）
  - ログイン・ログアウト・セッション管理
  - ASP.NET Core Identity統合
  - 基本ユーザー管理
  
- ✅ **ユーザー管理機能拡張**（Phase A2）
  - ユーザーCRUD操作（作成・読み取り・更新・削除）
  - プロフィール管理・パスワード変更
  - ロールベース権限管理（SuperUser, ProjectManager, DomainApprover, GeneralUser）
  - 高度検索・フィルタリング・ページング機能

### 技術構成
- **バックエンド**: .NET 8.0, F# Domain/Application, C# Infrastructure/Web
- **データベース**: PostgreSQL (Docker Container)
- **認証**: ASP.NET Core Identity
- **UI**: Blazor Server
- **アーキテクチャ**: Clean Architecture

## 🔧 システム起動・停止

### 通常起動手順
```bash
# 1. PostgreSQLコンテナ起動（初回または停止後）
docker-compose up -d postgresql

# 2. アプリケーション起動
cd src/UbiquitousLanguageManager.Web
dotnet run

# 3. ブラウザでアクセス
# http://localhost:5000 または https://localhost:5001
```

### 停止手順
```bash
# 1. アプリケーション停止（Ctrl+C）

# 2. PostgreSQLコンテナ停止（必要に応じて）
docker-compose down
```

### 開発環境確認
```bash
# ビルド確認
dotnet build

# データベース接続確認
dotnet ef database update --project src/UbiquitousLanguageManager.Infrastructure
```

## 👥 ユーザー管理

### ロール階層
1. **SuperUser（最高権限）**
   - 全ユーザー管理
   - 全ロール作成・変更権限
   - システム設定変更

2. **ProjectManager（プロジェクト管理者）**
   - 配下ユーザー管理
   - ProjectManager以下のロール作成・変更
   - プロジェクト範囲での権限管理

3. **DomainApprover（ドメイン承認者）**
   - ドメイン固有の承認業務
   - ユーザー作成権限なし

4. **GeneralUser（一般ユーザー）**
   - 基本機能利用
   - 自分のプロフィール管理のみ

### 初期ユーザー設定
```bash
# 管理者ユーザー作成（アプリケーション初回起動時）
# デフォルト管理者:
# Email: admin@example.com
# Password: Admin123!
# Role: SuperUser
```

### ユーザー操作フロー

#### 新規ユーザー作成
1. **管理者ログイン**（SuperUser または ProjectManager）
2. **ユーザー管理画面**に移動
3. **「新規ユーザー作成」**ボタン
4. **必須情報入力**:
   - メールアドレス
   - ユーザー名
   - ロール選択
   - 初期パスワード
5. **権限確認**・**保存**

#### ユーザー情報更新
1. **対象ユーザー検索**（一覧・フィルタリング機能）
2. **「編集」**ボタン
3. **情報更新**:
   - プロフィール情報
   - ロール変更（権限内）
   - アクティブ状態切り替え
4. **変更確認**・**保存**

#### パスワードリセット
1. **管理者による強制リセット**
2. **ユーザーによる自己変更**
   - 現在パスワード確認
   - 新パスワード（強度チェック）
   - 確認パスワード

## 🔍 監視・トラブルシューティング

### ログ確認
```bash
# アプリケーションログ
tail -f logs/app.log

# PostgreSQLログ
docker logs ubiquitous-lang-mng_postgresql_1
```

### よくある問題と解決策

#### 1. ログインできない
**症状**: ユーザーがログインに失敗する
**確認事項**:
- ユーザーアカウントがアクティブか
- パスワードが正しいか
- データベース接続状況
**解決策**:
```bash
# データベース接続確認
docker ps | grep postgres
# ユーザー状態確認（データベース直接確認）
```

#### 2. 権限エラー
**症状**: 操作権限が不足する
**確認事項**:
- ユーザーロールの確認
- 操作対象ユーザーとの権限関係
**解決策**:
- ロール階層に従った権限付与
- 必要に応じて管理者に権限変更依頼

#### 3. データベース接続エラー
**症状**: アプリケーション起動時にエラー
**確認事項**:
```bash
# PostgreSQLコンテナ状態
docker ps
docker logs [container_id]

# 接続文字列確認
cat src/UbiquitousLanguageManager.Web/appsettings.json
```
**解決策**:
```bash
# コンテナ再起動
docker-compose restart postgresql
# マイグレーション実行
dotnet ef database update
```

#### 4. パフォーマンス問題
**症状**: ページ読み込みが遅い
**確認事項**:
- ユーザー数の確認
- 検索条件の複雑さ
**解決策**:
- ページングサイズ調整
- インデックス活用
- フィルタリング条件最適化

## 📊 運用指標

### 監視項目
- **アクティブユーザー数**
- **ログイン成功率**
- **データベース接続数**
- **レスポンス時間**

### パフォーマンス基準
- **ページ読み込み**: 3秒以内
- **ユーザー検索**: 1秒以内
- **データベース応答**: 500ms以内

## 🚨 緊急時対応

### システム停止時
1. **データベースバックアップ**確認
2. **ログ収集**・**エラー分析**
3. **必要に応じてロールバック**

### データ不整合時
1. **データベース整合性確認**
2. **トランザクションログ確認**
3. **必要に応じて手動修正**

## 🔄 定期メンテナンス

### 日次作業
- ログファイル確認
- データベース容量確認
- バックアップ実行確認

### 週次作業
- パフォーマンス指標レビュー
- ユーザーアクセス分析
- セキュリティログ確認

### 月次作業
- システム全体レビュー
- ユーザー権限整理
- データベース最適化

## 📚 関連ドキュメント

- [システム設計書](/Doc/02_Design/システム設計書.md)
- [データベース設計書](/Doc/02_Design/データベース設計書.md)
- [Phase A2実装記録](/Doc/04_Daily/)
- [技術負債管理](/Doc/10_Debt/)

## ⚠️ 既知の制限事項（Phase A3で解決予定）

### 統合テスト問題
- **問題**: WebApplicationFactory統合テストでHTTP 500エラー
- **影響**: 統合テスト実行不可（実アプリケーションは正常動作）
- **解決時期**: Phase A3

### エンティティテーブル競合
- **問題**: UserEntityとApplicationUserのAspNetUsersテーブル競合
- **影響**: 高度な機能での制限
- **解決時期**: Phase A3

### 提案機能（Phase A3以降）
- パスワードリセット機能
- 自動ログイン機能
- 監査ログ強化
- セキュリティ機能拡張

---

**緊急連絡先**: 開発チーム  
**最終更新**: 2025-07-20  
**次回更新予定**: Phase A3完了時  