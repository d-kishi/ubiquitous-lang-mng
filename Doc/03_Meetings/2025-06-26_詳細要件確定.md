# 詳細要件確定会議録

**日時**: 2025-06-26  
**参加者**: プロジェクトオーナー、Claude Code  
**目的**: 前回要件整理の課題点検証と詳細仕様の確定  

## 会議概要

前回（2025-06-25）の要件整理を受けて、設計上の課題検証と詳細要件の確定を実施。技術選定の見直しからユーザー権限体系の詳細化まで、実装に向けた具体的仕様を確定した。

## 主要な決定事項・変更事項

### 1. アーキテクチャパターンの変更

#### 変更内容
- **変更前**: Clean Architecture + DDD + CQRS
- **変更後**: Clean Architecture + DDD + **従来型CRUD**

#### 変更理由
- CQRS とリアルタイムUI（Blazor Server + インライン編集）の相性問題
- 読み書き分離による遅延がリアルタイム要件と競合
- 結果整合性が同時編集・競合処理と相性悪い
- システム規模に対する過剰設計

### 2. F#適用範囲の拡大

#### 拡大内容
- **変更前**: ドメイン層のみ
- **変更後**: ドメイン層 + アプリケーション層 + Infrastructure層

#### 拡大理由
- F#学習目的の最大化
- 関数型プログラミングの一貫した活用
- アプリケーション層での関数合成・ワークフロー表現
- EF Core + F# の学習・実践機会

#### 最終的な言語分担
```
┌─ Presentation Layer (C# - Blazor Server)
├─ Application Layer (F# - Use Cases/Workflows)
├─ Domain Layer (F# - Entities/Domain Services)  
├─ Infrastructure Layer (F# - EF Core Repository)
└─ Web API Controllers (C# - 薄いレイヤー)
```

## 詳細仕様の確定

### 3. UI操作・保存処理の詳細仕様

#### 保存タイミング
- **単位**: 行単位での保存
- **トリガー**: 行からフォーカスが外れた際に実行
- **同一行内移動**: 和名→英名→定義等の同一行内移動では保存されない
- **保存対象**: 別行移動時・テーブル外要素クリック時

#### 競合処理方式
- **検知タイミング**: 保存処理実行時
- **処理方式**: 先勝ち（First-Win）
- **警告内容**: 「他ユーザが編集中です。画面を更新してください。」
- **後発者対応**: 保存処理キャンセル、画面更新要求

#### 編集権限と所有者管理
- **ドラフト編集**: 全ユーザーが他人のドラフト編集可能
- **正式版編集**: 新ドラフト自動作成→編集者が新所有者
- **編集権限**: 担当ドメイン内での編集、同一プロジェクト他ドメインは参照のみ

### 4. ユーザーロール・権限体系の詳細確定

#### ロール定義と権限

| ロール | 管理権限 | データ操作権限 | アクセス範囲 |
|--------|----------|----------------|--------------|
| **スーパーユーザー** | 新規プロジェクト追加<br>全ユーザー権限設定 | 全プロジェクト・全ドメイン<br>参照・編集・承認 | 制限なし |
| **プロジェクト管理者** | 担当プロジェクト内<br>ユーザー追加・ドメイン管理<br>ユーザー・ドメイン紐づけ | 担当プロジェクト内<br>参照・編集・承認 | 担当プロジェクトのみ |
| **ドメイン承認者** | なし | 担当ドメイン：参照・編集・承認<br>同一プロジェクト他ドメイン：参照のみ | 担当プロジェクトのみ |
| **一般ユーザー** | なし | 担当ドメイン：参照・編集<br>同一プロジェクト他ドメイン：参照のみ | 担当プロジェクトのみ |

#### 階層的権限管理
- **スーパーユーザー**: 全ユーザーの権限設定
- **プロジェクト管理者**: 担当プロジェクト内のドメイン承認者・一般ユーザー設定
- **権限管理の運用**: 上位者が下位者の権限を設定する階層構造

#### 所属関係
- **複数プロジェクト所属**: 1ユーザーが複数プロジェクトに所属可能
- **複数ドメイン担当**: 1ユーザーが複数ドメインを担当可能（プロジェクト跨ぎ含む）

### 5. その他詳細仕様

#### Claude Code連携
- **出力方式**: 手動出力（画面上のボタンクリック）
- **出力タイミング**: ユーザー指定時
- **ファイル形式**: Markdown形式
- **画面設計**: システム全体の画面構成と合わせて検討

#### 認証・セキュリティ
- **認証方式**: 独自ログイン画面
- **将来対応**: 社内認証基盤との連携予定
- **ユーザー管理**: DBにユーザー情報テーブル必須

#### データベース移行戦略
- **移行判断**: 部門長承認取得後
- **移行タイミング**: 製造完了後
- **移行対象**: SQLite → PostgreSQL

## 今後の課題・検討事項

### 設計フェーズでの検討項目
1. **システム全体の画面構成設計**
   - 各機能の画面設計・画面遷移
   - Claude Code連携を含む操作フロー
   - ユーザーロール別の画面表示制御

2. **ユーザー情報テーブル設計**
   - 独自認証用のテーブル構造
   - 将来の社内認証基盤連携を考慮した設計
   - ロール・権限管理のデータ構造

3. **技術PoC実施**
   - F# + EF Core の動作検証
   - Blazor Server での行単位保存実装検証
   - 競合処理・リアルタイム更新の実装検証

## 次回予定・アクションアイテム

### 次回実施候補（優先順）
1. **要件定義書の正式版作成** - 今回確定仕様の文書化
2. **システム設計書作成** - 修正アーキテクチャの詳細設計  
3. **画面構成設計** - UI全体設計・画面遷移設計
4. **データベース設計書作成** - エンティティ詳細・ER図・テーブル設計
5. **技術PoC実施** - F# + EF Core + Blazor Server構成の動作検証

### 重要な申し送り事項
- **アーキテクチャ変更**: CQRS → 従来型CRUD
- **F#範囲拡大**: Infrastructure層まで含む全レイヤー適用
- **詳細UI仕様**: 行単位保存・先勝ち競合処理
- **権限体系確定**: 4段階ロール・階層管理の詳細仕様

---

**記録者**: Claude Code  
**承認者**: プロジェクトオーナー  
**次回予定**: 要件定義書作成・設計フェーズ開始