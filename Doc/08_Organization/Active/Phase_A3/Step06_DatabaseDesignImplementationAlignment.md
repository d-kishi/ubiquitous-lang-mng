# Step06: データベース設計・実装整合性修正

**Phase**: A3 - Authentication Extensions & Email Infrastructure  
**Step**: 06 (新規挿入)  
**期間予定**: 3-4セッション  
**組織特性**: 複雑Phase（技術領域横断・依存関係多数）  
**作成日**: 2025-07-28  

## 🎯 Step概要

### 背景・目的
Phase A1～A3実装において、データベース設計書と実際の実装に重大な不整合が発見されました。この不整合は以下の重要な問題を引き起こしています：

1. **AspNetUsersテーブル列定義不一致**: Phase A3パスワードリセット機能で必要な列が不足
2. **重複テーブル問題**: 設計書にないUsersテーブルが不正作成
3. **エンティティ定義不整合**: ApplicationUserクラスが設計書と不一致
4. **テスト破綻リスク**: 上記問題により関連テスト修正が必須

### Step目的
**データベース設計書を絶対的真実として、Phase A1～A3実装との完全整合化を実現**

## 🔬 組織設計

### 組織構成: 6専門役割並列分析体制
複雑Phaseの特性（技術領域横断・依存関係多数・品質影響大）により、専門性による分割統治アプローチを採用。

#### 1. データベーススキーマ専門家
**🎯 責務**: データベース設計書との完全整合化
```
専門領域:
- AspNetUsersテーブル列定義詳細分析
- マイグレーション vs init/スキーマ不整合解決策
- PostgreSQL固有機能・制約整合性確認  
- データ移行リスク・手順分析
```

#### 2. エンティティ・ORM専門家
**🎯 責務**: ApplicationUser・DbContext整合性修正
```
専門領域:
- ApplicationUserプロパティ詳細修正計画
- EF Core設定・アノテーション整合性修正
- F#↔C#境界エンティティマッピング確認
- Clean Architecture Entity設計原則準拠確認
```

#### 3. テスト戦略・TDD専門家
**🎯 責務**: テスト修正戦略・TDD実践計画
```
専門領域:
- 破綻テスト特定・修正優先度策定
- Red-Green-Refactorサイクル詳細計画
- テストカバレッジ80%維持戦略
- 統合テスト・品質保証計画
```

#### 4. Phase A3機能実装専門家
**🎯 責務**: 認証拡張機能完全実装
```
専門領域:
- パスワードリセット機能実装計画（DB列追加後）
- Remember Me機能実装状況確認・完成計画
- メール送信機能（smtp4dev連携）完全実装
- ASP.NET Core Identity拡張機能統合
```

#### 5. Clean Architecture・F#↔C#境界専門家
**🎯 責務**: アーキテクチャ整合性・型変換確認
```
専門領域:
- Contracts層実装状況詳細確認
- F# Domain/Application層実装確認
- 型変換ロジック実装・動作確認
- 依存関係逆転原則準拠確認
```

#### 6. 仕様準拠・品質保証専門家
**🎯 責務**: 仕様準拠確認・品質保証戦略
```
専門領域:
- 仕様準拠マトリックス作成（肯定的・否定的仕様）
- データベース設計書100%準拠確認
- Phase A1-A3機能仕様完全準拠確認
- 品質保証チェックリスト策定・継続監視
```

## 📊 実行計画

### Session 1: 並列分析・統合計画策定
**目的**: 6専門役割による徹底分析・解決策統合
**予定時間**: 180分

```
Phase 1: 並列分析実行 (90分)
├── 各専門役割による独立分析 (15分 × 6)
├── Gemini技術調査連携 (各役割)
└── 分析結果まとめ (各役割)

Phase 2: 統合・優先順位付け (60分)
├── 分析結果統合・重複排除 (30分)
├── 影響度・緊急度による優先順位 (20分)
└── 実装順序・依存関係決定 (10分)

Phase 3: 詳細計画策定 (30分)
├── 仕様準拠マトリックス作成 (15分)
├── TDD実践詳細計画確定 (10分)
└── 次Session具体作業計画 (5分)
```

### Session 2: データベース・エンティティ基盤修正
**目的**: 最優先基盤修正（TDD適用）
**予定時間**: 180分

```
1. マイグレーション削除・init/スキーマ適用 (30分)
2. ApplicationUser修正（TDD Red-Green-Refactor） (60分)
3. DbContext設定修正（TDD適用） (45分)
4. 基盤テスト修正・成功確認 (30分)
5. 中間品質確認・記録 (15分)
```

### Session 3: Phase A3機能実装・テスト完成
**目的**: 認証拡張機能完全実装
**予定時間**: 180分

```
1. パスワードリセット機能実装（TDD適用） (75分)
2. Remember Me機能確認・実装（TDD適用） (45分)
3. メール送信機能実装（TDD適用） (45分)
4. 統合テスト実行・調整 (15分)
```

### Session 4: 品質保証・完了確認
**目的**: 仕様準拠100%・品質基準達成
**予定時間**: 120分

```
1. F#↔C#境界確認・修正 (45分)
2. 仕様準拠マトリックス100%達成確認 (30分)
3. テストカバレッジ80%以上確認 (30分)
4. 最終品質保証・Phase A3完了宣言 (15分)
```

## 🎯 仕様準拠マトリックス（作成予定）

### データベース設計書準拠確認項目
- [ ] AspNetUsersテーブル列定義100%一致
- [ ] PasswordResetToken列の正しい実装  
- [ ] PasswordResetExpiry列の正しい実装
- [ ] 余計な列（CreatedAt等）の完全削除
- [ ] マイグレーション vs init/スキーマ完全一致

### Phase A3機能仕様準拠確認項目
- [ ] パスワードリセット機能100%実装
- [ ] Remember Me機能100%実装
- [ ] メール送信機能100%実装
- [ ] セキュリティ要件100%準拠
- [ ] UI/UX仕様100%準拠

### Clean Architecture準拠確認項目
- [ ] Domain層の純粋性維持
- [ ] Application層のユースケース実装
- [ ] Infrastructure層の技術実装分離
- [ ] F#↔C#境界の正しい実装
- [ ] 依存関係逆転原則100%準拠

## 📋 TDD実践戦略

### Red-Green-Refactorサイクル適用対象

#### ApplicationUser修正
```
Red: PasswordResetToken/PasswordResetExpiry要求テスト → 失敗確認
Green: 必要プロパティ追加 → テスト成功確認
Refactor: 不要プロパティ削除・コード整理 → テスト継続成功
```

#### パスワードリセット機能
```
Red: パスワードリセット要求・実行テスト → 失敗確認
Green: 最小限サービス実装 → テスト成功確認  
Refactor: セキュリティ・エラーハンドリング強化 → テスト継続成功
```

#### メール送信機能  
```
Red: メール送信要求テスト → 失敗確認
Green: smtp4dev連携基本実装 → テスト成功確認
Refactor: テンプレート・履歴管理追加 → テスト継続成功
```

## ✅ 成功基準

### 技術的完了基準
1. ✅ データベーススキーマ設計書100%一致
2. ✅ ApplicationUser定義設計書100%一致
3. ✅ Phase A3全機能100%実装・動作確認
4. ✅ 全テスト成功・カバレッジ80%以上維持
5. ✅ F#↔C#境界100%動作確認

### 品質完了基準
1. ✅ 仕様準拠マトリックス100%達成
2. ✅ Clean Architecture原則100%準拠
3. ✅ 技術負債適切記録・管理完了
4. ✅ セキュリティ要件100%準拠
5. ✅ 継続的監視体制確立

## 🚨 リスク管理

### 特定リスク・対策
- **データベースリスク**: バックアップ・段階適用・ロールバック手順
- **テスト破綻リスク**: TDD適用・段階修正・継続テスト実行
- **実装遅延リスク**: 優先度明確化・MVP実装・段階機能追加

## 📚 参照ドキュメント

### 調査結果（必須確認）
- `/Doc/05_Research/Phase_A3/Phase6/DatabaseDesignImplementationAlignment_Investigation.md`
- `/Doc/05_Research/Phase_A3/Phase6/ActionPlan_DatabaseImplementationAlignment.md`

### 設計書（絶対的真実）
- `/Doc/02_Design/データベース設計書.md` - データベース設計絶対基準
- `/Doc/01_Requirements/機能仕様書.md` - Phase A3機能要件
- `/init/01_create_schema.sql` - 正しいスキーマ定義

### 組織運用
- `/Doc/08_Organization/Rules/組織管理運用マニュアル.md` - Step実行手順
- `/Doc/07_Decisions/ADR_013_組織管理サイクル運用規則.md` - 組織運用規則

## 📊 実行記録

### Session 1実行記録
**実行日**: 未実行  
**実行内容**: 実行予定  
**成果**: 実行予定  
**課題**: 実行予定  

### Session 2実行記録  
**実行日**: 未実行  
**実行内容**: 実行予定  
**成果**: 実行予定  
**課題**: 実行予定

### Session 3実行記録
**実行日**: 未実行  
**実行内容**: 実行予定  
**成果**: 実行予定  
**課題**: 実行予定

### Session 4実行記録
**実行日**: 未実行  
**実行内容**: 実行予定  
**成果**: 実行予定  
**課題**: 実行予定

## 📈 組織効果測定

### 効率性評価
**目標**: 単独作業比50%短縮  
**実績**: 測定予定  

### 品質向上評価
**目標**: 見落とし0件・仕様準拠100%  
**実績**: 測定予定

### 専門性発揮評価
**目標**: 各専門領域の深い分析実現  
**実績**: 測定予定