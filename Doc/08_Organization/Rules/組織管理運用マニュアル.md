# 組織管理運用マニュアル

**目的**: SubAgentプール活用による組織運用の実行ガイド  
**適用範囲**: 全Phase・全Step  
**作成日**: 2025-07-21  
**最終更新**: 2025-08-19（プロセス遵守違反防止策統合）  

## 🔴 プロセス遵守チェックリスト（ADR_016準拠）

### 必須確認事項（例外なし）
- **コマンド = 契約**: 一字一句を法的契約として遵守
- **承認 = 必須**: 「ユーザー承認」表記があれば例外なく取得
- **手順 = 聖域**: 定められた順序の勝手な変更を絶対禁止

### Phase/Step開始前チェック（必須）
```markdown
## 🔴 Phase開始前必須確認
- [ ] phase-startコマンドの完全読み込み・理解完了
- [ ] 「ユーザー承認」箇所の明確な識別・確認完了
- [ ] 承認取得前の作業開始禁止の再確認完了
- [ ] 独断判断・先回り作業の絶対禁止確認完了

## 🔴 Step開始前必須確認  
- [ ] step-startコマンドの完全読み込み・理解完了
- [ ] 前Step完了承認の明示的確認完了
- [ ] SubAgent実行計画のユーザー承認取得完了
- [ ] 承認範囲外作業の絶対禁止確認完了
```

### SubAgent実行時チェック（必須）
```markdown
## 🔴 SubAgent実行時必須確認
- [ ] Task/Agent Toolの実際の呼び出し実行確認
- [ ] 成果物ファイルの物理的存在確認完了
- [ ] 「想定」「シミュレーション」の完全排除確認
- [ ] 報告内容と実体ファイルの完全一致確認完了
```

### 承認取得時チェック（必須）
```markdown
## 🔴 承認取得時必須確認
- [ ] 承認対象の明確な提示・説明完了
- [ ] 承認範囲の具体的な明示・合意完了
- [ ] 承認取得の明示的記録・文書化完了
- [ ] 承認範囲外作業の絶対禁止再確認完了
```

## 🚀 SubAgent活用実行ガイド（簡略化版）

### 🎯 Phase開始準備（Phase全体枠組み構築）
1. **🔧 phase-start Command実行** → [phase-start Command](./.claude/commands/phase-start.md)でPhase全体準備・ディレクトリ作成・Phase_Summary.md作成
2. **Phase開始承認** → Phase準備完了確認・Phase実行開始の最終承認
3. **Step1開始確認** → ユーザーによるStep1実行開始の意思決定

### 🔄 Step1開始時（Step実行準備）
1. **🔧 step-start Command実行** → [step-start Command](./.claude/commands/step-start.md)でStep1準備・subagent-selection実行
2. **🔧 subagent-selection実行** → step-start内でSubAgent組み合わせ選択・並列実行計画策定
3. **SubAgent並列実行** → ユーザー承認後のSubAgent専門作業並列実行

### 📋 Step1終了時（成果物出力先更新）
1. **🔄 成果物出力先更新** → `/Doc/08_Organization/Active/Phase_XX/Research/`配下に出力
2. **🔴 SubAgent成果物出力確認（必須）** → 全成果物出力・品質確認
2. **🔴 分析結果記録（必須）** → [ファイル管理規約：Step1分析結果記録システム](./ファイル管理規約.md#Step1分析結果記録システム)に従って記録実施
3. **Step1 レビュー記録** → `Step01_Analysis.md` にレビュー結果追加
4. **全Step実行プロセス決定** → Phase全体のStep構成・期間・組織構成概要を決定
5. **Phase計画更新** → `Phase_Summary.md` の「全Step実行プロセス」セクションに記録
6. **ユーザー承認** → Step1完了承認取得

### 🔄 各Step実行サイクル（全Step共通）

#### Step開始時（強化版・task-breakdown統合）
1. **🔧 step-start Command実行** → [step-start Command](./.claude/commands/step-start.md)でStep準備・組織設計・実行準備
2. **🆕 task-breakdown自動実行** → step-start内で以下を自動実行
   - GitHub Issue読み込み（高優先度・phase-B1等）
   - Clean Architecture層別タスク分解
   - 権限制御・テスト作業分解
   - TodoList自動生成・工数見積もり
3. **SubAgent並列実行** → 分解されたタスクリストに基づくSubAgent専門作業並列実行
4. **作業実行** → TodoListに従った体系的なテストファースト開発実践
5. **実行記録・Todo更新** → `StepXX_[内容].md` 実行記録＋TodoList進捗の継続更新

#### Step実行中（TDDサイクル）
1. **Red Phase確認** → 失敗するテストの作成完了・失敗確認（必須チェックポイント）
2. **Green Phase確認** → 最小限実装によるテスト成功確認（必須チェックポイント）
3. **Refactor Phase確認** → コード品質改善・テスト継続成功確認（必須チェックポイント）
4. **継続的更新** → 各フェーズ完了時の実行記録更新
5. **組織構成調整** → 必要に応じた組織構成の微調整・記録

#### 重要な中間確認ポイント（ユーザー承認必須）
1. **設計変更発生時** → アーキテクチャ・データモデル重要変更のユーザー確認・承認取得
2. **技術負債記録時** → 新規技術負債発見・記録のユーザー報告・対応方針確認
3. **仕様逸脱発見時** → 仕様準拠問題・リスク発見のユーザー報告・対応判断確認
4. **作業量大幅相違時** → 見積もりとの大幅な相違発生時のStep再計画・ユーザー承認

#### Step終了時
1. **🔧 Step終了時レビューCommand実行** → [step-end-review Command](./.claude/commands/step-end-review.md)で包括的品質確認
2. **🔧 仕様準拠確認Command実行** → [spec-compliance-check Command](./.claude/commands/spec-compliance-check.md)で仕様準拠監査
3. **🧪 テストアーキテクチャ整合性確認**（Issue #40再発防止策）
   - [ ] 新規テストプロジェクト作成時、設計書との整合性確認
   - [ ] テストプロジェクト命名規則準拠確認（`{ProjectName}.{Layer}.{TestType}.Tests`）
   - [ ] 不要な参照関係の追加がないか確認
   - [ ] `EnableDefaultCompileItems=false`等の技術負債が増加していないか確認
4. **Command実行結果評価** → 各Command実行結果による品質・準拠度評価
5. **ユーザー報告** → Step完了・Command実行結果をユーザーに報告・Step完了承認取得

### 🏁 Phase完了時
1. **🔧 phase-end Command実行** → [phase-end Command](./.claude/commands/phase-end.md)でPhase総括・品質確認・次Phase移行準備
2. **Phase総括レポート作成** → `Phase_Summary.md` に包括的な総括レポート追加
3. **成果統合確認** → 全Step成果・テスト結果・仕様準拠の最終確認
4. **🧪 テストアーキテクチャレビュー**（Issue #40再発防止策）
   - [ ] テストアーキテクチャ設計書の最新性確認
   - [ ] 全テストプロジェクトの構成妥当性確認（ADR_020準拠）
   - [ ] Phase中に発生した技術負債の記録・Issue化
   - [ ] 次Phase向けテストアーキテクチャ改善提案
5. **知見蓄積・改善提案** → 技術パターン・プロセス改善・教訓の記録
6. **ユーザーレビュー・承認** → Phase完了承認・次Phase方針確認・ディレクトリ移動承認
7. **Phase完了処理実行** → Active → Completed移動・プロジェクト状況更新・次Action提示

## 🔧 Command実行体制

### 作成済みCommand一覧
- **[phase-start.md](./.claude/commands/phase-start.md)**: Phase開始準備・ディレクトリ作成・基本計画
- **[step-start.md](./.claude/commands/step-start.md)**: Step開始準備・組織設計・実行準備
- **[subagent-selection.md](./.claude/commands/subagent-selection.md)**: SubAgent選択・並列実行計画
- **[step-end-review.md](./.claude/commands/step-end-review.md)**: Step終了時包括的レビュー
- **[phase-end.md](./.claude/commands/phase-end.md)**: Phase終了総括・品質確認・次Phase移行準備
- **[spec-compliance-check.md](./.claude/commands/spec-compliance-check.md)**: 仕様準拠確認・監査

### Command実行責任者
- **MainAgent**: Command実行統制・結果統合・ユーザー報告
- **対応SubAgent**: Command実行支援・専門的評価・成果物反映

---

## 🔧 SubAgent並列実行ガイド（ADR_016準拠）

### 必須実行方法
```markdown
## 🔴 SubAgent並列実行の必須手順
- [ ] 同一メッセージ内で複数Task tool呼び出し実行
- [ ] 依存関係のないタスクのみ並列化
- [ ] 実行計画で「並列」明記時は必須確認
- [ ] 実際の並列実行確認（表示上の順次実行は直列）
```

### 🔴 必須実装方法（具体例）

#### ✅ 正しい実装（並列実行）
同一メッセージ内で複数Task tool呼び出し：
```
<function_calls>
<invoke name="Task">
<parameter name="description">MVC削除・Blazor統一</parameter>
<parameter name="subagent_type">csharp-web-ui</parameter>
<parameter name="prompt">実装内容...</parameter>
</invoke>
<invoke name="Task">
<parameter name="description">Program.cs設定削除</parameter>
<parameter name="subagent_type">csharp-infrastructure</parameter>
<parameter name="prompt">実装内容...</parameter>
</invoke>
<invoke name="Task">
<parameter name="description">エラーハンドリング統一</parameter>
<parameter name="subagent_type">contracts-bridge</parameter>
<parameter name="prompt">実装内容...</parameter>
</invoke>

### F#コード実装時のSubAgent選択ルール
```markdown
## SubAgent選択ガイドライン
- F# Domain層 → fsharp-domain
- F# Application層 → fsharp-application  
- F#/C#境界 → contracts-bridge
- C# Infrastructure層 → csharp-infrastructure
- C# Web UI層 → csharp-web-ui
```

### 実行記録必須項目
- SubAgent実行方式記録（直列/並列）
- SubAgent選択理由記録
- 実際の所要時間記録（計画vs実績）

---

## 🔧 エラー修正時の責務分担原則（ADR_016準拠）

### 基本原則（タイミング問わず）
**「エラーが発生した場所」ではなく「エラーの内容」で責務を判定**

### 🔴 メインエージェント必須遵守事項
```markdown
## MainAgent責務（厳密定義）

### 実行可能な作業
✅ 全体調整・オーケストレーション
✅ SubAgentへの作業委託・指示
✅ 品質確認・統合テスト実行
✅ プロセス管理・進捗管理
✅ ドキュメント統合・レポート作成

### 🔴 禁止事項（例外を除く）
❌ 実装コードの直接修正
❌ ビジネスロジックの追加・変更
❌ 型変換ロジックの実装
❌ テストコードの作成・修正
❌ データベーススキーマの変更

### 例外（直接修正可能）
- 単純なtypo（1-2文字）
- import文の追加のみ
- コメントの追加・修正
- 空白・インデントの調整
```

### エラー修正の責務判定フロー（必須実行）
```markdown
## 🔴 エラー発生時の必須対応手順

1. **エラー内容を分析**
   - エラーメッセージの詳細確認
   - 影響範囲・修正対象の特定
   - 修正規模の判定（小/中/大）

2. **責務マッピングで SubAgent 選定**
   - F# Domain層のロジック → fsharp-domain
   - F# Application層のユースケース → fsharp-application
   - F#↔C#境界・型変換 → contracts-bridge
   - C# Infrastructure層・DB関連 → csharp-infrastructure
   - Blazor UI・フロントエンド → csharp-web-ui
   - テストコード → unit-test / integration-test

3. **修正規模による判定**
   - 小規模（1-3行）でも対象SubAgentに委託
   - 中規模（4-10行）は必ずSubAgent実行
   - 大規模（10行以上）は設計見直し含めてSubAgent実行

4. **SubAgent修正実行**
   - Fix-Mode（軽量実行）での修正委託
   - 修正完了後の品質確認
   - 統合テスト・ビルド確認
```

### SubAgent再実行判断基準
```markdown
## 🔴 SubAgent再実行必須判定

### 必ずSubAgent実行（効率性より責務遵守）
- 新規メソッド・関数の追加
- ロジック・アルゴリズムの変更
- 型定義・インターフェースの変更
- 5行以上の修正
- 複数ファイルにまたがる修正
- ビジネスルール・制約の追加

### 価値の優先順位
1. 責務境界の遵守
2. プロセスの一貫性
3. 追跡可能性・品質保証
4. 効率性・時間短縮
```

### Fix-Mode（軽量修正モード）
```markdown
## エラー修正専用軽量実行

### 使用条件
- 特定エラーの修正のみ
- 影響範囲が明確
- 新規機能追加なし

### 実行方法
Task tool実行時に修正内容を限定指定：
"contracts-bridge Agent, Fix-Mode: TypeConverters.cs Option型変換エラー修正"

### 期待効果
- 実行時間: 1-3分（通常の1/3）
- 修正精度: 専門SubAgentによる高品質修正
- 責務遵守: 境界違反の防止
```

---

## 🧠 Context管理・セッション継続判断基準（2025-10-13追加）

### AutoCompact buffer理解

**AutoCompact buffer**: Claude Code v2.0（2025年9月29日）で導入された、コンテキストウィンドウ管理のための**45,000トークン（全体の22.5%）の予約領域**

**主要な役割**:
- Claudeの応答生成のための余裕空間確保
- AutoCompact（自動圧縮）処理のためのワーキングスペース
- コンテキスト限界到達による会話中断の防止
- v2.0での改善: 重要情報の保持精度向上（improved retention accuracy）

**動作メカニズム**:
```yaml
トリガー条件:
  - コンテキスト使用率が約95%到達時（残り約25%）
  - 手動トリガー: /compact コマンド

処理フロー:
  1. 会話履歴の分析（重要情報の識別）
  2. 簡潔な要約の生成（キーとなる決定事項・コード変更を保持）
  3. 古いメッセージの圧縮（探索的議論・解決済みデバッグを削除）
  4. 45kトークンのバッファで次の応答生成余裕を確保

保持される情報:
  ✅ コード変更・プロジェクト構造
  ✅ 進行中タスク・設定
  ✅ 重要な技術決定・ADR記録
  ❌ 探索的議論・冗長な説明
  ❌ 解決済みデバッグセッション
```

**既知の問題**（2025年10月時点）:
- Issue #8479: `/context`表示でバッファが二重カウント（実際の空き容量が不正確）
- Issue #6123: 早期トリガー問題（8-12%使用時点で誤発動）
- Issue #2283: 特定条件下での無限ループ

---

### セッション継続/終了判断フロー

#### 🔴 新しい判断基準（2025-10-13策定）

```yaml
継続判断（AutoCompact活用）:
  条件（すべて満たす場合）:
    - Context使用率 < 80% (160k/200k未満)
    - 実装作業中（Step実行中）
    - 重要な技術決定が完了している

  実施事項:
    - 60分毎に /context でContext使用状況確認
    - AutoCompactの改善された保持精度を信頼
    - 作業の連続性を維持

  利点:
    - セッション分割のオーバーヘッド削減
    - SubAgent並列実行の効率維持
    - v2.0の改善された保持精度活用

手動compact判断:
  条件:
    - 80% ≤ Context使用率 < 85% (160k-170k)

  実施事項:
    - /compact コマンドを手動実行
    - 制御可能なタイミングでの圧縮
    - 重要情報の明示的保持確認

終了判断（セッション分割推奨）:
  条件（いずれか満たす場合）:
    - Phase/Step境界
    - 重要な技術決定直後
    - Context使用率 ≥ 85% (170k/200k超)

  理由:
    - ADR_016プロセス遵守確認の完全性
    - 成果物の物理的存在確認完了
    - 次セッションで新鮮なContextで開始
```

#### 📊 実践的な運用方針

**セッション中の定期確認**:
```bash
# 60分毎（または大きな作業の区切り毎）
/context

# 使用率に応じた判断
if context < 80%:
    # 継続（AutoCompact信頼）
    継続作業
elif 80% <= context < 85%:
    # 手動compact検討
    /compact  # 任意のタイミングで手動圧縮
else:  # context >= 85%
    # Phase/Step境界で終了判断
    セッション終了準備
```

**Context使用率の計算**:
```yaml
表示上のContext:
  Total: 200k tokens
  Used: XXXk tokens
  AutoCompact buffer: 45k tokens (22.5%)
  Free space: YYYk tokens

実際の使用可能空間:
  200k - 45k (reserved) = 155k tokens

実際の使用率:
  (Used tokens / 155k) × 100%

注意: Issue #8479により表示が不正確な可能性
→ 実際の余裕は表示より大きい場合あり
```

**Phase/Step境界での戦略**:
```markdown
## Phase/Step完了時の推奨手順

### Option A: 手動compactで継続（Context < 70%の場合）
1. /compact 実行
2. 成果物の物理的存在確認
3. ADR_016プロセス遵守チェック完了
4. 次Step継続

### Option B: セッション終了（Context ≥ 70%の場合）
1. session-end Command実行
2. Serenaメモリー更新完了
3. 次セッションで新鮮なContext開始
```

---

### リスク管理とADR_016整合性

#### ⚠️ AutoCompact使用時のリスク

**1. 重要コンテキストの喪失リスク**
```yaml
リスク:
  - AutoCompactが「探索的議論」と判断した内容が
    実は重要な技術決定だった場合

対策:
  ✅ 重要決定はADRとして文書化（既存ルール適合）
  ✅ Step完了時に組織設計.mdに明示的記録
  ✅ Phase_Summary.mdへの重要決定の永続化
```

**2. SubAgent成果物の虚偽報告リスク（ADR_016関連）**
```yaml
リスク:
  - AutoCompact後、SubAgentの作業記録が圧縮され
    MainAgentが成果物の実体確認を怠る可能性

対策:
  🔴 Step完了時の必須チェックリスト実行
  🔴 成果物ファイルの物理的存在確認（必須）
  🔴 報告内容と実体ファイルの完全一致確認
```

**3. CLAUDE.mdルールの圧縮リスク**
```yaml
リスク:
  - プロジェクト固有のルール・制約が圧縮される可能性

対策:
  ✅ セッション開始時の明示的な参照
  ✅ 重要ルールの定期的な再確認
  ✅ CLAUDE.mdは Memory files として常に参照
```

**4. Phase/Step手順書の圧縮リスク**
```yaml
リスク:
  - .claude/commands/ 配下のCommandsが圧縮される可能性

対策:
  ✅ 各Command実行時に最新版を再読み込み
  ✅ Command実行前の明示的な読み込み確認
```

#### ✅ ADR_016準拠のための追加チェック

**AutoCompact使用時の必須確認事項**:
```markdown
## 🔴 AutoCompact後の必須確認（ADR_016準拠）

### Phase/Step境界での確認
- [ ] プロセス遵守チェックリストの再確認完了
- [ ] SubAgent成果物の物理的存在確認完了
- [ ] 承認記録の明示的確認完了
- [ ] 成果物と報告内容の完全一致確認完了

### 技術決定の保持確認
- [ ] ADR記録の最新性確認
- [ ] Phase_Summary.mdの重要決定記録確認
- [ ] 組織設計.mdの実行記録確認

### プロジェクトルールの再確認
- [ ] CLAUDE.md の重要ルール再確認
- [ ] 適用中のCommand定義の再読み込み
```

---

### 関連リソース

**公式ドキュメント**:
- Claude Code Overview: https://docs.claude.com/en/docs/claude-code/overview
- Claude Code Best Practices: https://www.anthropic.com/engineering/claude-code-best-practices

**コミュニティリソース**:
- ClaudeLog - AutoCompact FAQ: https://claudelog.com/faqs/what-is-claude-code-auto-compact/
- Context管理ガイド: https://mcpcat.io/guides/managing-claude-code-context/

**GitHub Issues（重要な議論）**:
- Issue #42 (AutoCompact導入議論): https://github.com/anthropics/claude-code/issues/42
- Issue #8479 (Buffer二重カウント): https://github.com/anthropics/claude-code/issues/8479

**プロジェクト内参照**:
- `/Doc/07_Decisions/ADR_016_プロセス遵守違反防止策.md`
- `/Doc/08_Organization/Rules/ファイル管理規約.md`
- `/.claude/commands/session-start.md`
- `/.claude/commands/session-end.md`

---

**更新履歴**:
- 2025-10-13 Context管理・セッション継続判断基準追加（AutoCompact buffer理解・リスク管理）
- 2025-09-28 エラー修正時の責務分担原則追加（Step2実行改善・ADR_016準拠）
- 2025-08-20 SubAgent並列実行・選択ガイド強化（Phase A7 Step2経験反映）
- 2025-08-09 SubAgent化による大幅簡略化（詳細プロセスはSubAgent定義に移管）
- 2025-08-09 Command実行体制統合（Commands化完了・実行指示追加）