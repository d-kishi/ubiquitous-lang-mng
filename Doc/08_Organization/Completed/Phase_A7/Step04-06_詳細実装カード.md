# Phase A7 Step4-6: 完成・統合・品質保証 - 詳細実装カード

# 📋 Step4: Contracts層・型変換完全実装

## Step4概要
- **Step名**: Contracts層・型変換完全実装
- **所要時間**: 90-120分  
- **重要度**: 中（F#/C#境界完全実装）
- **SubAgent**: contracts-bridge・fsharp-domain

## 🎯 対応課題一覧

### 課題1: TypeConverter実装不完全
- **問題**: F#↔C#型変換の一部未実装
- **影響**: 今後の機能拡張時の制約
- **証跡**: Contracts層の部分実装

### 課題2: FirstLoginRedirectMiddleware混在制御
- **問題**: /change-password期待vs/Account/ChangePassword実装不整合
- **影響**: 認証フローの一貫性欠如
- **証跡**: RedirectUrl = "/change-password" vs 実際パス不整合

## 🛠️ 詳細実装タスク

### タスク1: TypeConverter完全実装

#### UbiquitousLanguageTypeConverter実装
```
パス: src/UbiquitousLanguageManager.Contracts/TypeConverters/UbiquitousLanguageTypeConverter.cs
```

```csharp
using UbiquitousLanguageManager.Domain.Entities;
using UbiquitousLanguageManager.Contracts.DTOs.UbiquitousLanguage;

public class UbiquitousLanguageTypeConverter
{
    /// Domain → DTO 変換
    public static UbiquitousLanguageDto ToDto(UbiquitousLanguage domain)
    {
        return new UbiquitousLanguageDto
        {
            Id = domain.Id.Value,
            Term = domain.Term.Value,
            Definition = domain.Definition.Value,
            Context = domain.Context?.Value,
            ProjectId = domain.ProjectId.Value,
            DomainId = domain.DomainId?.Value,
            CreatedAt = domain.CreatedAt,
            UpdatedAt = domain.UpdatedAt
        };
    }

    /// DTO → Domain 変換
    public static Result<UbiquitousLanguage, string> FromDto(UbiquitousLanguageDto dto)
    {
        try
        {
            var id = UbiquitousLanguageId.Create(dto.Id);
            var term = Term.Create(dto.Term);
            var definition = Definition.Create(dto.Definition);
            var projectId = ProjectId.Create(dto.ProjectId);
            
            var context = string.IsNullOrEmpty(dto.Context) 
                ? null 
                : Context.Create(dto.Context);
                
            var domainId = dto.DomainId.HasValue 
                ? DomainId.Create(dto.DomainId.Value) 
                : null;

            return Result.Ok(UbiquitousLanguage.Create(
                id, term, definition, context, projectId, domainId,
                dto.CreatedAt, dto.UpdatedAt));
        }
        catch (Exception ex)
        {
            return Result.Error($"UbiquitousLanguage変換エラー: {ex.Message}");
        }
    }
}
```

#### ProjectTypeConverter実装
```
パス: src/UbiquitousLanguageManager.Contracts/TypeConverters/ProjectTypeConverter.cs
```

```csharp
public class ProjectTypeConverter
{
    public static ProjectDto ToDto(Project domain)
    {
        return new ProjectDto
        {
            Id = domain.Id.Value,
            Name = domain.Name.Value,
            Description = domain.Description?.Value,
            CreatedAt = domain.CreatedAt,
            UpdatedAt = domain.UpdatedAt
        };
    }

    public static Result<Project, string> FromDto(ProjectDto dto)
    {
        try
        {
            var id = ProjectId.Create(dto.Id);
            var name = ProjectName.Create(dto.Name);
            var description = string.IsNullOrEmpty(dto.Description) 
                ? null 
                : ProjectDescription.Create(dto.Description);

            return Result.Ok(Project.Create(id, name, description, 
                dto.CreatedAt, dto.UpdatedAt));
        }
        catch (Exception ex)
        {
            return Result.Error($"Project変換エラー: {ex.Message}");
        }
    }
}
```

#### DomainTypeConverter実装
```
パス: src/UbiquitousLanguageManager.Contracts/TypeConverters/DomainTypeConverter.cs
```

```csharp
public class DomainTypeConverter
{
    public static DomainDto ToDto(Domain domain)
    {
        return new DomainDto
        {
            Id = domain.Id.Value,
            Name = domain.Name.Value,
            Description = domain.Description?.Value,
            ProjectId = domain.ProjectId.Value,
            CreatedAt = domain.CreatedAt,
            UpdatedAt = domain.UpdatedAt
        };
    }

    public static Result<Domain, string> FromDto(DomainDto dto)
    {
        try
        {
            var id = DomainId.Create(dto.Id);
            var name = DomainName.Create(dto.Name);
            var projectId = ProjectId.Create(dto.ProjectId);
            var description = string.IsNullOrEmpty(dto.Description) 
                ? null 
                : DomainDescription.Create(dto.Description);

            return Result.Ok(Domain.Create(id, name, description, projectId,
                dto.CreatedAt, dto.UpdatedAt));
        }
        catch (Exception ex)
        {
            return Result.Error($"Domain変換エラー: {ex.Message}");
        }
    }
}
```

### タスク2: FirstLoginRedirectMiddleware統合

#### Middleware修正
```
パス: src/UbiquitousLanguageManager.Web/Middleware/FirstLoginRedirectMiddleware.cs
```

```csharp
// 修正前（不整合）
private const string ChangePasswordPath = "/Account/ChangePassword";

// 修正後（Blazor統一）
private const string ChangePasswordPath = "/change-password";

public async Task InvokeAsync(HttpContext context)
{
    if (context.User.Identity?.IsAuthenticated == true)
    {
        var user = await _userManager.GetUserAsync(context.User);
        
        // 初回ログイン判定（パスワード変更が必要）
        if (user?.RequirePasswordChange == true && 
            !context.Request.Path.StartsWithSegments(ChangePasswordPath))
        {
            context.Response.Redirect(ChangePasswordPath);
            return;
        }
    }

    await _next(context);
}
```

## 🎯 Step4完了確認項目
- [ ] 全TypeConverter実装完了・単体テスト成功
- [ ] FirstLoginRedirectMiddleware→/change-password正常リダイレクト
- [ ] 初回ログインフロー完全動作確認
- [ ] F#↔C#型変換エラーなし

---

# 📋 Step5: UI機能完成・用語統一

## Step5概要  
- **Step名**: UI機能完成・用語統一
- **所要時間**: 120-150分
- **重要度**: 中（UI設計書完全準拠）
- **SubAgent**: csharp-web-ui・spec-compliance・code-review

## 🎯 対応課題一覧

### 課題1: [UI-001] プロフィール変更画面未実装
- **問題**: UI設計書3.2節要求機能の未実装
- **影響**: ユーザー管理機能完成度
- **証跡**: 対応ページなし

### 課題2: [TERM-001] 用語統一完全性  
- **問題**: ADR_003「ユビキタス言語」統一の部分的適用
- **影響**: プロジェクト用語一貫性
- **証跡**: 一部コードで「用語」表記残存

## 🛠️ 詳細実装タスク

### タスク1: プロフィール変更画面実装

#### ファイル作成
```
パス: src/UbiquitousLanguageManager.Web/Pages/Auth/Profile.razor
```

#### 実装内容
```razor
@page "/profile"
@layout MainLayout
@using UbiquitousLanguageManager.Contracts.DTOs.Authentication
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>プロフィール設定</PageTitle>

<div class="container">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">プロフィール設定</h3>
                </div>
                <div class="card-body">
                    <EditForm Model="@model" OnValidSubmit="@HandleSubmit">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label for="email" class="form-label">メールアドレス</label>
                            <InputText id="email" class="form-control" 
                                      @bind-Value="model.Email" readonly />
                            <div class="form-text">メールアドレスは変更できません</div>
                        </div>

                        <div class="mb-3">
                            <label for="userName" class="form-label">ユーザー名</label>
                            <InputText id="userName" class="form-control" 
                                      @bind-Value="model.UserName" />
                            <ValidationMessage For="@(() => model.UserName)" />
                        </div>

                        <div class="mb-3">
                            <label for="firstName" class="form-label">姓</label>
                            <InputText id="firstName" class="form-control" 
                                      @bind-Value="model.FirstName" />
                            <ValidationMessage For="@(() => model.FirstName)" />
                        </div>

                        <div class="mb-3">
                            <label for="lastName" class="form-label">名</label>
                            <InputText id="lastName" class="form-control" 
                                      @bind-Value="model.LastName" />
                            <ValidationMessage For="@(() => model.LastName)" />
                        </div>

                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success">@successMessage</div>
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                更新
                            </button>
                            <a href="/change-password" class="btn btn-outline-secondary">
                                パスワード変更
                            </a>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">アカウント情報</h4>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-6">ロール</dt>
                        <dd class="col-sm-6">@currentUserRole</dd>
                        <dt class="col-sm-6">作成日</dt>
                        <dd class="col-sm-6">@createdAt?.ToString("yyyy/MM/dd")</dd>
                        <dt class="col-sm-6">最終ログイン</dt>
                        <dd class="col-sm-6">@lastLogin?.ToString("yyyy/MM/dd HH:mm")</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private ProfileUpdateDto model = new();
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;
    private bool isProcessing = false;
    private string currentUserRole = string.Empty;
    private DateTime? createdAt;
    private DateTime? lastLogin;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user != null)
        {
            model = new ProfileUpdateDto
            {
                Email = user.Email ?? string.Empty,
                UserName = user.UserName ?? string.Empty,
                FirstName = user.FirstName ?? string.Empty,
                LastName = user.LastName ?? string.Empty
            };

            var roles = await UserManager.GetRolesAsync(user);
            currentUserRole = roles.FirstOrDefault() ?? "一般ユーザー";
            createdAt = user.CreatedAt;
            lastLogin = user.LastLogin;
        }
    }

    private async Task HandleSubmit()
    {
        isProcessing = true;
        successMessage = string.Empty;
        errorMessage = string.Empty;

        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = await UserManager.GetUserAsync(authState.User);

            if (user != null)
            {
                user.UserName = model.UserName;
                user.FirstName = model.FirstName;
                user.LastName = model.LastName;

                var result = await UserManager.UpdateAsync(user);

                if (result.Succeeded)
                {
                    successMessage = "プロフィールを正常に更新しました。";
                }
                else
                {
                    errorMessage = string.Join(", ", result.Errors.Select(e => e.Description));
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = "プロフィール更新中にエラーが発生しました。";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }
}
```

#### ProfileUpdateDto実装
```
パス: src/UbiquitousLanguageManager.Contracts/DTOs/Authentication/ProfileUpdateDto.cs
```

```csharp
public class ProfileUpdateDto
{
    [Required(ErrorMessage = "メールアドレスは必須です")]
    [EmailAddress(ErrorMessage = "有効なメールアドレスを入力してください")]
    public string Email { get; set; } = string.Empty;

    [Required(ErrorMessage = "ユーザー名は必須です")]
    [StringLength(50, ErrorMessage = "ユーザー名は50文字以内で入力してください")]
    public string UserName { get; set; } = string.Empty;

    [StringLength(50, ErrorMessage = "姓は50文字以内で入力してください")]
    public string FirstName { get; set; } = string.Empty;

    [StringLength(50, ErrorMessage = "名は50文字以内で入力してください")]
    public string LastName { get; set; } = string.Empty;
}
```

### タスク2: 用語統一完全実装

#### 対象ファイルの用語置換
```bash
# 検索・置換対象の例
"用語" → "ユビキタス言語"
"Term" → "UbiquitousLanguage" (適切な文脈で)
"語彙" → "ユビキタス言語"
"専門用語" → "ユビキタス言語"
```

#### 主要対象ファイル群
```
1. src/UbiquitousLanguageManager.Web/Pages/*.razor
2. src/UbiquitousLanguageManager.Web/Shared/*.razor
3. src/UbiquitousLanguageManager.Contracts/DTOs/*.cs
4. src/UbiquitousLanguageManager.Application/*.fs
5. README.md, CLAUDE.md等ドキュメント
```

## 🎯 Step5完了確認項目
- [ ] /profile 画面正常表示・更新機能動作
- [ ] UI設計書3.2節完全準拠
- [ ] 全コード内「ユビキタス言語」統一完了
- [ ] ADR_003完全準拠確認

---

# 📋 Step6: 統合品質保証・完了確認

## Step6概要
- **Step名**: 統合品質保証・完了確認
- **所要時間**: 60-90分
- **重要度**: 高（Phase A7完了判定）
- **SubAgent**: spec-compliance・integration-test・code-review

## 🎯 対応課題一覧

### 課題1: テスト依存関係（MEDIUM）
- **問題**: MvcBlazorRoutingIntegrationTests → HomeController依存
- **影響**: MVC削除時のテスト失敗
- **証跡**: テストでHomeController参照

### 課題2: TECH-003大部分解決済み確認
- **問題**: 重複ログイン画面削除状況の最終確認
- **影響**: 技術負債完全解決確認
- **証跡**: Login.razor のみ存在確認済み

## 🛠️ 詳細実装タスク

### タスク1: テスト更新・統合テスト実施

#### MVC関連テスト削除・更新
```
削除対象:
src/UbiquitousLanguageManager.Tests/Integration/MvcBlazorRoutingIntegrationTests.cs

代替実装:
src/UbiquitousLanguageManager.Tests/Integration/BlazorRoutingIntegrationTests.cs
```

#### Blazor専用統合テスト実装
```csharp
[TestClass]
public class BlazorRoutingIntegrationTests
{
    [TestMethod]
    public async Task RootPath_UnauthenticatedUser_RedirectsToLogin()
    {
        // / → /login リダイレクトテスト
    }

    [TestMethod]  
    public async Task RootPath_AuthenticatedUser_RedirectsToAdmin()
    {
        // / → /admin/users リダイレクトテスト
    }

    [TestMethod]
    public async Task ChangePasswordPath_AuthenticatedUser_DisplaysBlazorPage()
    {
        // /change-password Blazor画面表示テスト
    }

    [TestMethod]
    public async Task ProfilePath_AuthenticatedUser_DisplaysBlazorPage()
    {
        // /profile Blazor画面表示テスト
    }
}
```

### タスク2: 仕様準拠最終監査

#### 要件準拠確認項目
- [ ] **Pure Blazor Server**: MVC要素0件
- [ ] **Clean Architecture**: 5層構造維持
- [ ] **認証システム**: ASP.NET Core Identity完全統合
- [ ] **URL設計**: 100%Blazor形式統一

#### 品質指標確認
- [ ] **総合仕様準拠度**: 90%以上達成
- [ ] **アーキテクチャ品質**: 85/100以上達成  
- [ ] **Web層品質**: 80/100以上達成

### タスク3: GitHub Issues最終確認

#### Issue #5 [COMPLIANCE-001] 完了確認
- [ ] Phase A1-A6成果の要件準拠監査完了
- [ ] 発見された全要件逸脱の解消完了
- [ ] 品質監査プロセス確立

#### Issue #6 [ARCH-001] 完了確認  
- [ ] MVC/Blazor混在アーキテクチャ完全解消
- [ ] Pure Blazor Serverアーキテクチャ実現
- [ ] 要件逸脱完全解消

### タスク4: 技術負債完全解決確認

#### TECH-003: ログイン画面重複
- [ ] MVC版ログイン画面完全削除
- [ ] Login.razorのみ存在確認
- [ ] 認証フロー統一確認

#### TECH-004: 初回ログインパスワード変更  
- [ ] /change-password実装完了
- [ ] FirstLoginRedirectMiddleware統合完了
- [ ] 初回ログインフロー完全動作

#### TECH-005: MVC/Blazor混在
- [ ] MVC要素完全削除
- [ ] Pure Blazor Server実現
- [ ] アーキテクチャ統一完了

## 🎯 Step6完了確認項目

### 機能完全動作確認  
- [ ] 新規ユーザー登録→初回ログイン→パスワード変更→管理画面アクセス
- [ ] 既存ユーザーログイン→プロフィール変更→ログアウト
- [ ] 全認証フロー・全画面正常動作

### 品質・性能確認
- [ ] `dotnet build` 0 Warning, 0 Error
- [ ] `dotnet test` 全テスト成功
- [ ] 認証応答時間 <500ms
- [ ] SignalR接続安定性確認

### Phase A7目標達成確認
- [ ] **要件準拠90%以上**: 全要件逸脱解消
- [ ] **Clean Architecture完全準拠**: Pure Blazor Server実現  
- [ ] **UI設計書100%準拠**: 8画面完全実装
- [ ] **GitHub Issues完全解決**: #5・#6クローズ可能

---

**各Step実装担当**: 指定SubAgents  
**Phase A7完了**: Step6完了承認後  
**次Phase**: Phase B1（プロジェクト管理機能実装）準備完了