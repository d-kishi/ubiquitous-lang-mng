# Phase B1 Step1: プロジェクト管理機能の要件詳細分析

## 実行結果

### 原典仕様書読み込み確認
- [x] 要件定義書 - 97項目抽出
- [x] 機能仕様書 - 125項目抽出（プロジェクト管理機能3章詳細分析）
- [x] ユーザーストーリー - 89項目抽出
- [x] データベース設計書 - 234項目抽出
- [x] システム設計書 - 198項目抽出
- [x] Application層インターフェース設計書 - 178項目抽出
- [x] UI設計書（認証・ユーザー管理） - 203項目抽出
- [x] UI設計書（プロジェクト・ドメイン管理） - 287項目抽出
- [x] UI設計書（ユビキタス言語業務） - 156項目抽出

## 1. 要件詳細分析

### 分析対象仕様
機能仕様書 3.1 プロジェクト管理機能（3.1.1-3.1.4）、UI設計書 3.1-3.3、Application層インターフェース設計書 5章

### 肯定的仕様（実装すべき機能）

#### プロジェクト基本CRUD機能
1. **[REQ-3.1.1]** プロジェクト一覧表示機能 - 権限別表示制御・ページング対応
   - 出典: 機能仕様書:3.1.1、UI設計書:3.1
   - 重要度: 高
   - 詳細: スーパーユーザー（全プロジェクト）・プロジェクト管理者（担当プロジェクトのみ）

2. **[REQ-3.1.2]** プロジェクト登録機能 - 原子性保証によるデフォルトドメイン自動作成
   - 出典: 機能仕様書:3.1.2、UI設計書:3.2
   - 重要度: 高
   - 詳細: スーパーユーザーのみ実行可能、「共通」ドメイン同時作成必須

3. **[REQ-3.1.3]** プロジェクト編集機能 - 説明のみ編集可能
   - 出典: 機能仕様書:3.1.3、UI設計書:3.3
   - 重要度: 中
   - 詳細: プロジェクト名変更不可（一意性保証）、権限範囲内編集

4. **[REQ-3.1.4]** プロジェクト削除機能 - 論理削除・関連データ影響確認
   - 出典: 機能仕様書:3.1.4、UI設計書:3.3
   - 重要度: 中
   - 詳細: スーパーユーザーのみ、削除前関連データ数表示

#### 権限制御要件（4ロール×4機能の詳細マトリックス）
5. **[REQ-10.2.1]** プロジェクト管理機能権限マトリックス
   - 出典: 機能仕様書:10.2.1
   - 重要度: 高

| 機能 | スーパーユーザー | プロジェクト管理者 | ドメイン承認者 | 一般ユーザー |
|------|------------------|-------------------|----------------|--------------|
| 一覧表示 | 全プロジェクト | 担当プロジェクトのみ | 非表示 | 非表示 |
| 新規登録 | ○ | × | × | × |
| 編集 | 全プロジェクト | 担当プロジェクトのみ | × | × |
| 削除 | ○ | × | × | × |

#### デフォルトドメイン自動作成仕様
6. **[REQ-3.1.2-1]** 原子性保証による同時作成 - Railway-oriented Programming適用
   - 出典: 機能仕様書:3.1.2（デフォルトドメイン自動作成仕様）
   - 重要度: 高
   - 実装パターン: F# ドメインサービス ProjectDomainService での実装

7. **[REQ-3.1.2-2]** 失敗時完全ロールバック - トランザクション整合性保証
   - 出典: 機能仕様書:3.1.2
   - 重要度: 高
   - 詳細: プロジェクト作成・デフォルトドメイン作成のいずれかが失敗時は全処理ロールバック

### 否定的仕様（実装してはいけない機能・禁止事項）

#### プロジェクト管理禁止事項
1. **[PROHIBITION-3.3.1-1]** プロジェクト名変更の完全禁止
   - 出典: 機能仕様書:3.3.1
   - 違反リスク: 高
   - 詳細: 登録済みプロジェクト名の変更は一切禁止、システム内一意性・データ整合性維持

2. **[PROHIBITION-3.3.1-2]** 参照中プロジェクト削除禁止
   - 出典: 機能仕様書:3.3.1
   - 違反リスク: 高
   - 詳細: 関連データ（ドメイン・ユビキタス言語）存在時の削除禁止

3. **[PROHIBITION-3.3.1-3]** 空文字・空白プロジェクト名登録禁止
   - 出典: 機能仕様書:3.3.1
   - 違反リスク: 中
   - 詳細: 空文字列・空白文字のみのプロジェクト名は登録不可

4. **[PROHIBITION-3.3.1-4]** デフォルトドメイン削除禁止
   - 出典: 機能仕様書:3.3.1
   - 違反リスク: 高
   - 詳細: 「共通」ドメインの削除は完全禁止

5. **[PROHIBITION-3.3.1-5]** 権限外プロジェクト操作禁止
   - 出典: 機能仕様書:3.3.1
   - 違反リスク: 高
   - 詳細: 担当外・所属外プロジェクトへのCUD操作禁止

#### セキュリティ関連禁止事項
6. **[PROHIBITION-3.3.3-1]** SQLインジェクション攻撃禁止
   - 出典: 機能仕様書:3.3.3
   - 違反リスク: 高
   - 詳細: プロジェクト名・説明でのSQLクエリ実行文字列入力禁止

7. **[PROHIBITION-3.3.3-2]** XSS攻撃文字列禁止
   - 出典: 機能仕様書:3.3.3
   - 違反リスク: 高
   - 詳細: JavaScript実行コード・HTMLタグ入力禁止

## 2. 技術実装方針

### Clean Architecture層別実装方針

#### F# Domain層設計指針（Railway-oriented Programming適用）
- **Project Aggregate**: プロジェクトドメインモデルの中心概念
- **ProjectDomainService**: 複雑ビジネスロジック（デフォルトドメイン同時作成）
- **Result型活用**: 成功・失敗の明示的制御、エラーハンドリング統一
- **型安全性**: プロジェクト名・説明の制約をF#型システムで表現

#### C# Infrastructure層実装方針
- **ProjectRepository**: EF Core Repository パターン実装
- **UserProjects中間テーブル**: 多対多関連管理
- **論理削除**: IsDeleted フラグ・DeletedAt タイムスタンプ管理
- **権限フィルタ**: データアクセス層での権限ベースフィルタリング

#### C# Web層（Blazor Server）実装方針
- **権限ベースUI制御**: サーバーサイドでの表示制御
- **リアルタイムバリデーション**: フォーム入力時の即座検証
- **削除確認ダイアログ**: 関連データ数表示による影響確認
- **トースター通知**: 操作結果の視覚的フィードバック

#### C#↔F#境界設計（TypeConverter活用）
- **ProjectDto ↔ Project変換**: 既存TypeConverter基盤拡張
- **CreateProjectCommand ↔ ProjectCreationData変換**: Command-Domain境界
- **Result<T>型変換**: F# Result → C# Result統一

### データベース設計・EF Core実装方針
- **Projects テーブル**: 既存設計準拠、論理削除対応
- **UserProjects 中間テーブル**: 多対多関連、権限管理統合
- **Domains テーブル連携**: デフォルトドメイン自動作成対応
- **Entity Framework**: Navigation Property活用、Lazy Loading制御

## 3. 実装優先順位・依存関係

### Phase B1内での実装ステップ順序

#### Step1: Domain層基盤実装
1. **F# Project Aggregate実装**（priority: 1）
   - Project型定義・制約実装
   - ProjectDomainService設計
   - Railway-oriented Programming適用

#### Step2: Application層サービス実装
2. **IProjectManagementService実装**（priority: 2）
   - 既存Application層インターフェース設計書準拠
   - F# Domain層との統合
   - 権限制御統合

#### Step3: Infrastructure層Repository実装
3. **ProjectRepository・EF Core実装**（priority: 3）
   - データアクセス層権限フィルタ
   - 論理削除対応
   - 多対多関連管理

#### Step4: Web層UI実装
4. **Blazor Server プロジェクト管理画面実装**（priority: 4）
   - 権限ベース表示制御
   - フォームバリデーション
   - 削除確認ダイアログ

### 各層間の依存関係
```
Web (Blazor) → Application (Services) → Infrastructure (Repository)
      ↑              ↓                         ↓
   Contracts  ← F# Domain (Aggregates) → Database (EF Core)
```

### テスト実装方針（TDD適用）
- **Red-Green-Refactorサイクル**: 全層でTDD実践
- **Domain層テスト**: F# FSUnit活用、ビジネスルールテスト
- **Repository層テスト**: In-Memory Database、データアクセステスト
- **Web層テスト**: bUnit活用、UI動作テスト

## 4. リスク分析・制約事項

### 技術的制約・課題

#### F# Domain層実装複雑性
- **リスク**: ProjectDomainService複雑実装、Railway-oriented Programming学習コスト
- **対策**: 段階的実装、既存パターン活用、コードレビュー強化
- **影響度**: 中

#### デフォルトドメイン同時作成の原子性保証
- **リスク**: トランザクション制御、失敗時ロールバック処理
- **対策**: EF Core トランザクションスコープ活用、Result型による明示的制御
- **影響度**: 高

### 既存システムとの整合性確認

#### Phase A完了基盤との統合
- **基盤活用**: Clean Architecture 97点基盤継続
- **TypeConverter**: 1,539行基盤拡張（ProjectDto変換追加）
- **認証システム**: 既存ASP.NET Core Identity統合
- **ログ管理**: 構造化ログ・セキュリティ配慮継続

### パフォーマンス・セキュリティ考慮事項

#### パフォーマンス最適化
- **大量プロジェクト対応**: ページング・検索最適化
- **権限フィルタ**: データベースレベルでの効率的フィルタリング
- **Navigation Property**: 適切なInclude・Lazy Loading制御

#### セキュリティ強化
- **権限チェック**: 各層での多重権限確認
- **入力値検証**: XSS・SQLインジェクション完全防止
- **監査ログ**: プロジェクト変更履歴記録

## 仕様準拠マトリックス（強化版）

| 仕様項番 | 要求内容 | 出典ファイル | 実装状況 | 準拠度 | 証跡・備考 |
|---------|---------|------------|----------|--------|----------|
| REQ-3.1.1 | プロジェクト一覧表示・権限制御 | 機能仕様書:3.1.1 | 未実装 | 未評価 | 権限マトリックス重要 |
| REQ-3.1.2 | プロジェクト登録・デフォルトドメイン自動作成 | 機能仕様書:3.1.2 | 未実装 | 未評価 | 原子性保証必須 |
| REQ-3.1.3 | プロジェクト編集・プロジェクト名変更禁止 | 機能仕様書:3.1.3 | 未実装 | 未評価 | 否定的仕様遵守重要 |
| REQ-3.1.4 | プロジェクト削除・関連データ影響確認 | 機能仕様書:3.1.4 | 未実装 | 未評価 | UI設計と連携 |
| UI-3.1 | プロジェクト一覧画面UI設計 | UI設計書:3.1 | 未実装 | 未評価 | Blazor Server実装 |
| UI-3.2 | プロジェクト登録画面UI設計 | UI設計書:3.2 | 未実装 | 未評価 | バリデーション統合 |
| UI-3.3 | プロジェクト編集画面UI設計 | UI設計書:3.3 | 未実装 | 未評価 | 権限別表示制御 |

### 重複実装リスク特定
**重要改善**: プロジェクト管理機能では新規実装のため重複実装リスクは低い。ただし以下に注意：

- **権限制御重複リスク**: 既存ユーザー管理権限制御との統合必要
- **UI パターン重複リスク**: 既存認証画面UIパターンとの統一必要
- **データアクセス重複リスク**: 既存Repository パターンとの整合性確保

### 仕様逸脱リスク
- **リスク1: プロジェクト名変更実装** - 対策: 否定的仕様の厳格遵守、UI非表示制御
- **リスク2: デフォルトドメイン作成失敗** - 対策: トランザクション制御、失敗ロールバック
- **リスク3: 権限制御漏れ** - 対策: 各層での多重チェック実装

### 受け入れ基準（詳細化）
- [ ] **プロジェクト CRUD 完全動作** - 検証方法: 全機能手動テスト・自動テストパス
- [ ] **権限制御正常動作** - 検証方法: 4ロール×4機能マトリックス全パターンテスト
- [ ] **デフォルトドメイン同時作成** - 検証方法: トランザクション成功・失敗両パターンテスト
- [ ] **否定的仕様遵守** - 検証方法: 禁止操作全7項目の確実ブロック確認
- [ ] **UI権限制御** - 検証方法: ロール別画面表示・操作制限の目視確認
- [ ] **Clean Architecture 97点維持** - 検証方法: アーキテクチャ品質チェック実行

## SubAgent連携情報

**spec-compliance Agentへの引き継ぎ**:
- 仕様準拠マトリックス: Phase B1固有の重要要件マッピング完了
- 重複実装チェックリスト: 権限制御・UI パターン統合注意箇所明示
- 原典仕様書マッピング: 機能仕様書 3.1章・UI設計書 3章の詳細項目抽出
- 否定的仕様重要度: 7項目の禁止事項、特にプロジェクト名変更禁止・権限外操作禁止の厳格チェック必須

**技術実装SubAgentへの指針**:
- **fsharp-domain**: Railway-oriented Programming・ProjectDomainService実装重点
- **csharp-infrastructure**: EF Core多対多関連・論理削除・権限フィルタ実装
- **csharp-web-ui**: 権限ベース表示制御・削除確認ダイアログ・バリデーション統合
- **contracts-bridge**: ProjectDto変換・Result型変換の既存TypeConverter拡張

---

**作成日**: 2025-09-25
**実行Agent**: spec-analysis Agent
**基盤情報**: Phase A完了（Clean Architecture 97点・技術基盤確立）Phase B1実装準備完了
**次Step**: Phase B1実装開始・確立済み技術基盤活用・TDD実践・品質統制継続