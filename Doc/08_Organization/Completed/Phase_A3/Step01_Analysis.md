# Phase A3 Step1: 技術分析・仕様確認・実装計画策定

**作成日**: 2025-07-24  
**実行期間**: 予定 60分  
**ステップ目標**: 認証機能拡張の技術的課題抽出・仕様完全理解・TDD実践計画確立

## 📋 仕様準拠マトリックス

### 認証機能拡張 - 実装対象機能

| 機能 | 仕様書項番 | 実装内容 | テスト設計 | 準拠状態 |
|------|------------|----------|-----------|----------|
| パスワードリセット機能 | 2.1.3 | メール送信・トークン生成・リセット処理 | リセットフロー全体の統合テスト | 🚧 |
| ログアウト機能 | 10.3.1 | セッション無効化・クリーンアップ | ログアウト後のアクセス制御テスト | 🚧 |
| Remember Me機能 | 2.1.1 | 自動ログイン（7日間有効） | 永続化Cookie・有効期限テスト | 🚧 |
| セッション管理強化 | 10.1.1 | タイムアウト2時間・固定攻撃対策 | タイムアウト・セッションID再生成テスト | 🚧 |

### 否定的仕様（実装してはいけない機能）

| 仕様内容 | 仕様書項番 | 検証方法 | 準拠状態 |
|----------|------------|----------|----------|
| ログイン失敗によるロックアウト機構は設けない | 2.1.1 | 複数回失敗後もログイン可能確認テスト | 🚧 |
| パスワード履歴管理なし（前回と同一禁止のみ） | 10.1.1 | 前々回のパスワードへの変更可能確認テスト | 🚧 |
| パスワード有効期限なし | - | 古いパスワードでのログイン継続確認テスト | 🚧 |

## 🎯 組織設計（TDD実践形式）

### Phase A3 Step1専門組織構成

#### 1. 仕様準拠監査役
**責任範囲**:
- 機能仕様書2.1節（認証機能）の完全理解
- 否定的仕様の継続的監視
- 実装と仕様の整合性確認
- 仕様準拠マトリックスの維持管理

**実行タスク**:
- 仕様書精読と解釈統一
- チェックリスト作成・管理
- レビュー基準の明確化

#### 2. Identity技術調査チーム
**責任範囲**:
- ASP.NET Core Identity拡張機能調査
- パスワードリセットトークン生成・検証
- Remember Me実装パターン
- セッション管理メカニズム

**実行タスク**:
- 公式ドキュメント調査
- ベストプラクティス抽出
- 実装パターン提案

#### 3. メール基盤設計チーム
**責任範囲**:
- メール送信アーキテクチャ設計
- SMTP設定・管理方式
- テンプレートエンジン選定
- 開発環境メール送信（smtp4dev）

**実行タスク**:
- メール送信サービス設計
- Clean Architecture準拠確認
- インターフェース定義

#### 4. TDD計画統括チーム
**責任範囲**:
- Red-Green-Refactorサイクル計画
- テストシナリオ優先順位
- 仕様ベーステスト設計
- 統合テスト戦略

**実行タスク**:
- 全体TDD実行計画策定
- フェーズ別タスク分解
- チェックポイント設定

## 🔄 Step1実行プロセス

### Phase 1: 並列分析（30分）
1. **仕様準拠監査役**: 仕様書精読・否定的仕様抽出・チェックリスト作成
2. **Identity技術調査チーム**: ASP.NET Core Identity機能調査・実装パターン調査
3. **メール基盤設計チーム**: メール送信要件分析・技術選定候補調査
4. **TDD計画統括チーム**: 各機能のテストシナリオ概要設計

### Phase 2: 統合・優先順位付け（20分）
- 各チーム成果の統合
- 技術的依存関係の整理
- 実装優先順位の決定
- リスク・課題の明確化

### Phase 3: 詳細計画策定（10分）
- Phase A3全体のStep構成決定
- 各Stepの具体的成果物定義
- TDD実行スケジュール確定
- 次Step組織設計準備

## 📝 実行記録

### 仕様確認完了事項
- ✅ 機能仕様書2.1節（認証機能）精読完了
- ✅ 否定的仕様「ログイン失敗によるロックアウト機構は設けない」確認
- ✅ セッション管理要件（2時間タイムアウト・7日間Remember Me）確認
- ✅ パスワードリセットフロー理解完了

### 技術調査予定
- [ ] ASP.NET Core Identity UserManager拡張調査
- [ ] IEmailSender実装パターン調査
- [ ] 監査ログ実装方式調査（ILogger vs カスタム実装）
- [ ] セッション固定攻撃対策実装確認

## 🚨 リスク・課題事項

### 技術的リスク
1. **メール送信の複雑性**: SMTP設定・環境別構成・エラーハンドリング
2. **セッション管理**: Blazor ServerとASP.NET Core Identityの統合
3. **監査ログ**: パフォーマンス影響・ストレージ要件

### 仕様解釈課題
1. **監査ログ仕様不足**: 具体的なログ項目・保存期間の仕様なし
2. **セキュリティ通知基準**: 「異常ログイン」の定義が曖昧

## 📊 技術調査結果サマリー

### ASP.NET Core Identity拡張
- **パスワードリセット**: DataProtectorTokenProviderによるセキュアトークン生成
- **Remember Me**: isPersistentパラメータとExpireTimeSpan設定（7日間）
- **セキュリティスタンプ**: パスワード変更時の既存トークン無効化機構

### メール送信基盤
- **推奨ライブラリ**: MailKit（System.Net.Mail.SmtpClientは非推奨）
- **設定管理**: appsettings.json + Optionsパターン
- **開発環境**: smtp4dev（Docker）による送信確認

### 監査ログ実装
- **アプローチ**: カスタムSignInManager継承による認証イベント記録
- **構造化ログ**: Serilog推奨（JSON形式・非同期書き込み）
- **パフォーマンス**: 非同期ロギング・バッチ処理で影響最小化

## 🎯 Phase A3実行計画（全7Steps）

### Step構成と期間見積もり
1. **Step1: 技術分析・計画策定**（現在実行中・60分）
2. **Step2: メール送信基盤構築**（90分）
   - IEmailSenderインターフェース定義
   - SmtpEmailSender実装
   - smtp4dev環境構築
3. **Step3: パスワードリセット機能**（120分）
   - トークン生成・検証ロジック
   - リセットUI実装
   - メール送信統合
4. **Step4: Remember Me・ログアウト機能**（90分）
   - 永続化Cookie設定
   - ログアウト処理実装
   - セッション管理強化
5. **Step5: 統合テスト・品質保証**（90分）
   - 全機能の統合テスト
   - 否定的仕様の検証
   - パフォーマンステスト

### TDD実践計画
- 各Stepで厳格なRed-Green-Refactorサイクル実施
- 仕様ベーステスト設計（否定的仕様の検証含む）
- Step毎のテストカバレッジ80%以上維持

## 📊 Step1終了時レビュー

### 組織効果評価
- ✅ 効率性: 並列技術調査により60分で完了（当初計画通り）
- ✅ 専門性: 各チームの専門調査により深い技術理解獲得
- ✅ 統合: 技術選定の一貫性確保（MailKit・Serilog・Optionsパターン）
- ✅ 品質: 仕様理解100%・技術調査でベストプラクティス抽出
- ✅ 次Step適応性: メール基盤から着手する明確な依存関係整理

### 次Step組織設計方針
- **Step2（メール送信基盤）**: インフラチーム中心の実装組織
- **フィーチャーチーム制**: 各機能毎にRed-Green-Refactorサイクル実践
- **仕様準拠監査役**: 全Stepで継続配置