# TECH-004: åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£å®Œäº†

## ä¿®æ­£æ—¥æ™‚
**2025-09-09** - ASP.NET Core Identityçµ±åˆã«ãŠã‘ã‚‹åˆå›ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼ä¿®æ­£

## ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/UbiquitousLanguageManager.Web/Services/AuthenticationService.cs`
- **ä¿®æ­£ç®‡æ‰€**: 
  - `ChangePasswordAsync(string userEmail, ChangePasswordRequestDto request)` ãƒ¡ã‚½ãƒƒãƒ‰ (Line 256-284)
  - `ChangePasswordAsync(string currentPassword, string newPassword)` ãƒ¡ã‚½ãƒƒãƒ‰ (Line 366-394)

## å•é¡Œæ¦‚è¦
- **ã‚¨ãƒ©ãƒ¼**: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: Incorrect password."
- **åŸå› **: `PasswordHash = null` ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ `UserManager.ChangePasswordAsync` ãŒå¤±æ•—
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹**: `AspNetUsers.PasswordHash = null`, `InitialPassword = 'su'`

## ä¿®æ­£å†…å®¹

### 1. åˆå›ãƒ­ã‚°ã‚¤ãƒ³å°‚ç”¨èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 

```csharp
// ä¿®æ­£å‰ï¼ˆå•é¡Œç®‡æ‰€ï¼‰
var result = await _userManager.ChangePasswordAsync(user, request.CurrentPassword, request.NewPassword);

// ä¿®æ­£å¾Œ
IdentityResult result;

if (appUser.IsFirstLogin && string.IsNullOrEmpty(user.PasswordHash))
{
    // ğŸ”‘ åˆå›ãƒ­ã‚°ã‚¤ãƒ³å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼šInitialPasswordã¨ç…§åˆã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ–°è¦è¨­å®š
    if (request.CurrentPassword == appUser.InitialPassword)
    {
        // InitialPasswordç…§åˆæˆåŠŸ â†’ æ–°è¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
        result = await _userManager.AddPasswordAsync(user, request.NewPassword);
    }
    else
    {
        // InitialPasswordç…§åˆå¤±æ•—
        result = IdentityResult.Failed(new IdentityError { Description = "åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚" });
    }
}
else
{
    // ğŸ” é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³ï¼šæ—¢å­˜ã®PasswordHashãƒ™ãƒ¼ã‚¹èªè¨¼
    result = await _userManager.ChangePasswordAsync(user, request.CurrentPassword, request.NewPassword);
}
```

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

#### åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¹³æ–‡ç…§åˆ
- **å¯¾è±¡**: åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ï¼ˆ`IsFirstLogin=true` && `PasswordHash=null`ï¼‰ã®ã¿
- **ç…§åˆ**: `request.CurrentPassword == appUser.InitialPassword` ã§å¹³æ–‡æ¯”è¼ƒ
- **åˆ¶é™**: åˆå›ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯`InitialPassword`ã‚’`null`ã«ã‚¯ãƒªã‚¢ã—ã¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

#### ãƒ­ã‚°å‡ºåŠ›æœ€é©åŒ–
```csharp
// åˆå›ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼
_logger.LogInformation("åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†: {Email} (PasswordHash=null)", userEmail);
_logger.LogInformation("åˆå›ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æˆåŠŸ: InitialPasswordç…§åˆOK - {Email}", userEmail);

// é€šå¸¸èªè¨¼
_logger.LogInformation("é€šå¸¸ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†: {Email} (PasswordHashå­˜åœ¨)", userEmail);
```

### 3. ASP.NET Core Identityçµ±åˆ

#### APIä½¿ã„åˆ†ã‘
- **åˆå›è¨­å®š**: `UserManager.AddPasswordAsync(user, newPassword)` ä½¿ç”¨
- **é€šå¸¸å¤‰æ›´**: `UserManager.ChangePasswordAsync(user, currentPassword, newPassword)` ç¶™ç¶šä½¿ç”¨

#### æ—¢å­˜æ©Ÿèƒ½ä¿è­·
- é€šå¸¸ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ•ãƒ­ãƒ¼ã«å½±éŸ¿ãªã—
- ASP.NET Core Identityæ¨™æº–æ©Ÿèƒ½ã¨ã®äº’æ›æ€§ç¶­æŒ
- æ—¢å­˜ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¸ã®å½±éŸ¿ãªã—

## ãƒ“ãƒ«ãƒ‰çµæœ
- **ãƒ“ãƒ«ãƒ‰**: âœ… 0è­¦å‘Š0ã‚¨ãƒ©ãƒ¼
- **ãƒ†ã‚¹ãƒˆ**: âœ… å…¨ãƒ†ã‚¹ãƒˆé€šé
- **æ—¢å­˜æ©Ÿèƒ½**: âœ… å½±éŸ¿ãªã—

## å‹•ä½œç¢ºèªæ–¹æ³•

### 1. åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ¤œè¨¼æ‰‹é †
```bash
# 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
dotnet run --project src/UbiquitousLanguageManager.Web

# 2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹
https://localhost:5001

# 3. åˆå›ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
# Email: admin@ubiquitous-lang.com
# Password: su

# 4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ã§ãƒ†ã‚¹ãƒˆ
# Current Password: su
# New Password: [æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰]
```

### 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
```sql
-- å¤‰æ›´å‰ç¢ºèª
SELECT Id, Email, PasswordHash, IsFirstLogin, InitialPassword 
FROM AspNetUsers WHERE Email = 'admin@ubiquitous-lang.com';

-- å¤‰æ›´å¾Œç¢ºèªï¼ˆInitialPassword=null, IsFirstLogin=false, PasswordHashã‚ã‚Šï¼‰
SELECT Id, Email, PasswordHash, IsFirstLogin, InitialPassword 
FROM AspNetUsers WHERE Email = 'admin@ubiquitous-lang.com';
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„

### 1. é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
```csharp
// åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´æ™‚
result = IdentityResult.Failed(new IdentityError { 
    Description = "åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚" 
});

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
return ChangePasswordResponseDto.Error("åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
```

### 2. ãƒ­ã‚°å‡ºåŠ›ãƒ¬ãƒ™ãƒ«æœ€é©åŒ–
- **Info**: æ­£å¸¸ãªèªè¨¼ãƒ•ãƒ­ãƒ¼
- **Warning**: èªè¨¼å¤±æ•—ãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´
- **Error**: ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãƒ»ä¾‹å¤–å‡¦ç†

## æŠ€è¡“è² å‚µè§£æ±ºçŠ¶æ³
- **TECH-004**: âœ… **è§£æ±ºå®Œäº†** - åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã®èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ä¿®æ­£
- **é–¢é€£æŠ€è¡“è² å‚µ**: TECH-001, TECH-002ã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½äºˆå®š

## æ¬¡å›å®Ÿè£…äºˆå®š
1. **åˆå›ãƒ­ã‚°ã‚¤ãƒ³å‹•ä½œç¢ºèª**: å®Ÿéš›ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèª
2. **çµ±åˆãƒ†ã‚¹ãƒˆ**: ä»–ã®èªè¨¼é–¢é€£æ©Ÿèƒ½ã¨ã®æ•´åˆæ€§ç¢ºèª
3. **TECH-001å¯¾å¿œ**: ASP.NET Core Identityè¨­è¨ˆå…¨ä½“ã®è¦‹ç›´ã—

## å®Ÿè£…å®Œäº†è¨¼è·¡
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `src/UbiquitousLanguageManager.Web/Services/AuthenticationService.cs`
- **ä¿®æ­£è¡Œæ•°**: ç´„50è¡Œï¼ˆ2ã¤ã®ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
- **ãƒ†ã‚¹ãƒˆ**: æ—¢å­˜ãƒ†ã‚¹ãƒˆå…¨é€šé
- **ãƒ“ãƒ«ãƒ‰**: 0è­¦å‘Š0ã‚¨ãƒ©ãƒ¼é”æˆ