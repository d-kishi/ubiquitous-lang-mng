# ADR_020: テストアーキテクチャ決定（レイヤー×テストタイプ分離方式）

**作成日**: 2025-10-06
**ステータス**: 採択
**対象**: テストプロジェクト全体の構造・組織化戦略

## 背景・課題

### 現在のテストプロジェクト構造の問題点

Phase B1 Step7（Web層bUnit UIテスト実装）完了時点で、以下の問題が顕在化している：

1. **テストタイプ混在**
   - 単体テスト（Unit Tests）と統合テスト（Integration Tests）が同一プロジェクト
   - テスト実行粒度の制御不可（全テスト実行が必須）
   - CI/CD最適化の困難（レイヤー別・テストタイプ別実行不可）

2. **レイヤー混在**
   - 全5層（Domain/Application/Contracts/Infrastructure/Web）が1プロジェクトに集約
   - 責務分離の原則違反（Single Responsibility Principle）
   - テストメンテナンス時の影響範囲不明確

3. **言語混在による技術負債**
   - F#（Domain/Application）とC#（Contracts/Infrastructure/Web）が混在
   - `EnableDefaultCompileItems=false` による暫定対応（Phase A テストビルドエラー）
   - ビルド設定の複雑化

4. **重複管理の非効率性**
   - Domain層テストが2つのプロジェクトで重複（GitHub Issue #40 初版）
   - 保守性低下・テスト実行時間増加

5. **Phase B2以降の拡張性不足**
   - E2Eテスト追加時に更なる混在発生
   - テストタイプ増加による複雑度の爆発的増加

### 2024年 .NET Clean Architecture ベストプラクティスとの乖離

Microsoft公式ドキュメント・Clean Architecture Community推奨構造との比較評価結果：

| 評価項目 | 推奨構造 | 現状 | 評価 |
|---------|---------|------|------|
| テストタイプ分離 | Unit/Integration/E2E 明確分離 | 混在 | ❌ 不適合 |
| レイヤー別分離 | レイヤーごとに個別プロジェクト | 統合プロジェクト | ❌ 不適合 |
| 言語別分離 | F#/C# プロジェクト分離 | 混在 | ❌ 不適合 |
| 依存関係管理 | テストプロジェクト = Production同等 | 全層参照 | ❌ 不適合 |
| 実行粒度制御 | レイヤー別・テストタイプ別実行可 | 全テスト一括実行のみ | ❌ 不適合 |

### 具体的な発見事例

2025-10-06のPhase B1 Session 8完了時、GitHub Issue #40の「重複テストプロジェクト削除」対応だけでは、
テストアーキテクチャの根本的問題が解決しないことが判明。業界標準との乖離が継続する。

## 決定事項

テストプロジェクト構造を**レイヤー別×テストタイプ別分離方式**に刷新する。

### 採用する最終構造

```
tests/
├── UbiquitousLanguageManager.Domain.Unit.Tests/              # F# Domain単体テスト
├── UbiquitousLanguageManager.Application.Unit.Tests/         # F# Application単体テスト
├── UbiquitousLanguageManager.Contracts.Unit.Tests/           # C# Contracts単体テスト
├── UbiquitousLanguageManager.Infrastructure.Unit.Tests/      # C# Infrastructure単体テスト
├── UbiquitousLanguageManager.Infrastructure.Integration.Tests/ # C# 統合テスト (DB/外部連携)
├── UbiquitousLanguageManager.Web.UI.Tests/                   # C# Blazor bUnit UIテスト
└── UbiquitousLanguageManager.E2E.Tests/                      # C# E2Eテスト (Phase B2以降)
```

### 命名規則

**プロジェクト名**: `{ProjectName}.{Layer}.{TestType}.Tests`

- **Layer**: Domain / Application / Contracts / Infrastructure / Web
- **TestType**: Unit / Integration / UI / E2E

### 参照関係原則

各テストプロジェクトは**テスト対象レイヤーのみ**を直接参照する（Production構造と同等）。

**例外**: 統合テストは必要な依存層を参照可能（Infrastructure.Integration.Tests → Infrastructure + Application + Domain）

### 言語別分離原則

- **F# プロジェクト**: Domain.Unit.Tests, Application.Unit.Tests
- **C# プロジェクト**: Contracts.Unit.Tests, Infrastructure.Unit.Tests, Infrastructure.Integration.Tests, Web.UI.Tests, E2E.Tests

## 技術的根拠

### .NET Clean Architecture ベストプラクティス準拠

1. **Microsoft公式推奨（2024年）**
   - "eShopOnWeb" サンプルアプリケーション構造
   - レイヤー別テストプロジェクト分離
   - テストタイプ別（UnitTests/IntegrationTests/FunctionalTests）

2. **Clean Architecture Community 推奨**
   - テスト実行速度最適化（Unit: 秒単位 / Integration: 分単位 / E2E: 時間単位）
   - 依存関係の明確化（テスト失敗時の影響範囲特定）
   - 責務分離の徹底（Single Responsibility Principle）

### 本プロジェクトにおける利点

1. **明確な責務分離**
   - レイヤー×テストタイプで完全分離
   - テスト失敗時の影響範囲即座特定
   - メンテナンス時の変更範囲最小化

2. **言語別隔離**
   - F# (Domain/Application) と C# (Contracts/Infrastructure/Web) を完全分離
   - `EnableDefaultCompileItems=false` 技術負債の解消
   - ビルド設定の単純化

3. **テスト実行粒度制御**
   - `dotnet test tests/Domain.Unit.Tests` でDomain単体テストのみ実行
   - CI/CDパイプラインの段階的実行（Unit → Integration → E2E）
   - 開発時の高速フィードバックループ実現

4. **Phase B2以降の拡張性**
   - E2E.Tests プロジェクト追加で自然に拡張
   - 新規テストタイプ追加時の影響最小化
   - スケーラビリティ確保

5. **技術負債の根本解消**
   - GitHub Issue #40（重複テストプロジェクト）の完全解決
   - F#/C# 混在問題の解消
   - テストプロジェクト構造の標準化

## 期待される効果

### Positive

1. **テスト実行効率向上（推定30-40%）**
   - レイヤー別・テストタイプ別実行による時間短縮
   - 開発時の高速フィードバック（Unit Testsのみ実行）
   - CI/CD最適化（並列実行・段階的実行）

2. **保守性向上**
   - テスト失敗時の影響範囲即座特定
   - レイヤー別メンテナンスの容易性
   - 新規テストの追加場所明確化

3. **技術負債解消**
   - `EnableDefaultCompileItems=false` 不要化
   - GitHub Issue #40の完全解決
   - F#/C# 混在問題の解消

4. **Phase B2以降の開発効率向上**
   - E2Eテストの自然な追加
   - テストアーキテクチャの長期安定性
   - チーム開発への拡張容易性

5. **業界標準準拠**
   - .NET Clean Architecture ベストプラクティス準拠
   - Microsoft推奨構造との整合性
   - 外部開発者の理解容易性

### Negative

1. **初期移行コスト**
   - 既存テストファイルの移行作業（推定4-6時間）
   - プロジェクトファイル・ソリューションファイル更新
   - CI/CD設定更新

2. **プロジェクト数増加**
   - 管理対象プロジェクト増加（3 → 7）
   - Visual Studio/VSCode のソリューション表示の煩雑化
   - dotnet CLI コマンドの複雑化（個別プロジェクト指定）

3. **学習コスト**
   - 新しいテストプロジェクト構造の理解
   - テスト配置場所の判断ルール習得
   - CI/CD実行コマンドの習得

### リスク管理と対策

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| テスト実行失敗 | 高 | 中 | 各Phase完了後に全テスト実行・カバレッジ維持確認 |
| CI/CD破損 | 高 | 低 | Phase 2完了後に統合的更新、ロールバックプラン準備 |
| 依存関係エラー | 中 | 中 | 段階的移行、ビルド確認の徹底 |
| 移行漏れ | 中 | 低 | チェックリスト作成、移行前後のテスト件数比較 |

## 実装計画

### Phase 1: レイヤー別単体テストプロジェクト作成
**実施時期**: Phase B1完了後
**推定時間**: 2-3時間

1. `UbiquitousLanguageManager.Domain.Unit.Tests` (F#) 作成
   - 既存 `Domain.Tests` および `Tests/Domain` から移行
   - 重複テストファイル統合

2. `UbiquitousLanguageManager.Application.Unit.Tests` (F#) 作成
   - 既存 `Tests/Application` から移行

3. `UbiquitousLanguageManager.Contracts.Unit.Tests` (C#) 作成
   - 既存 `Tests/Contracts` から移行

4. `UbiquitousLanguageManager.Infrastructure.Unit.Tests` (C#) 作成
   - 既存 `Tests/Infrastructure` から単体テストのみ移行

**成果物**: 4つの新規テストプロジェクト、全テスト実行成功確認

### Phase 2: テストタイプ別プロジェクト作成
**実施時期**: Phase 1完了後
**推定時間**: 1-2時間

1. `UbiquitousLanguageManager.Infrastructure.Integration.Tests` (C#) 作成
   - 既存 `Tests/Integration` から移行
   - WebApplicationFactory、DB接続テスト

2. `UbiquitousLanguageManager.Web.UI.Tests` にリネーム
   - 既存 `Web.Tests` をリネーム・整理

**成果物**: 2つのテストプロジェクト整理、CI/CD パイプライン更新

### Phase 3: 旧プロジェクト削除
**実施時期**: Phase 2完了後
**推定時間**: 1時間

1. `UbiquitousLanguageManager.Domain.Tests` 削除
2. `UbiquitousLanguageManager.Tests` 削除
3. ソリューションファイル (.sln) 更新
4. CI/CD設定更新
5. ドキュメント更新

**成果物**: 旧プロジェクト削除、全テスト実行成功確認、カバレッジ維持

### Phase 4: E2E準備（Phase B2対応）
**実施時期**: Phase B2開始時
**推定時間**: 2-3時間

1. `UbiquitousLanguageManager.E2E.Tests` プロジェクトテンプレート作成
2. E2Eフレームワーク選定（Playwright推奨）
3. 基本的なE2Eテストサンプル作成

**成果物**: E2E.Tests プロジェクトテンプレート、Phase B2実装準備完了

## 関連文書

- **実施Issue**: GitHub Issue #40「テストアーキテクチャ全面見直し」
- **技術調査**: E2Eフレームワーク選定（Playwright vs Selenium）
- **参考ADR**:
  - ADR_009: テスト指針
  - ADR_015: 技術的負債管理のGitHub Issues移行
  - ADR_016: プロセス遵守違反防止策

## 見直し基準

以下の条件で本決定の見直しを検討する：

1. **効率性の問題**
   - テスト実行時間が30%以上増加
   - 管理作業時間が50%以上増加

2. **技術的制約**
   - .NET SDK・ツールチェーンの制限
   - CI/CD環境の制約

3. **組織的制約**
   - プロジェクト規模拡大による複雑化
   - チーム協業要件の変化（多人数開発への移行）

---

**記録者**: Claude Code
**決定日**: 2025-10-06
**次回見直し**: Phase B2完了時（E2Eテスト追加後の効果測定）
