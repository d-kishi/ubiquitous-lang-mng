# ADR_007: エラーハンドリング統一方針

**ステータス**: 承認済み  
**決定日**: 2025-07-06  
**決定者**: プロジェクトオーナー  
**記録者**: Claude Code  

## 背景・課題

### Clean Architectureでのエラー処理の複雑性
- **層別責務**: Domain、Application、Infrastructure、Presentationの各層で異なるエラー処理が必要
- **エラー種別**: ビジネスルール違反（Domain）vs 技術的エラー（Infrastructure）の明確な分離
- **ユーザー体験**: 適切なエラーメッセージとフィードバックの提供

### F#関数型プログラミングの活用
- **Result型**: F#の型システムを活かした堅牢なエラー処理
- **例外回避**: 予測可能なエラーは例外ではなく型で表現
- **コンパイル時保証**: エラー処理の強制による実行時例外削減

### ユビキタス言語管理の業務特性
- **承認ワークフロー**: 状態遷移の制約違反
- **用語重複チェック**: ビジネスルール違反
- **データ整合性**: 参照整合性制約違反

## 決定事項

### 1. 層別エラーハンドリング戦略

#### 1.1 Domain層 (F#) - ビジネスエラー処理
- **原則**: Result型による明示的エラー処理・例外使用禁止
- **対象**: ビジネスルール違反・状態遷移制約・ドメイン制約
- **表現**: discriminated unionによる型安全なエラー表現

#### 1.2 Application層 (F#) - ユースケースエラー処理
- **原則**: Domainエラーの伝播・技術エラーの例外変換
- **対象**: 権限チェック・複数ドメインエラーの統合
- **変換**: DomainエラーからApplicationエラーへの適切な変換

#### 1.3 Infrastructure層 (C#) - 技術エラー処理
- **原則**: 外部システムエラーの適切なキャッチ・変換
- **対象**: データベース例外・ネットワーク例外・I/O例外
- **処理**: try-catch・リトライ・フォールバック戦略

#### 1.4 Presentation層 (C#) - ユーザー向けエラー処理
- **原則**: ユーザーフレンドリーなエラー表示・適切なログ記録
- **対象**: UI状態管理・エラーメッセージ表示・再試行制御
- **表示**: 技術詳細の隠蔽・分かりやすいガイダンス提供

### 2. エラー型設計

#### 2.1 Domain層エラー型
- **ビジネスエラー**: discriminated unionによる明示的定義
- **命名規則**: 〇〇ValidationError、〇〇BusinessError形式
- **情報保持**: エラー内容特定に必要な最小限の情報

#### 2.2 Application層エラー型
- **統合エラー**: 複数Domainエラーの統合・権限エラー
- **変換ルール**: Domainエラーの適切なApplicationエラーへの変換
- **ログ情報**: デバッグに必要な文脈情報の付加

#### 2.3 Infrastructure層エラー型
- **技術エラー**: 外部システム固有例外の統合
- **変換戦略**: 技術例外からドメイン例外への適切な変換
- **リトライ可能性**: 一時的エラーvs恒久的エラーの区別

### 3. エラー処理パターン

#### 3.1 Result型チェーン
- **基本パターン**: Result.bind、Result.mapによるエラー伝播
- **利点**: 明示的エラー処理・コンパイル時チェック
- **適用**: Domain層・Application層での主要パターン

#### 3.2 例外からResult変換
- **適用場面**: Infrastructure層からDomain層への境界
- **変換戦略**: try-catchによる例外キャッチ・適切なResult型への変換
- **ログ記録**: 例外詳細の適切なログ出力

#### 3.3 エラー統合・集約
- **複数エラー**: 複数の検証エラーの統合表示
- **優先順位**: 重要度に応じたエラー表示順序
- **ユーザビリティ**: 一度に修正可能な情報提示

### 4. ログ連携

#### 4.1 エラーログ戦略
- **レベル設定**: Error（技術例外）・Warning（ビジネスエラー）
- **情報記録**: エラー内容・発生文脈・ユーザー情報
- **連携**: ADR_008ログ出力指針との統合

#### 4.2 トレーサビリティ
- **エラー追跡**: リクエストIDによる一連の処理追跡
- **パフォーマンス**: エラー発生時のパフォーマンス情報記録
- **分析**: エラー頻度・パターンの分析基盤

## 技術的根拠

### Result型採用の利点
1. **型安全性**: コンパイル時エラー処理チェック・実行時例外削減
2. **明示性**: エラー処理の明示的表現・隠れた例外の排除
3. **合成性**: エラー処理の合成・チェーン可能性

### 層別エラー処理の効果
1. **責務分離**: 各層の責任明確化・エラー処理の一貫性
2. **保守性**: エラー処理ロジックの集約・修正影響範囲限定
3. **テスト性**: 予測可能なエラー・テストケース網羅性

## 実装影響

### 開発効率への影響
- **初期コスト**: Result型設計・エラー型定義時間
- **長期メリット**: バグ削減・デバッグ時間短縮・保守性向上

### システム品質への影響
- **堅牢性**: 予期しない例外の排除・優雅なエラー処理
- **ユーザー体験**: 適切なエラーフィードバック・回復可能性
- **運用性**: エラー分析・問題特定の効率化

## 関連文書

- **[エラーハンドリング実装ガイド](/Doc/08_Organization/Rules/エラーハンドリング実装ガイド.md)**: 詳細な実装パターン・サンプルコード
- **ADR_008**: ログ出力指針（エラーログとの連携）
- **ADR_009**: テスト指針（エラーケーステスト）

## レビュー履歴

| 日付 | レビュー者 | 結果 | コメント |
|------|------------|------|----------|
| 2025-07-06 | プロジェクトオーナー | 承認 | Result型活用と層別責務分離が適切 |
| 2025-07-27 | Claude Code | 合理化 | 詳細実装例をエラーハンドリング実装ガイドに移管・基本方針に集約 |

---

**承認者**: プロジェクトオーナー  
**承認日**: 2025-07-06  
**合理化日**: 2025-07-27