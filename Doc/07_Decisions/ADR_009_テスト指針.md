# ADR_009: テスト指針

**ステータス**: 承認済み  
**決定日**: 2025-07-06  
**決定者**: プロジェクトオーナー  
**記録者**: Claude Code  

## 背景・課題

### システム品質保証の必要性
- **長期保守性**: 個人開発での将来的な機能追加・修正時の品質担保
- **リファクタリング安全性**: Clean Architectureの構造変更時の動作保証
- **回帰テスト**: 新機能追加時の既存機能影響チェック

### Clean Architectureでのテスト戦略
- **テストピラミッド**: 単体→統合→E2Eの効率的なテスト配置
- **Domain層重視**: ビジネスロジックの網羅的テスト
- **層別テスト**: 各層の責務に応じた適切なテスト種別

### F# + C#混在環境でのテスト
- **F#関数型テスト**: 純粋関数の高いテスト性
- **Blazor Serverテスト**: UIコンポーネントの動作確認
- **言語間境界テスト**: 型変換・データ連携の正確性

## 決定事項

### 1. テスト種別と責務

#### 1.1 単体テスト (Unit Test) - 最重要
- **対象**: Domain層F#純粋関数、Application層C#サービス
- **特徴**: 外部依存なし、高速実行、網羅的ケース分岐
- **優先度**: 最高（開発の70%）

#### 1.2 統合テスト (Integration Test)
- **対象**: Infrastructure層リポジトリ、API、データベース連携
- **特徴**: 実データベース使用、コンポーネント間連携確認
- **優先度**: 中（開発の20%）

#### 1.3 E2Eテスト (End-to-End Test)
- **対象**: 主要ユーザーシナリオのみ
- **特徴**: Playwright使用、実ブラウザでの動作確認
- **優先度**: 最小限（開発の10%）

### 2. テストフレームワーク統一

#### 2.1 採用フレームワーク
- **テスティング**: xUnit（統一）
- **アサーション**: FluentAssertions（C#）、FsUnit.xUnit（F#）
- **モック**: NSubstitute
- **E2E**: Microsoft.Playwright
- **データベース**: EntityFramework InMemory、Testcontainers.PostgreSql

#### 2.2 テストプロジェクト構成
```
UbiquitousLanguageManager.Tests/
├── Unit/          # 単体テスト
├── Integration/   # 統合テスト
├── E2E/          # E2Eテスト
└── TestUtilities/ # 共通ユーティリティ
```

### 3. テスト実行戦略

#### 3.1 テストピラミッド比率
- **単体テスト**: 70%（高速・網羅的）
- **統合テスト**: 20%（システム間連携）
- **E2Eテスト**: 10%（主要シナリオのみ）

#### 3.2 品質基準
- **テストカバレッジ**: 80%以上維持
- **Domain層テスト**: 100%カバレッジ（最重要）
- **テストファースト**: Red-Green-Refactorサイクル必須

#### 3.3 継続的インテグレーション
- **自動実行**: GitHub Actions
- **失敗時**: ビルド・デプロイ停止
- **パフォーマンス**: 単体テスト5分以内、全テスト15分以内

## 技術的根拠

### テストピラミッド採用の利点
1. **効率性**: 高速な単体テストで問題の早期発見
2. **信頼性**: 統合テストでシステム間連携確認
3. **ユーザー視点**: E2Eテストで実際の使用感確認

### F#テスト優位性
1. **純粋関数**: 副作用なしで予測可能なテスト
2. **型安全性**: コンパイル時のテストケース検証
3. **パターンマッチング**: 網羅的なケース分岐テスト

### Domain層テスト重視の理由
1. **ビジネス価値**: 最重要なロジックの品質担保
2. **変更頻度**: 仕様変更時の回帰テスト効果
3. **テスト容易性**: 外部依存なしで高速・確実

## 実装影響

### 開発効率への影響
- **初期コスト**: テストコード記述時間（開発時間の30-40%）
- **長期メリット**: バグ発見時間短縮、リファクタリング安全性

### 品質向上効果
- **回帰防止**: 既存機能への影響早期発見
- **仕様明確化**: テストコードによる動作仕様文書化
- **設計改善**: テスタビリティ向上による設計品質向上

## 関連文書

- **[テスト戦略ガイド](/Doc/08_Organization/Rules/テスト戦略ガイド.md)**: 詳細な実装手順・サンプルコード
- **ADR_007**: エラーハンドリング統一方針（エラーケーステスト）
- **ADR_010**: 実装規約（テストコードのコメント記述）

## レビュー履歴

| 日付 | レビュー者 | 結果 | コメント |
|------|------------|------|----------|
| 2025-07-06 | プロジェクトオーナー | 承認 | Domain層重視とF#テスト戦略が適切 |
| 2025-07-27 | Claude Code | 合理化 | サンプルコードをテスト戦略ガイドに移管・決定事項に集約 |

---

**承認者**: プロジェクトオーナー  
**承認日**: 2025-07-06  
**合理化日**: 2025-07-27