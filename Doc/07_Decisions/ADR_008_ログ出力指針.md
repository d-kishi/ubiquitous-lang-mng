# ADR_008: ログ出力指針

**ステータス**: 承認済み  
**決定日**: 2025-07-06  
**決定者**: プロジェクトオーナー  
**記録者**: Claude Code  

## 背景・課題

### 個人開発での問題調査効率化
- **デバッグ効率**: 問題発生時の迅速な原因究明
- **システム動作把握**: 承認ワークフロー等の複雑な業務フローの追跡
- **パフォーマンス分析**: Blazor Server・PostgreSQLのボトルネック特定

### Clean Architectureでのログ責務分離
- **Domain層**: ビジネスロジックの純粋性維持（ログ出力なし）
- **Application層**: ユースケース実行の追跡
- **Infrastructure層**: 外部システム連携の監視
- **Presentation層**: ユーザー操作とUI状態の記録

### 構造化ログによる分析能力向上
- **検索性**: ログ内容の効率的な検索・フィルタリング
- **集計性**: エラー頻度・パフォーマンス指標の分析
- **可読性**: 開発・運用での理解しやすいログフォーマット

## 決定事項

### 1. ログライブラリ・フレームワーク

#### 1.1 標準ライブラリの採用
- **基本フレームワーク**: Microsoft.Extensions.Logging（.NET標準）
- **構造化ログ**: Serilog推奨
- **利点**: .NETエコシステム統合・高性能・豊富なSink対応

#### 1.2 ログレベル戦略
- **Critical**: システム停止レベルの致命的エラー
- **Error**: 機能レベルの問題・例外処理
- **Warning**: 潜在的問題・非推奨機能使用
- **Information**: 重要な業務処理・状態変更
- **Debug**: 開発時詳細情報（本番環境無効）

### 2. 層別ログ出力責務

#### 2.1 Domain層 (F#) - ログ出力禁止
- **原則**: 完全にログ出力禁止・外部I/Oからの完全分離
- **理由**: テスト容易性・ビジネスロジック純粋性維持
- **代替**: エラーはResult型で表現・ログは呼び出し側で出力

#### 2.2 Application層 (F#) - ユースケースログ
- **対象**: ユースケース開始・終了・重要な分岐点
- **内容**: 実行ユーザー・入力パラメータ・処理結果
- **レベル**: Information（正常）・Warning（ビジネスエラー）・Error（技術エラー）

#### 2.3 Infrastructure層 (C#) - 外部システム連携ログ
- **対象**: データベース操作・外部API呼び出し・ファイルI/O
- **内容**: パフォーマンス情報・接続状態・エラー詳細
- **レベル**: Debug（詳細）・Information（結果）・Error（失敗）

#### 2.4 Presentation層 (C#) - ユーザー操作ログ
- **対象**: 画面遷移・重要な操作・認証状態変更
- **内容**: ユーザーID・操作内容・セッション状態
- **レベル**: Information（操作）・Warning（権限エラー）

### 3. 構造化ログ形式

#### 3.1 ログメッセージテンプレート
- **使用方式**: 構造化ログテンプレート（{PropertyName}形式）
- **利点**: 高性能・検索性・型安全性
- **禁止**: 文字列補間によるログメッセージ生成

#### 3.2 プロパティ命名規則
- **ユーザー情報**: UserId, UserName, UserRole
- **業務エンティティ**: UbiquitousLangId, ProjectId, WorkflowId
- **技術情報**: Duration, ConnectionString, HttpStatusCode
- **形式**: PascalCase・説明的な名前・型推論可能

### 4. ログ出力設定

#### 4.1 出力先（Sinks）
- **Console**: 開発環境・コンテナ環境
- **File**: 本番環境・ローカル開発
- **推奨回転**: 日次ローテーション・サイズ制限

#### 4.2 フィルタリング
- **Microsoft系**: Warning以上（ノイズ削減）
- **EntityFrameworkCore**: Warning以上（SQL詳細無効）
- **アプリケーション**: Information以上

## 技術的根拠

### Serilog採用の利点
1. **高性能**: 非同期ログ・メモリ効率
2. **構造化**: JSON形式・検索・集計対応
3. **豊富なSink**: File・Console・Database・クラウド対応

### 層別責務分離の効果
1. **保守性**: 各層の責任明確化・コード品質向上
2. **テスト性**: Domain層の純粋性・単体テスト容易性
3. **パフォーマンス**: 必要な層のみログ出力・オーバーヘッド最小化

## 実装影響

### 開発効率への影響
- **初期コスト**: ログ設定・テンプレート作成
- **長期メリット**: 問題調査時間短縮・運用効率向上

### システム性能への影響
- **ログ出力コスト**: 約1-3%のオーバーヘッド
- **最適化**: 非同期出力・適切なレベル設定による軽減

## 関連文書

- **[ログ出力実装ガイド](/Doc/08_Organization/Rules/ログ出力実装ガイド.md)**: 詳細な実装手順・設定例・サンプルコード
- **ADR_007**: エラーハンドリング統一方針（ログ出力との連携）
- **ADR_010**: 実装規約（コメントとログの使い分け）

## レビュー履歴

| 日付 | レビュー者 | 結果 | コメント |
|------|------------|------|----------|
| 2025-07-06 | プロジェクトオーナー | 承認 | 層別責務分離と構造化ログが適切 |
| 2025-07-27 | Claude Code | 合理化 | サンプルコードをログ出力実装ガイドに移管・決定事項に集約 |

---

**承認者**: プロジェクトオーナー  
**承認日**: 2025-07-06  
**合理化日**: 2025-07-27