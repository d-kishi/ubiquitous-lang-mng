# ADR_017: ログ管理実装戦略

**ステータス**: 承認済み
**決定日**: 2025-09-19
**決定者**: プロジェクトオーナー
**記録者**: Claude Code
**関連ADR**: ADR_008_ログ出力指針

## 背景・課題

### Phase A9完了後のログ管理基盤整備
- **技術基盤確立**: Clean Architecture 97点達成後の運用品質向上
- **開発効率化**: Console.WriteLineの技術負債解消・統一ログ管理
- **問題追跡強化**: 認証システム・F#↔C#境界での問題調査効率化

### ADR_008実装の現実的段階化
- **既存投資活用**: Microsoft.Extensions.Logging基盤継続使用
- **段階的改善**: Serilog移行は将来課題・現状最適化を優先
- **即効性重視**: 90分での実装完了・即座の効果実現

### 現状分析に基づく課題特定
- **設定最適化**: appsettings.jsonの基本設定のみ→構造化設定
- **技術負債**: Console.WriteLine 10ファイル散在→ILogger統一
- **実装格差**: Infrastructure層252箇所・Web層57箇所のログ実装済み
- **品質担保**: 0警告0エラー・106テスト成功状態の継続維持

## 決定事項

### 1. ログ管理戦略

#### 1.1 基本方針
- **継続技術**: Microsoft.Extensions.Logging維持（投資継続・学習コスト最小化）
- **段階実装**: 即効性重視・90分完了・実用性優先
- **品質担保**: 各段階でのビルド確認・テスト実行・0警告0エラー維持

#### 1.2 ADR_008準拠実装
- **層別責務**: Domain層（ログなし）・Application/Infrastructure/Web層（適切な役割）
- **構造化ログ**: テンプレート形式活用・検索性向上・パフォーマンス最適化
- **レベル戦略**: 本番Information以上・開発Debug以上・Microsoft系Warning以上

### 2. 実装範囲・優先順位

#### 2.1 最優先実装箇所
1. **認証処理**: ログイン成功/失敗・パスワード変更・権限エラー
2. **エラーハンドリング**: GlobalExceptionMiddleware・未処理例外
3. **F#境界**: TypeConverter処理・Application層呼び出し
4. **データアクセス**: Repository操作結果・データベース接続状態

#### 2.2 技術負債解消
- **Console.WriteLine削除**: 10ファイル→ILoggerへ統一
- **デバッグログ統一**: 開発時情報をLogDebugに統一
- **設定体系化**: 環境別・カテゴリ別の明確なログレベル管理

### 3. SubAgent活用戦略

#### 3.1 並列実装による効率化
- **csharp-web-ui**: Web層ログ追加（認証UI・ミドルウェア）
- **csharp-infrastructure**: Infrastructure層ログ追加（Repository・Services）
- **contracts-bridge**: F#↔C#境界ログ追加（TypeConverter）
- **code-review**: 全体品質確認・実装統一性検証

#### 3.2 品質担保プロセス
- **段階的ビルド**: 各Phase後にdotnet build実行
- **テスト継続**: 106テスト成功状態維持
- **パフォーマンス確認**: ログ出力によるオーバーヘッド測定

### 4. 設定戦略

#### 4.1 本番環境設定
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning",
      "Microsoft.Hosting.Lifetime": "Information",
      "UbiquitousLanguageManager": "Information"
    }
  }
}
```

#### 4.2 開発環境設定
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft": "Information",
      "Microsoft.AspNetCore": "Debug",
      "Microsoft.EntityFrameworkCore": "Debug",
      "UbiquitousLanguageManager": "Debug"
    },
    "Console": {
      "IncludeScopes": true,
      "TimestampFormat": "[HH:mm:ss] "
    }
  }
}
```

## 技術的根拠

### Microsoft.Extensions.Logging継続の利点
1. **既存投資**: 309箇所の実装済みログ活用・学習済み技術継続
2. **.NET統合**: ASP.NET Core・EF Core・Blazor Serverとの完全統合
3. **パフォーマンス**: 高性能・構造化ログ対応・非同期出力

### 段階実装の効果
1. **即効性**: 90分で完了・即座の問題追跡効率向上
2. **リスク軽減**: 小刻みなビルド確認・既存機能への影響最小化
3. **継続改善**: Serilog移行等の将来拡張への基盤確立

## 実装影響

### 開発効率への影響
- **初期コスト**: 90分の実装時間
- **即効メリット**: Console.WriteLine統一・問題追跡効率向上・開発体験改善

### システム性能への影響
- **ログ出力コスト**: 1-2%のオーバーヘッド（最小限）
- **最適化**: 適切なレベル設定・構造化ログテンプレート活用

### 品質への影響
- **保守性向上**: 統一ログ管理・層別責務明確化
- **問題解決**: 認証・F#境界での問題追跡能力向上
- **技術負債削減**: Console.WriteLine完全削除・開発規約準拠

## 実装計画

### Phase 1: 設定・ドキュメント（30分）
- ADR_017作成・appsettings.json最適化・ガイドライン作成

### Phase 2: Program.cs修正（15分）
- ログプロバイダー明示化・環境別設定・ビルド確認

### Phase 3: SubAgent並列実装（30分）
- 3 SubAgent並列実行・重要箇所ログ追加・境界処理強化

### Phase 4: 品質確認（15分）
- Console.WriteLine削除・最終ビルド・テスト実行・パフォーマンス確認

## 成功基準

### 品質基準
- ✅ 0警告0エラー継続維持
- ✅ 106テスト全成功
- ✅ Console.WriteLine完全削除

### 機能基準
- ✅ 認証処理ログ出力確認
- ✅ エラーハンドリングログ強化
- ✅ F#境界ログ追加
- ✅ 開発環境でのログ可視性向上

### 効率基準
- ✅ 90分以内完了
- ✅ パフォーマンス影響2%以下
- ✅ 問題追跡効率向上体感

## 関連文書

- **ADR_008**: ログ出力指針（基本方針・層別責務）
- **GitHub Issue #24**: TECH-010 ログ管理方針設計・実装
- **Logging_Guidelines.md**: 実装ガイドライン（本ADR実装後作成）

## レビュー履歴

| 日付 | レビュー者 | 結果 | コメント |
|------|------------|------|----------|
| 2025-09-19 | プロジェクトオーナー | 承認 | 段階実装・SubAgent活用・品質担保が適切 |

---

**承認者**: プロジェクトオーナー
**承認日**: 2025-09-19
**実装予定**: 2025-09-19（90分）