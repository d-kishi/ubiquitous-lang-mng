# ADR-018: SubAgent指示改善とFix-Mode活用

## ステータス
承認済み

## 決定日
2025-09-30

## 文脈

### Phase B1 Step3での学習・改善実績
2025-09-30のPhase B1 Step3 Application層実装完了時において、以下の重要な改善知見を獲得：

#### 1. Fix-Mode活用による効率化成功
- **修正対象**: Contracts層構文エラー9件（8件 + XMLコメント1件）
- **実行時間**: 15分で全修正完了（従来手法の1/3時間）
- **成功要因**: contracts-bridge Agent責務分担・専門性活用
- **品質向上**: 構文チェック精度向上・C#規約完全準拠

#### 2. SubAgent並列実行成功
- **実行Agent**: fsharp-application + contracts-bridge + unit-test
- **品質達成**: 仕様準拠度95点・TDD実践優秀評価
- **責務分担**: F#実装・C#境界・テスト基盤の専門性活用

#### 3. エラー修正プロセス改善の必要性
従来のFix-Mode指示では以下の課題が存在：
- **指示の抽象性**: エラー箇所の曖昧な指示
- **参考情報不足**: 既存コードパターンの提示不足
- **段階的確認不足**: 各SubAgent完了後の個別ビルド確認未実施

### 将来の再発リスク評価
**リスクレベル: 高**

**Step4 Infrastructure層実装**:
- C# EF Core実装での複雑な構文エラー
- F#↔C#境界でのOption/Result型変換エラー
- トランザクション処理での原子性保証実装エラー

**Step5 Web層実装**:
- Blazor Componentsライフサイクルエラー
- SignalR統合でのリアルタイム通信エラー
- 権限制御UI実装での複雑な条件分岐エラー

## 決定内容

### 1. Fix-Mode指示テンプレートの標準化

#### 標準フォーマット
```markdown
[SubAgent名] Agent, Fix-Mode: [エラー種別]エラーを修正してください。

## 修正対象エラー詳細
**ファイル**: [ファイルパス]:[行番号]
**エラーコード**: [CS1234など]
**エラーメッセージ**: [完全なエラーメッセージ]

## 修正指示
```csharp
// 修正前（エラー）
[具体的なエラーコード]

// 修正後（正しい）
[期待される正しいコード]
```

## 参考実装
[既存の類似正常コードの例]

## 重要な制約事項
- **ロジック変更禁止**: 構文エラーの修正のみ実施
- **既存パターン準拠**: 他の同種実装の命名規則に従う
- **構文規約遵守**: C#/F#の言語仕様・プロジェクト規約完全準拠

修正完了後、[N]件のエラーが解消されることを確認してください。
```

### 2. SubAgent指示明確化ガイドライン

#### 事前情報提供（必須）
1. **対象ファイル完全パス**: プロジェクト内の正確な位置
2. **エラー完全メッセージ**: ビルド出力から直接引用
3. **影響範囲明示**: 修正対象の具体的スコープ

#### 具体的修正内容（必須）
1. **行番号レベル指示**: 具体的な修正箇所の特定
2. **修正前後コード例**: 期待される変更の明示
3. **期待結果明示**: 修正後の動作・状態の説明

#### 参考情報提供（推奨）
1. **既存正常コード**: 同種の正しい実装例
2. **適用パターン**: プロジェクト内の標準パターン
3. **回避すべき事項**: アンチパターン・禁止事項

### 3. エラー修正責務判定フロー（強化版）

#### Step1: エラー分析（必須実行）
```markdown
1. エラーメッセージから問題の本質を特定
2. 影響範囲（ファイル数・修正規模）の評価
3. 修正に必要な専門知識の判定
```

#### Step2: SubAgent選定（必須実行）
```markdown
- F# Domain/Application層エラー → fsharp-domain/fsharp-application
- F#↔C#境界・型変換エラー → contracts-bridge
- C# Infrastructure/Web層エラー → csharp-infrastructure/csharp-web-ui
- テストコードエラー → unit-test/integration-test
- ビルド・設定エラー → general-purpose
```

#### Step3: Fix-Mode実行（改善版）
```markdown
1. 標準テンプレート使用による指示作成
2. SubAgent実行・修正実施
3. 個別ビルド確認（段階的品質確認）
4. 全体ビルド確認・エラー解消確認
```

### 4. 段階的品質確認プロセス

#### 修正完了後の必須確認事項
1. **個別プロジェクトビルド**: 修正対象プロジェクトのみ先行確認
2. **依存関係ビルド**: 関連プロジェクトの影響確認
3. **全体ビルド確認**: 0 Warning/0 Error達成確認
4. **テスト実行確認**: 既存テストへの影響確認

#### エラー残存時の対応手順
1. **エラー種別再判定**: 見落としたエラーの分析
2. **追加修正指示**: より具体的な指示での再実行
3. **必要に応じた別SubAgent活用**: 専門性不適合時の変更

## 実装詳細

### 1. SubAgent実行ガイドライン文書作成
- **作成場所**: `/Doc/08_Organization/Rules/SubAgent実行ガイドライン.md`
- **内容**: 選択フローチャート・責務判定手順・指示テンプレート集

### 2. development_guidelinesメモリー更新
- **更新内容**: Fix-Mode改善ポイントの詳細化・具体的指示テンプレート追加
- **成功事例記録**: Step3での実際の修正例・効果測定結果

### 3. 定期的な効果測定
- **Fix-Mode成功率**: 修正一回で完了する割合（目標95%以上）
- **修正時間効率**: 従来手法との比較（目標1/3時間以下）
- **エラー再発率**: 同種エラーの再発頻度（目標5%以下）

## 期待される効果

### 短期効果（Step4-5）
- **エラー修正効率**: 50%向上
- **SubAgent責務違反**: 0件維持
- **Fix-Mode成功率**: 95%以上達成
- **作業時間短縮**: エラー修正時間の大幅短縮

### 中長期効果（Phase B完了後）
- **知見の永続化**: 将来のPhaseでも活用可能な改善体系確立
- **プロセス品質向上**: 継続的な改善サイクルの確立
- **開発効率最大化**: エラー修正による作業中断の最小化

### 品質向上効果
- **構文規約遵守**: プロジェクト全体の一貫性向上
- **専門性活用**: 各SubAgentの専門知識最大活用
- **トレーサビリティ**: 修正過程の完全な追跡可能性

## 監視指標

### 定量指標
- Fix-Mode成功率: 95%以上
- エラー修正時間: 15分以下（9件修正基準）
- ビルド成功率: 修正後100%
- SubAgent責務違反件数: 0件

### 定性指標
- 指示明確性の向上
- SubAgent理解度の向上
- 修正品質の向上
- プロセス遵守度の維持

## 参照

### 関連ADR
- `ADR_016_プロセス遵守違反防止策.md`: 基本的なプロセス遵守原則
- 将来作成予定: `ADR_019_SubAgent並列実行最適化`

### 関連文書
- `/Doc/08_Organization/Rules/SubAgent実行ガイドライン.md`（新規作成）
- `/Doc/08_Organization/Rules/組織管理運用マニュアル.md`
- `development_guidelines`メモリー

### 適用範囲
- 全Phase・全Step
- 全SubAgent実行時のエラー修正
- Fix-Mode活用時の標準プロセス

## 改訂履歴
- 2025-09-30: 初版作成（Phase B1 Step3改善実績を基に）

---

**この決定は、SubAgent活用効率化と品質向上の両立を実現するための重要な基盤であり、Step4以降で継続的に活用・改善されるべきである。**