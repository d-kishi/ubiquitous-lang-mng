# TECH-004: 初回ログイン時パスワード変更機能未実装

**発見日**: 2025-08-06  
**報告者**: プロジェクトオーナー  
**優先度**: High（Phase B1着手前修正）  
**ステータス**: 未対応  

## 問題概要

初回ログイン時の必須パスワード変更機能が実装されていない。また、UI設計書に仕様の誤記がある。

## 詳細

### 仕様（機能仕様書 2.1.2）
- **要件**: 初回ログイン時はパスワード変更必須（**全ユーザー共通**）
- **対象**: スーパーユーザーを含む全てのユーザー

### 現在の実装
- 初回ログイン後もパスワード変更画面に遷移しない
- 通常のホーム画面に遷移してしまう

### ドキュメントの誤記
- **誤記箇所**: `/Doc/02_Design/UI設計/01_認証・ユーザー管理画面設計.md`
- **誤記内容**: 「初回ログイン: スーパーユーザー以外は必須実行」
- **正しい内容**: 「初回ログイン: 全ユーザー必須実行」

## 影響範囲

1. **実装対象**
   - ログイン処理後の遷移ロジック
   - ユーザーの初回ログインフラグ管理
   - パスワード変更完了後のフラグ更新

2. **データベース**
   - Usersテーブルの`IsFirstLogin`フィールドの活用
   - 初期データの`IsFirstLogin`設定確認

3. **修正対象ファイル**
   - 認証サービスのログイン処理
   - ログイン後のリダイレクト処理
   - UI設計書の誤記修正

## 修正方針

### 実装手順
1. **初回ログイン判定処理の実装**
   - ログイン成功後に`IsFirstLogin`フラグをチェック
   - trueの場合はパスワード変更画面へリダイレクト

2. **パスワード変更完了処理**
   - パスワード変更成功時に`IsFirstLogin`をfalseに更新
   - 通常のホーム画面へリダイレクト

3. **セッション管理**
   - 初回ログイン中の他画面へのアクセス制限
   - パスワード変更を完了するまで他機能の利用不可

4. **ドキュメント修正**
   - UI設計書の誤記を修正

### テスト項目
- 新規ユーザーの初回ログイン動作
- スーパーユーザーの初回ログイン動作
- パスワード変更後の通常ログイン動作
- 初回ログイン中の直接URL アクセス制限

## 関連Issue
- TECH-001: ASP.NET Core Identity設計見直し
- TECH-002: 初期スーパーユーザーパスワード仕様不整合
- TECH-003: ログイン画面の重複と統合

## 対応予定
Phase B1着手前（2025-08-06～08-07予定）