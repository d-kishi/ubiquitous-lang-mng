@page "/projects/{ProjectId:guid}/members"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using UbiquitousLanguageManager.Application.ProjectManagement
@using UbiquitousLanguageManager.Domain.Common
@attribute [Authorize(Roles = "SuperUser,ProjectManager")]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IProjectManagementService ProjectManagementService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>プロジェクトメンバー管理</PageTitle>

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h1>プロジェクトメンバー管理</h1>
                <button class="btn btn-secondary" @onclick="NavigateBack">
                    <i class="bi bi-arrow-left"></i> 戻る
                </button>
            </div>

            @* エラーメッセージ表示 *@
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert" data-testid="member-error-message">
                    <i class="bi bi-exclamation-triangle-fill"></i> @errorMessage
                    <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
                </div>
            }

            @* 成功メッセージ表示 *@
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill"></i> @successMessage
                    <button type="button" class="btn-close" @onclick="@(() => successMessage = null)"></button>
                </div>
            }

            @* ローディング表示 *@
            @if (isLoading)
            {
                <div class="d-flex justify-content-center my-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                </div>
            }
            else
            {
                @* メンバー追加セクション *@
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-person-plus"></i> メンバー追加</h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <ProjectMemberSelector
                                    ExistingMemberIds="@memberIds"
                                    OnMemberSelected="HandleMemberSelected" />
                            </div>
                            <div class="col-md-4">
                                <button
                                    class="btn btn-primary w-100"
                                    @onclick="AddMemberAsync"
                                    disabled="@(selectedUserId == null || isProcessing)"
                                    data-testid="member-add-button">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                        <span>処理中...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-plus-circle"></i>
                                        <span>メンバーを追加</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                @* メンバー一覧セクション *@
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="bi bi-people"></i> 現在のメンバー (@members.Count)</h5>
                    </div>
                    <div class="card-body">
                        @if (members.Count == 0)
                        {
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle"></i> 現在、このプロジェクトにメンバーはいません。
                            </div>
                        }
                        else
                        {
                            <div class="row" data-testid="member-list">
                                @foreach (var member in members)
                                {
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <ProjectMemberCard
                                            Member="@member"
                                            OnRemove="HandleRemoveMember"
                                            IsProcessing="@isProcessing" />
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // ================================================================================
    // Parameters
    // ================================================================================

    /// <summary>
    /// プロジェクトID（URLパラメータ）
    /// 【Blazor Server初学者向け解説】
    /// [Parameter]属性により、URLから渡されるパラメータを受け取ります。
    /// </summary>
    [Parameter]
    public Guid ProjectId { get; set; }

    // ================================================================================
    // Fields
    // ================================================================================

    /// <summary>
    /// メンバー一覧
    /// 【Blazor Server初学者向け解説】
    /// プロジェクトに所属するユーザーのIDリストを保持します。
    /// UserId型はF# Domain層の型で、int64をラップした型です。
    /// </summary>
    private List<UserId> memberIds = new();

    /// <summary>
    /// 表示用メンバー情報
    /// 【データ変換パターン】
    /// F#のUserId型からC#で扱いやすい形式に変換したデータを保持します。
    /// </summary>
    private List<MemberInfo> members = new();

    /// <summary>
    /// 選択されたユーザーID
    /// </summary>
    private Guid? selectedUserId = null;

    /// <summary>
    /// ローディング状態
    /// 【Blazor Server初学者向け解説】
    /// データ取得中はtrueとなり、UIでローディング表示を行います。
    /// </summary>
    private bool isLoading = true;

    /// <summary>
    /// 処理中状態
    /// 【Blazor Server初学者向け解説】
    /// メンバー追加・削除処理中はtrueとなり、重複実行を防ぎます。
    /// </summary>
    private bool isProcessing = false;

    /// <summary>
    /// エラーメッセージ
    /// </summary>
    private string? errorMessage = null;

    /// <summary>
    /// 成功メッセージ
    /// </summary>
    private string? successMessage = null;

    /// <summary>
    /// 現在のユーザーID
    /// </summary>
    private Guid currentUserId;

    /// <summary>
    /// 現在のユーザーロール
    /// 【F#初学者向け解説】
    /// F# Domain層のRole型（enum）をC#で使用します。
    /// Null非許容型のため、デフォルト値を設定する必要があります。
    /// </summary>
    private Role currentUserRole = Role.GeneralUser;

    // ================================================================================
    // Lifecycle Methods
    // ================================================================================

    /// <summary>
    /// コンポーネント初期化処理
    /// 【Blazor Server初学者向け解説】
    /// OnInitializedAsyncは、コンポーネントが初めてレンダリングされる際に一度だけ実行されます。
    /// Blazor Serverでは、この間クライアントは待機状態となり、SignalR接続を介してサーバー側の処理完了を待ちます。
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 現在のユーザー情報を取得
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated != true)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            // ユーザーIDとロールを取得
            var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            if (userIdClaim != null && Guid.TryParse(userIdClaim.Value, out var userId))
            {
                currentUserId = userId;
            }

            // ロール判定
            if (user.IsInRole("SuperUser"))
            {
                currentUserRole = Role.SuperUser;
            }
            else if (user.IsInRole("ProjectManager"))
            {
                currentUserRole = Role.ProjectManager;
            }
            else
            {
                // 権限不足の場合はエラー表示
                errorMessage = "この機能を使用する権限がありません。";
                isLoading = false;
                return;
            }

            // メンバー一覧を読み込み
            await LoadMembersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"初期化中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            isLoading = false;

            // 【Blazor Server初学者向け解説】
            // StateHasChanged(): UIの再描画を明示的に指示します。
            // Blazor Serverでは、サーバー側の状態変更をクライアントに通知するために必要です。
            // SignalR接続を通じて、クライアントのDOMが更新されます。
            StateHasChanged();
        }
    }

    // ================================================================================
    // Data Loading
    // ================================================================================

    /// <summary>
    /// メンバー一覧読み込み
    /// 【F#統合パターン】
    /// F# Application層のIProjectManagementServiceを呼び出し、Result型の結果を処理します。
    /// </summary>
    private async Task LoadMembersAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // F# Application層のQuery実行
            // 【F#初学者向け解説】
            // F# Record型はコンストラクタベース初期化が必須です。
            // オブジェクト初期化子構文（{ ... }）は使用できません。
            // 名前付き引数（camelCase）を使用してコンストラクタを呼び出します。
            var query = new GetProjectMembersQuery(
                projectId: ProjectId,
                userId: currentUserId,
                userRole: currentUserRole
            );

            var result = await ProjectManagementService.GetProjectMembersAsync(query);

            // 【F#初学者向け解説】
            // Result型のエラーハンドリング: Railway-oriented Programmingパターン
            // F#のResult<'T, 'TError>型は、成功時の値またはエラーメッセージを型安全に扱います。
            // IsOkプロパティで成功・失敗を判定し、適切な処理を行います。
            if (result.IsOk)
            {
                // 成功時: UserIdリストを取得
                memberIds = result.ResultValue.ToList();

                // TODO: 実際のアプリケーションでは、ユーザー詳細情報を取得するサービスを呼び出します
                // 現在は簡易的な実装として、UserIdのみを使用します
                members = memberIds.Select(userId => new MemberInfo
                {
                    UserId = userId,
                    UserName = $"ユーザー {userId.Item}",  // F# UserId型のItemプロパティ
                    Email = $"user{userId.Item}@example.com",
                    RoleName = "未取得"
                }).ToList();

                errorMessage = null;
            }
            else
            {
                // エラー時: エラーメッセージを表示
                errorMessage = result.ErrorValue;
                members.Clear();
                memberIds.Clear();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"メンバー一覧の読み込み中にエラーが発生しました: {ex.Message}";
            members.Clear();
            memberIds.Clear();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // ================================================================================
    // Event Handlers
    // ================================================================================

    /// <summary>
    /// メンバー選択時のイベントハンドラー
    /// 【イベント駆動パターン】
    /// ProjectMemberSelectorコンポーネントから選択されたユーザーIDを受け取ります。
    /// </summary>
    private void HandleMemberSelected(Guid? userId)
    {
        selectedUserId = userId;
        StateHasChanged();
    }

    /// <summary>
    /// メンバー追加処理
    /// 【F#統合パターン】
    /// F# Application層のCommandを実行し、Result型の結果を処理します。
    /// </summary>
    private async Task AddMemberAsync()
    {
        if (selectedUserId == null)
        {
            errorMessage = "追加するユーザーを選択してください。";
            return;
        }

        try
        {
            isProcessing = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            // F# Application層のCommand実行
            // 【F#初学者向け解説】
            // F# Record型（AddMemberToProjectCommand）のコンストラクタベース初期化パターン。
            // fsharp-csharp-bridge Skillパターン準拠：
            //   - コンストラクタ引数は小文字camelCase（projectId, userId等）
            //   - 名前付き引数で可読性確保
            //   - オブジェクト初期化子構文（{ ... }）は使用不可
            var command = new AddMemberToProjectCommand(
                projectId: ProjectId,
                userId: selectedUserId.Value,
                operatorUserId: currentUserId,
                operatorRole: currentUserRole
            );

            var result = await ProjectManagementService.AddMemberToProjectAsync(command);

            // 【F#初学者向け解説】
            // Result型のパターンマッチング: 成功・失敗で異なる処理を実行
            if (result.IsOk)
            {
                // 成功時: メンバー一覧を再読み込み
                successMessage = "メンバーを追加しました。";
                selectedUserId = null;
                await LoadMembersAsync();
            }
            else
            {
                // エラー時: エラーメッセージを表示
                // 重複追加の場合などは、F# Application層から適切なエラーメッセージが返されます
                errorMessage = result.ErrorValue;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"メンバー追加中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// メンバー削除イベントハンドラー
    /// 【イベント駆動パターン】
    /// ProjectMemberCardコンポーネントから削除要求を受け取ります。
    /// </summary>
    private async Task HandleRemoveMember(UserId userId)
    {
        try
        {
            isProcessing = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            // 削除確認（JavaScript Interop）
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
                "このメンバーをプロジェクトから削除してもよろしいですか？");

            if (!confirmed)
            {
                isProcessing = false;
                return;
            }

            // F# Application層のCommand実行
            // 【F#型変換パターン】
            // F# UserId型のItemプロパティからint64値を取得し、GuidのHashCodeを使用して変換します
            // 注意: この変換はTDD段階の一時的な実装です。本番環境では適切な変換ロジックが必要です
            var userGuid = Guid.NewGuid(); // TODO: 実際のユーザーGUIDを取得

            // 【F#初学者向け解説】
            // F# Record型（RemoveMemberFromProjectCommand）のコンストラクタベース初期化パターン。
            // fsharp-csharp-bridge Skillパターン準拠：
            //   - コンストラクタ引数は小文字camelCase（projectId, userId等）
            //   - すべてのフィールドを名前付き引数で指定
            //   - オブジェクト初期化子構文（{ ... }）は読み取り専用プロパティのため使用不可
            var command = new RemoveMemberFromProjectCommand(
                projectId: ProjectId,
                userId: userGuid,
                operatorUserId: currentUserId,
                operatorRole: currentUserRole
            );

            var result = await ProjectManagementService.RemoveMemberFromProjectAsync(command);

            // Result型のエラーハンドリング
            if (result.IsOk)
            {
                // 成功時: メンバー一覧を再読み込み
                successMessage = "メンバーを削除しました。";
                await LoadMembersAsync();
            }
            else
            {
                // エラー時: エラーメッセージを表示
                // 最後の管理者削除防止などのビジネスルールエラーが返されます
                errorMessage = result.ErrorValue;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"メンバー削除中にエラーが発生しました: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// 戻るボタンクリック
    /// </summary>
    private void NavigateBack()
    {
        Navigation.NavigateTo($"/projects/{ProjectId}/edit");
    }

    // ================================================================================
    // Helper Classes
    // ================================================================================

    /// <summary>
    /// メンバー情報表示用クラス
    /// 【データ変換パターン】
    /// F# Domain層のUserId型から、C# UIレイヤーで扱いやすい形式に変換したデータを保持します。
    /// </summary>
    private class MemberInfo
    {
        public UserId UserId { get; set; } = default!;
        public string UserName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string RoleName { get; set; } = string.Empty;
    }
}

@*
【Blazor Server初学者向け総合解説】

このProjectMembers.razorコンポーネントは、プロジェクトメンバー管理機能を提供します。

主要な技術要素：
1. **Blazor Serverライフサイクル**:
   - OnInitializedAsync: 初回レンダリング時の非同期初期化
   - StateHasChanged(): サーバー側状態変更のクライアント通知

2. **F#型統合パターン**:
   - Result型: Railway-oriented Programmingによるエラーハンドリング
   - UserId型: F# Domain層の型をC#で使用
   - Command/Queryパターン: CQRS設計の実践

3. **SignalR接続**:
   - Blazor Serverは、クライアントとサーバーをSignalRで接続
   - StateHasChanged()により、サーバー側の状態変更がクライアントに自動反映

4. **認証・認可統合**:
   - [Authorize]属性: SuperUser/ProjectManagerロールのみアクセス可能
   - AuthenticationStateProvider: 現在のユーザー情報取得

5. **data-testid属性**:
   - E2Eテスト（Playwright）での要素特定用
   - member-add-button, member-delete-button, member-list, member-error-message

重要な実装パターン：
- **エラーハンドリング**: Result型により、例外ではなく型安全なエラー処理
- **状態管理**: isLoading, isProcessingによる適切なUI制御
- **子コンポーネント統合**: ProjectMemberSelector, ProjectMemberCardの連携

このコンポーネントは、Clean Architectureの原則に従い、
UIロジックのみを担当し、ビジネスロジックはF# Application層に委譲しています。
*@
