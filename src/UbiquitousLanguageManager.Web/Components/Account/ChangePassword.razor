@page "/Account/ChangePassword"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Authorization
@using System.ComponentModel.DataAnnotations
@using UbiquitousLanguageManager.Infrastructure.Data.Entities
@inject UserManager<ApplicationUser> UserManager
@inject ILogger<ChangePassword> Logger
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ - ãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </PageTitle>

<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-key me-2"></i>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                    </h3>
                    @if (isFirstLogin)
                    {
                        <small class="text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã®ãŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…è¦ã§ã™
                        </small>
                    }
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>@errorMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>@successMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <EditForm Model="model" OnValidSubmit="HandleChangePassword" FormName="ChangePasswordForm">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">
                                <i class="fas fa-lock me-1"></i>ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                            </label>
                            <div class="input-group">
                                <InputText id="currentPassword" 
                                          @bind-Value="model.CurrentPassword" 
                                          type="@(showCurrentPassword ? "text" : "password")"
                                          class="form-control" 
                                          placeholder="ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        @onclick="() => showCurrentPassword = !showCurrentPassword">
                                    <i class="fas @(showCurrentPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="() => model.CurrentPassword" class="text-danger" />
                        </div>

                        <div class="mb-3">
                            <label for="newPassword" class="form-label">
                                <i class="fas fa-key me-1"></i>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                            </label>
                            <div class="input-group">
                                <InputText id="newPassword" 
                                          @bind-Value="model.NewPassword" 
                                          type="@(showNewPassword ? "text" : "password")"
                                          class="form-control" 
                                          placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        @onclick="() => showNewPassword = !showNewPassword">
                                    <i class="fas @(showNewPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="() => model.NewPassword" class="text-danger" />
                            <div class="form-text">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    8æ–‡å­—ä»¥ä¸Šã€è‹±æ•°å­—ã‚’å«ã‚€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„
                                </small>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">
                                <i class="fas fa-key me-1"></i>æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰
                            </label>
                            <div class="input-group">
                                <InputText id="confirmPassword" 
                                          @bind-Value="model.ConfirmPassword" 
                                          type="@(showConfirmPassword ? "text" : "password")"
                                          class="form-control" 
                                          placeholder="ç¢ºèªã®ãŸã‚å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„" />
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        @onclick="() => showConfirmPassword = !showConfirmPassword">
                                    <i class="fas @(showConfirmPassword ? "fa-eye-slash" : "fa-eye")"></i>
                                </button>
                            </div>
                            <ValidationMessage For="() => model.ConfirmPassword" class="text-danger" />
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" 
                                    class="btn btn-primary btn-lg" 
                                    disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    <text>å¤‰æ›´ä¸­...</text>
                                }
                                else
                                {
                                    <i class="fas fa-save me-2"></i>
                                    <text>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</text>
                                }
                            </button>

                            @if (!isFirstLogin)
                            {
                                <button type="button" 
                                        class="btn btn-outline-secondary" 
                                        @onclick="NavigateBack"
                                        disabled="@isProcessing">
                                    <i class="fas fa-arrow-left me-2"></i>æˆ»ã‚‹
                                </button>
                            }
                        </div>
                    </EditForm>
                </div>
            </div>

            @if (isFirstLogin)
            {
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-info-circle me-2"></i>åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã«ã¤ã„ã¦</h6>
                    <p class="mb-0">
                        ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šã®ãŸã‚ã€åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãŒå¿…é ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚<br>
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å®Œäº†å¾Œã€ã‚·ã‚¹ãƒ†ãƒ ã®å…¨æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
                    </p>
                </div>
            }
        </div>
    </div>
</div>

@code {
    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ‡ãƒ«
    /// </summary>
    public class ChangePasswordModel
    {
        [Required(ErrorMessage = "ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")]
        [Display(Name = "ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")]
        public string CurrentPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")]
        [StringLength(100, ErrorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯{2}æ–‡å­—ä»¥ä¸Š{1}æ–‡å­—ä»¥ä¸‹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", MinimumLength = 8)]
        [Display(Name = "æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")]
        public string NewPassword { get; set; } = string.Empty;

        [Required(ErrorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")]
        [Compare("NewPassword", ErrorMessage = "æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚")]
        [Display(Name = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    private ChangePasswordModel model = new();
    private string? errorMessage;
    private string? successMessage;
    private bool isProcessing = false;
    private bool isFirstLogin = false;
    private ApplicationUser? currentUser;

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆç”¨ãƒ•ãƒ©ã‚°
    private bool showCurrentPassword = false;
    private bool showNewPassword = false;
    private bool showConfirmPassword = false;

    /// <summary>
    /// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å‡¦ç†
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ğŸ” ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                var userEmail = authState.User.Identity.Name;
                if (!string.IsNullOrEmpty(userEmail))
                {
                    currentUser = await UserManager.FindByEmailAsync(userEmail);
                    if (currentUser != null)
                    {
                        isFirstLogin = currentUser.IsFirstLogin;
                        Logger.LogInformation("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢è¡¨ç¤º: {UserId}, IsFirstLogin: {IsFirstLogin}", 
                            currentUser.Id, isFirstLogin);
                    }
                }
            }

            if (currentUser == null)
            {
                Logger.LogWarning("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—å¤±æ•—");
                Navigation.NavigateTo("/login", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: {Message}", ex.Message);
            errorMessage = "ç”»é¢ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
        }
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ï¼ˆTECH-004å¯¾å¿œï¼‰
    /// </summary>
    private async Task HandleChangePassword()
    {
        if (currentUser == null)
        {
            errorMessage = "ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
            return;
        }

        isProcessing = true;
        errorMessage = null;
        successMessage = null;

        try
        {
            // ğŸ” ASP.NET Core Identity ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å®Ÿè¡Œ
            var result = await UserManager.ChangePasswordAsync(currentUser, model.CurrentPassword, model.NewPassword);

            if (result.Succeeded)
            {
                // âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æˆåŠŸ â†’ IsFirstLoginãƒ•ãƒ©ã‚°æ›´æ–°ï¼ˆTECH-004ä»•æ§˜å¯¾å¿œï¼‰
                if (currentUser.IsFirstLogin)
                {
                    currentUser.IsFirstLogin = false;
                    currentUser.UpdatedAt = DateTime.UtcNow;
                    currentUser.UpdatedBy = currentUser.Email ?? "System";
                    currentUser.InitialPassword = null; // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æƒ…å ±å‰Šé™¤

                    var updateResult = await UserManager.UpdateAsync(currentUser);
                    if (!updateResult.Succeeded)
                    {
                        Logger.LogError("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾Œã®ãƒ•ãƒ©ã‚°æ›´æ–°å¤±æ•—: {UserId}, Errors: {Errors}",
                            currentUser.Id, string.Join(", ", updateResult.Errors.Select(e => e.Description)));
                        errorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯æˆåŠŸã—ã¾ã—ãŸãŒã€ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                        return;
                    }

                    Logger.LogInformation("åˆå›ãƒ­ã‚°ã‚¤ãƒ³ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å®Œäº†: {UserId}", currentUser.Id);
                }

                Logger.LogInformation("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æˆåŠŸ: {UserId}", currentUser.Id);
                successMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚";

                // ğŸ¯ æˆåŠŸæ™‚ã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆ3ç§’å¾Œï¼‰
                _ = Task.Delay(3000).ContinueWith(_ => 
                {
                    InvokeAsync(() => Navigation.NavigateTo("/", forceLoad: true));
                });
            }
            else
            {
                // âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¤±æ•—
                var errors = string.Join(", ", result.Errors.Select(e => e.Description));
                Logger.LogWarning("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¤±æ•—: {UserId}, Errors: {Errors}", currentUser.Id, errors);
                errorMessage = $"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: {errors}";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ã‚¨ãƒ©ãƒ¼: {UserId}, {Message}", currentUser.Id, ex.Message);
            errorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚";
        }
        finally
        {
            isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    /// <summary>
    /// æˆ»ã‚‹ãƒœã‚¿ãƒ³å‡¦ç†
    /// </summary>
    private void NavigateBack()
    {
        if (!isFirstLogin)
        {
            Navigation.NavigateTo("/");
        }
    }
}