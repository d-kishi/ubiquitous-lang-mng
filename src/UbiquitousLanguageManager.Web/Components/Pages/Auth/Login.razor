@page "/login"
@layout LoginLayout
@using Microsoft.AspNetCore.Components.Authorization
@using UbiquitousLanguageManager.Web.Services
@using UbiquitousLanguageManager.Web.Models
@using UbiquitousLanguageManager.Web.Authentication
@inject AuthenticationService AuthService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>ãƒ­ã‚°ã‚¤ãƒ³ - ãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </PageTitle>

@* 
ã€Blazor Serveråˆå­¦è€…å‘ã‘è§£èª¬ã€‘
Blazor Serverã§ã®èªè¨¼ç”»é¢å®Ÿè£…ä¾‹ã§ã™ã€‚

ä¸»è¦æ¦‚å¿µï¼š
1. @page: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®šç¾©ï¼ˆ/loginã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
2. @inject: ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰ã‚µãƒ¼ãƒ“ã‚¹ã®å–å¾—
3. StateHasChanged(): UIå†æç”»ã®æ˜ç¤ºçš„ãªæŒ‡ç¤º
4. EditForm: Blazorã®åŒæ–¹å‘ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ•ã‚©ãƒ¼ãƒ 
5. IJSRuntime: JavaScriptç›¸äº’é‹ç”¨ï¼ˆã‚¨ãƒ©ãƒ¼é€šçŸ¥ç­‰ï¼‰
*@

<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <div class="text-center mb-4">
        <i class="fas fa-lock fa-3x text-primary mb-3"></i>
        <h2 class="h4 mb-0">ğŸ” ãƒ­ã‚°ã‚¤ãƒ³</h2>
      </div>
    </div>
    <div class="login-body">

      @* Blazorç‰ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  *@
      <EditForm Model="loginModel" OnValidSubmit="HandleLoginAsync" novalidate>
        <DataAnnotationsValidator />

        @* ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒãƒªãƒ¼ï¼ˆBlazorç‰ˆï¼‰ *@
        <ValidationSummary class="text-danger mb-3" />

        @* ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º *@
        @if (!string.IsNullOrEmpty(errorMessage))
        {
          <div class="alert alert-danger mb-3" role="alert">
            <i class="fas fa-exclamation-triangle me-1"></i>
            @errorMessage
          </div>
        }

        @* æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º *@
        @if (!string.IsNullOrEmpty(successMessage))
        {
          <div class="alert alert-success mb-3" role="alert">
            <i class="fas fa-check-circle me-1"></i>
            @successMessage
          </div>
        }

        <div class="mb-3">
          <label for="email" class="form-label">
            ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <InputText @bind-Value="loginModel.Email" class="form-control" id="email" placeholder="user@example.com"
            autocomplete="email" disabled="@isLoading" />
          <ValidationMessage For="() => loginModel.Email" class="text-danger small" />
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">
            ğŸ”’ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
          </label>
          <InputText @bind-Value="loginModel.Password" type="password" class="form-control" id="password"
            placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="current-password" disabled="@isLoading" />
          <ValidationMessage For="() => loginModel.Password" class="text-danger small" />
        </div>

        <div class="mb-4">
          <div class="form-check">
            <InputCheckbox @bind-Value="loginModel.RememberMe" class="form-check-input" id="rememberMe"
              disabled="@isLoading" />
            <label for="rememberMe" class="form-check-label">
              ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ä¿æŒ
            </label>
          </div>
        </div>

        <div class="d-grid mb-3">
          <button type="submit" class="btn btn-primary btn-lg btn-login" disabled="@isLoading">
            @if (isLoading)
            {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              <span>ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</span>
            }
            else
            {
              <span>ğŸš€ ãƒ­ã‚°ã‚¤ãƒ³</span>
            }
          </button>
        </div>

        <div class="text-center">
          <a href="/forgot-password" class="text-decoration-none">
            ğŸ”„ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
          </a>
        </div>
      </EditForm>
    </div>
  </div>
</div>

@if (isDevelopment)
{
  <div class="dev-info mt-3">
    <div class="card">
      <div class="card-body text-center">
        <small class="text-muted">
          <strong>é–‹ç™ºç’°å¢ƒãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:</strong><br>
          admin@example.com / Password123!
        </small>
      </div>
    </div>
  </div>
}

<style>
  .login-container {
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
  }

  .login-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 1rem;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    overflow: hidden;
  }

  .login-header {
    background: rgba(255, 255, 255, 0.1);
    padding: 2rem 1.5rem 1rem;
    text-align: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  }

  .login-body {
    padding: 2rem 0.5rem;
  }

  .form-control {
    border-radius: 0.5rem;
    border: 1px solid #e1e5e9;
    padding: 0.75rem 1rem;
    transition: all 0.15s ease-in-out;
  }

  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: transform 0.15s ease-in-out;
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-login {
    width: 600px;
  }

  .dev-info {
    max-width: 800px;
    margin: 0 auto;
  }

  @@media (max-width: 576px) {
    .login-card {
      margin: 1rem;
      max-width: none;
    }

    .login-header,
    .login-body {
      padding: 1.5rem 1rem;
    }
  }
</style>

@code {
  private LoginViewModel loginModel = new();
  private string? errorMessage;
  private string? successMessage;
  private bool isLoading = false;
  private bool isDevelopment = false;

  [Parameter, SupplyParameterFromQuery]
  public string? ReturnUrl { get; set; }

  /// <summary>
  /// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å‡¦ç†
  ///
  /// ã€Blazor Serveråˆå­¦è€…å‘ã‘è§£èª¬ã€‘
  /// OnInitializedAsync: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ¡ã‚½ãƒƒãƒ‰
  /// - ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒåˆæœŸåŒ–ã•ã‚Œã‚‹éš›ã«ä¸€åº¦ã ã‘å®Ÿè¡Œ
  /// - éåŒæœŸå‡¦ç†ãŒå¯èƒ½ï¼ˆasync/awaitå¯¾å¿œï¼‰
  /// - åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å‡¦ç†ã«ä½¿ç”¨
  /// </summary>
  protected override async Task OnInitializedAsync()
  {
    // é–‹ç™ºç’°å¢ƒåˆ¤å®š
    isDevelopment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") == "Development";

    // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    var authState = await AuthStateProvider.GetAuthenticationStateAsync();
    if (authState.User.Identity?.IsAuthenticated == true)
    {
      var redirectUrl = !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : "/";
      Navigation.NavigateTo(redirectUrl, forceLoad: true);
    }
  }

  /// <summary>
  /// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å®Ÿè¡Œ
  ///
  /// ã€Blazor Serveråˆå­¦è€…å‘ã‘è§£èª¬ã€‘
  /// EditFormã®OnValidSubmit: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
  /// - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸæ™‚ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹
  /// - éåŒæœŸå‡¦ç†ã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰èªè¨¼ã‚’å®Ÿè¡Œ
  /// - StateHasChanged()ã§UIçŠ¶æ…‹ã‚’æ›´æ–°
  /// 
  /// ã€TECH-006ä¿®æ­£ã€‘èªè¨¼å‡¦ç†é †åºæœ€é©åŒ–
  /// - Cookieèªè¨¼å‡¦ç†ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ã‹ã‚‰StateHasChanged()ã‚’å‘¼ã³å‡ºã—
  /// - HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹é–‹å§‹å‰ã«Cookieè¨­å®šã‚’å®Œäº†
  /// </summary>
  private async Task HandleLoginAsync()
  {
    try
    {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹é–‹å§‹ï¼ˆHTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹é–‹å§‹å‰ã®çŠ¶æ…‹å¤‰æ›´ã®ã¿ï¼‰
      isLoading = true;
      errorMessage = null;
      successMessage = null;

      // èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã§ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œï¼ˆCookieå‡¦ç†ã‚’æœ€åˆã«å®Ÿè¡Œï¼‰
      // ã€TECH-006ä¿®æ­£ã€‘StateHasChanged()å‰ã«Cookieèªè¨¼å‡¦ç†ã‚’å®Œäº†
      var loginRequest = new UbiquitousLanguageManager.Contracts.DTOs.Authentication.LoginRequestDto
      {
        Email = loginModel.Email,
        Password = loginModel.Password,
        RememberMe = loginModel.RememberMe
      };

      var loginResult = await AuthService.LoginAsync(loginRequest);

      // LoginResponseDto ã®çµæœå‡¦ç†
      // ã€TECH-006ä¿®æ­£ã€‘Cookieèªè¨¼å‡¦ç†å®Œäº†å¾Œã«StateHasChanged()ã‚’å®Ÿè¡Œ
      if (loginResult.IsSuccess)
      {
        // æˆåŠŸæ™‚ã®å‡¦ç†
        successMessage = "ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸã€‚ç”»é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ã¾ã™...";
        
        // ã€TECH-006ä¿®æ­£ã€‘StateHasChanged()ã‚’å‰Šé™¤
        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‰ã®UIæ›´æ–°ã¯ä¸è¦ã§ã‚ã‚Šã€Cookieè¨­å®šã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹
        // StateHasChanged(); â† å‰Šé™¤æ¸ˆã¿

        // èªè¨¼çŠ¶æ…‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«é€šçŸ¥
        if (AuthStateProvider is CustomAuthenticationStateProvider customProvider)
        {
          customProvider.NotifyUserAuthentication(AuthStateProvider.GetAuthenticationStateAsync());
        }

        // åˆå›ãƒ­ã‚°ã‚¤ãƒ³åˆ¤å®š
        if (loginResult.IsFirstLogin)
        {
          // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
          _ = JSRuntime.InvokeVoidAsync("console.log", "åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ¤œå‡º: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ");
          await Task.Delay(1500); // UIè¡¨ç¤ºã®ãŸã‚ã®çŸ­ã„å¾…æ©Ÿ
          Navigation.NavigateTo("/Account/ChangePassword", forceLoad: true);
        }
        else
        {
          // é€šå¸¸ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
          var redirectUrl = !string.IsNullOrEmpty(ReturnUrl) ? ReturnUrl : "/";
          await Task.Delay(1500); // UIè¡¨ç¤ºã®ãŸã‚ã®çŸ­ã„å¾…æ©Ÿ
          Navigation.NavigateTo(redirectUrl, forceLoad: true);
        }
      }
      else
      {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
        errorMessage = loginResult.ErrorMessage ?? "ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

        // JavaScriptç›¸äº’é‹ç”¨: ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã«è¡¨ç¤º
        await JSRuntime.InvokeVoidAsync("console.error", $"ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: {errorMessage}");

        // ã€TECH-006ä¿®æ­£ã€‘èªè¨¼å¤±æ•—æ™‚ã‚‚é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§UIæ›´æ–°
        StateHasChanged();
      }
    }
    catch (Exception ex)
    {
      // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      errorMessage = "ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";

      // JavaScriptç›¸äº’é‹ç”¨: ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼å‡ºåŠ›
      await JSRuntime.InvokeVoidAsync("console.error", $"ãƒ­ã‚°ã‚¤ãƒ³ä¾‹å¤–: {ex.Message}");
      
      // ã€TECH-006ä¿®æ­£ã€‘ä¾‹å¤–æ™‚ã‚‚StateHasChanged()ã‚’é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œ
      StateHasChanged();
    }
    finally
    {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹çµ‚äº†
      isLoading = false;
      
      // ã€TECH-006ä¿®æ­£ã€‘finallyå¥ã§ã®StateHasChanged()ã¯å†—é•·ãªãŸã‚å‰Šé™¤
      // å„å‡¦ç†ãƒ‘ã‚¹ï¼ˆæˆåŠŸãƒ»å¤±æ•—ãƒ»ä¾‹å¤–ï¼‰ã§æ—¢ã«é©åˆ‡ã«StateHasChanged()ã‚’å®Ÿè¡Œæ¸ˆã¿
    }
  }
}