@page "/account/reset-password"
@using System.ComponentModel.DataAnnotations
@using UbiquitousLanguageManager.Application
@using UbiquitousLanguageManager.Domain
@using Microsoft.Extensions.Logging
@using UbiquitousLanguageManager.Contracts
@using UbiquitousLanguageManager.Web.Services
@inject IAuthenticationService AuthService
@inject Microsoft.Extensions.Logging.ILogger<ResetPassword> Logger
@inject NavigationManager Navigation

<PageTitle>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š - ãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </PageTitle>

<div class="container-fluid d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow-lg" style="width: 100%; max-width: 500px;">
        <div class="card-header text-center bg-success text-white">
            <h3 class="mb-0">
                <i class="fas fa-lock me-2"></i>
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®š
            </h3>
        </div>
        
        <div class="card-body p-4">
            @* ğŸ¯ ADR_010æº–æ‹ : Blazor Serveråˆå­¦è€…å‘ã‘ã‚³ãƒ¡ãƒ³ãƒˆ *@
            @* ã€Blazor Serverè§£èª¬ã€‘ *@
            @* - OnInitializedAsync(): ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–æ™‚ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾— *@
            @* - ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ?email=xxx&token=xxxå½¢å¼ã§URLã‹ã‚‰æƒ…å ±ã‚’å–å¾— *@
            
            @if (_isLoading)
            {
                @* ğŸ”„ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ä¸­ã®è¡¨ç¤º *@
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">ç¢ºèªä¸­...</span>
                    </div>
                    <p class="mt-2">ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>
                </div>
            }
            else if (!_isValidToken)
            {
                @* âŒ ç„¡åŠ¹ãƒˆãƒ¼ã‚¯ãƒ³: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹è¡¨ç¤º *@
                <div class="alert alert-danger" role="alert">
                    <h4 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ã§ã™
                    </h4>
                    <p>
                        ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã¯ç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚
                        ä»¥ä¸‹ã®ç†ç”±ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ï¼š
                    </p>
                    <ul class="mb-0">
                        <li>ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ï¼ˆ24æ™‚é–“ï¼‰ãŒåˆ‡ã‚Œã¦ã„ã‚‹</li>
                        <li>æ—¢ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹</li>
                        <li>ãƒªãƒ³ã‚¯ãŒä¸æ­£ã«æ”¹å¤‰ã•ã‚Œã¦ã„ã‚‹</li>
                    </ul>
                </div>
                
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-primary" type="button" @onclick="RequestNewReset">
                        <i class="fas fa-redo me-2"></i>
                        æ–°ã—ã„ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’è¦æ±‚
                    </button>
                    <button class="btn btn-outline-secondary" type="button" @onclick="BackToLogin">
                        <i class="fas fa-arrow-left me-2"></i>
                        ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            }
            else if (_resetCompleted)
            {
                @* âœ… ãƒªã‚»ãƒƒãƒˆå®Œäº†çŠ¶æ…‹: æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º *@
                <div class="alert alert-success" role="alert">
                    <h4 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†è¨­å®šã—ã¾ã—ãŸ
                    </h4>
                    <p class="mb-0">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚
                        æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" type="button" @onclick="BackToLogin">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸
                    </button>
                </div>
            }
            else
            {
                @* ğŸ“ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  *@
                <EditForm Model="_model" OnValidSubmit="HandleResetAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" role="alert" />
                    
                    @* âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆADR_007æº–æ‹ ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ *@
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @_errorMessage
                        </div>
                    }
                    
                    @* ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤ºï¼ˆç¢ºèªç”¨ã€èª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ *@
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-envelope me-2"></i>
                            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
                        </label>
                        <input type="email" class="form-control-plaintext" 
                               readonly value="@_email" />
                        <div class="form-text">
                            ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†è¨­å®šã—ã¾ã™ã€‚
                        </div>
                    </div>
                    
                    @* ğŸ” æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ› *@
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">
                            <i class="fas fa-key me-2"></i>
                            æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                        </label>
                        <InputText id="newPassword" type="password" 
                                   class="form-control form-control-lg"
                                   @bind-Value="_model.NewPassword"
                                   placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                                   autocomplete="new-password" />
                        <ValidationMessage For="@(() => _model.NewPassword)" class="text-danger" />
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            8æ–‡å­—ä»¥ä¸Šã€è‹±æ•°å­—ã‚’å«ã‚€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>
                    
                    @* ğŸ” ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª *@
                    <div class="mb-4">
                        <label for="confirmPassword" class="form-label">
                            <i class="fas fa-check me-2"></i>
                            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
                        </label>
                        <InputText id="confirmPassword" type="password" 
                                   class="form-control form-control-lg"
                                   @bind-Value="_model.ConfirmPassword"
                                   placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›"
                                   autocomplete="new-password" />
                        <ValidationMessage For="@(() => _model.ConfirmPassword)" class="text-danger" />
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg" disabled="@_isProcessing">
                            @* ğŸ¯ Blazor Server: ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ *@
                            @if (_isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                @:è¨­å®šä¸­...
                            }
                            else
                            {
                                <i class="fas fa-save me-2"></i>
                                @:ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
                            }
                        </button>
                        
                        <button class="btn btn-outline-secondary" type="button" @onclick="BackToLogin">
                            <i class="fas fa-arrow-left me-2"></i>
                            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                        </button>
                    </div>
                </EditForm>
            }
        </div>
        
        <div class="card-footer text-center bg-light">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š
            </small>
        </div>
    </div>
</div>

@code {
    // ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ‡ãƒ«: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
    private ResetPasswordModel _model = new();
    private bool _isLoading = true;
    private bool _isProcessing = false;
    private bool _isValidToken = false;
    private bool _resetCompleted = false;
    private string? _errorMessage;
    private string _email = string.Empty;
    private string _token = string.Empty;
    
    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ‡ãƒ«
    /// </summary>
    public class ResetPasswordModel
    {
        [Required(ErrorMessage = "æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„")]
        [RegularExpression(@"^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d@$!%*?&]{8,}$", 
            ErrorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯è‹±æ•°å­—ã‚’å«ã‚€8æ–‡å­—ä»¥ä¸Šã§è¨­å®šã—ã¦ãã ã•ã„")]
        [Display(Name = "æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰")]
        public string NewPassword { get; set; } = string.Empty;
        
        [Required(ErrorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã¯å¿…é ˆã§ã™")]
        [Compare(nameof(NewPassword), ErrorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“")]
        [Display(Name = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
    
    /// <summary>
    /// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å‡¦ç†
    /// </summary>
    /// <remarks>
    /// ğŸ”„ Blazor Server: OnInitializedAsync()ã¯ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‰ã«å®Ÿè¡Œ
    /// ğŸ“§ ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: URLã‹ã‚‰emailãƒ»tokenæƒ…å ±ã‚’å–å¾—
    /// ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼: Applicationå±¤ã§ã®ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ç¢ºèª
    /// </remarks>
    protected override async Task OnInitializedAsync()
    {
        try
        {
            // ğŸŒ ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è§£æ
            var uri = new Uri(Navigation.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            
            _email = query["email"] ?? string.Empty;
            _token = query["token"] ?? string.Empty;
            
            // ğŸ“Š ADR_008æº–æ‹ : ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–ãƒ­ã‚°
            Logger.LogDebug("ResetPassword component initialization. Email: {Email}, HasToken: {HasToken}", 
                _email, !string.IsNullOrEmpty(_token));
            
            if (string.IsNullOrEmpty(_email) || string.IsNullOrEmpty(_token))
            {
                // âŒ å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³
                Logger.LogWarning("Missing required parameters for password reset. Email: {Email}, Token: {HasToken}", 
                    _email, !string.IsNullOrEmpty(_token));
                _isValidToken = false;
                _isLoading = false;
                return;
            }
            
            // ğŸ” ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§æ¤œè¨¼
            var emailValue = Email.create(_email);
            if (emailValue.IsError)
            {
                Logger.LogWarning("Invalid email format in reset password. Email: {Email}", _email);
                _isValidToken = false;
                _isLoading = false;
                return;
            }
            
            var validationResult = await AuthService.ValidatePasswordResetTokenAsync(emailValue.ResultValue, _token);
            
            if (validationResult.IsOk && validationResult.ResultValue)
            {
                // âœ… ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹
                _isValidToken = true;
                Logger.LogInformation("Password reset token validated successfully. Email: {Email}", _email);
            }
            else
            {
                // âŒ ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹
                _isValidToken = false;
                Logger.LogWarning("Invalid or expired password reset token. Email: {Email}, Error: {Error}", 
                    _email, validationResult.ErrorValue);
            }
        }
        catch (Exception ex)
        {
            // âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼
            Logger.LogError(ex, "Error during password reset component initialization. Email: {Email}", _email);
            _isValidToken = false;
        }
        finally
        {
            _isLoading = false;
        }
    }
    
    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†è¨­å®šå‡¦ç†
    /// </summary>
    /// <remarks>
    /// ğŸ¯ ADR_007æº–æ‹ : Resultå‹ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    /// ğŸ“Š ADR_008æº–æ‹ : æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ï¼‰
    /// </remarks>
    private async Task HandleResetAsync()
    {
        // ğŸ“Š ADR_008æº–æ‹ : ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚°ï¼ˆInformation ãƒ¬ãƒ™ãƒ«ï¼‰
        Logger.LogInformation("Password reset attempt initiated. Email: {Email}", _email);
        
        _isProcessing = true;
        _errorMessage = null;
        
        // âš¡ Blazor Server: UIæ›´æ–°é€šçŸ¥ - å‡¦ç†é–‹å§‹çŠ¶æ…‹ã‚’å³åº§ã«åæ˜ 
        StateHasChanged();
        
        try
        {
            // ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
            var passwordResult = Password.create(_model.NewPassword);
            if (passwordResult.IsError)
            {
                _errorMessage = passwordResult.ErrorValue;
                Logger.LogWarning("Invalid password format in reset. Email: {Email}", _email);
                return;
            }
            
            var emailValue = Email.create(_email);
            if (emailValue.IsError)
            {
                _errorMessage = "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                Logger.LogError("Email validation failed during reset. Email: {Email}", _email);
                return;
            }
            
            // ğŸ” Applicationå±¤å‘¼ã³å‡ºã—: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
            var result = await AuthService.ResetPasswordAsync(emailValue.ResultValue, _token, passwordResult.ResultValue);
            
            if (result.IsOk)
            {
                // âœ… æˆåŠŸ: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Œäº†
                _resetCompleted = true;
                Logger.LogInformation("Password reset completed successfully. Email: {Email}", _email);
                
                // ğŸ” Step4: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Œäº†å¾Œã®è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
                try
                {
                    var autoLoginResult = await AuthService.AutoLoginAfterPasswordResetAsync(emailValue.ResultValue);
                    
                    if (autoLoginResult.IsOk)
                    {
                        Logger.LogInformation("Auto login after password reset successful. Email: {Email}", _email);
                        
                        // ğŸ  è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                        await Task.Delay(2000); // 2ç§’é–“æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                        Navigation.NavigateTo("/admin/users", replace: true);
                    }
                    else
                    {
                        // âš ï¸ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã¯æˆåŠŸã€æ‰‹å‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã™
                        Logger.LogWarning("Auto login failed after password reset. Email: {Email}, Error: {Error}", 
                            _email, autoLoginResult.ErrorValue);
                        _errorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯å®Œäº†ã—ã¾ã—ãŸãŒã€è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰æ‰‹å‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
                    }
                }
                catch (Exception autoLoginEx)
                {
                    // âŒ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ä¾‹å¤–: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã¯æˆåŠŸ
                    Logger.LogError(autoLoginEx, "Exception during auto login after password reset. Email: {Email}", _email);
                    _errorMessage = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã¯å®Œäº†ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰æ‰‹å‹•ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚";
                }
            }
            else
            {
                // âŒ å¤±æ•—: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                _errorMessage = TranslateErrorMessage(result.ErrorValue);
                Logger.LogWarning("Password reset failed. Email: {Email}, Error: {Error}", 
                    _email, result.ErrorValue);
            }
        }
        catch (Exception ex)
        {
            // âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: ADR_008æº–æ‹ ï¼ˆError ãƒ¬ãƒ™ãƒ«ï¼‰
            Logger.LogError(ex, "Unexpected error during password reset. Email: {Email}", _email);
            
            // ğŸ¯ ADR_007æº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            _errorMessage = "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
        }
        finally
        {
            _isProcessing = false;
            
            // âš¡ Blazor Server: UIæ›´æ–°é€šçŸ¥ - å‡¦ç†å®Œäº†çŠ¶æ…‹ã‚’åæ˜ 
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ—¥æœ¬èªåŒ–
    /// </summary>
    /// <remarks>
    /// ğŸ¯ ADR_007æº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›
    /// </remarks>
    private string TranslateErrorMessage(string error)
    {
        return error switch
        {
            var msg when msg.Contains("invalid token") || msg.Contains("expired") => 
                "ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚æ–°ã—ã„ãƒªã‚»ãƒƒãƒˆè¦æ±‚ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚",
            var msg when msg.Contains("user not found") => 
                "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚",
            var msg when msg.Contains("password complexity") => 
                "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚8æ–‡å­—ä»¥ä¸Šã§è‹±æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
            _ => "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å†è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚"
        };
    }
    
    /// <summary>
    /// æ–°ã—ã„ãƒªã‚»ãƒƒãƒˆè¦æ±‚å‡¦ç†
    /// </summary>
    private void RequestNewReset()
    {
        Logger.LogDebug("User requested new password reset. Email: {Email}", _email);
        Navigation.NavigateTo("/account/forgot-password");
    }
    
    /// <summary>
    /// ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®æˆ»ã‚Šå‡¦ç†
    /// </summary>
    private void BackToLogin()
    {
        Logger.LogDebug("User navigated back to login from reset password page");
        Navigation.NavigateTo("/auth/login");
    }
}