@page "/account/forgot-password"
@using System.ComponentModel.DataAnnotations
@using UbiquitousLanguageManager.Application
@using UbiquitousLanguageManager.Domain
@using Microsoft.Extensions.Logging
@using UbiquitousLanguageManager.Contracts
@using UbiquitousLanguageManager.Web.Services
@inject IAuthenticationService AuthService
@inject Microsoft.Extensions.Logging.ILogger<ForgotPassword> Logger
@inject NavigationManager Navigation

<PageTitle>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ - ãƒ¦ãƒ“ã‚­ã‚¿ã‚¹è¨€èªç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </PageTitle>

<div class="container-fluid d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow-lg" style="width: 100%; max-width: 450px;">
        <div class="card-header text-center bg-primary text-white">
            <h3 class="mb-0">
                <i class="fas fa-key me-2"></i>
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
            </h3>
        </div>
        
        <div class="card-body p-4">
            @* ğŸ¯ ADR_010æº–æ‹ : Blazor Serveråˆå­¦è€…å‘ã‘ã‚³ãƒ¡ãƒ³ãƒˆ *@
            @* ã€Blazor Serverè§£èª¬ã€‘ *@
            @* - EditForm: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œã®ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ *@
            @* - OnValidSubmit: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ *@
            @* - DataAnnotationsValidator: ãƒ¢ãƒ‡ãƒ«ã®å±æ€§ãƒ™ãƒ¼ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ *@
            @* - ValidationSummary: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®ä¸€è¦§è¡¨ç¤º *@
            
            @if (_isLoading)
            {
                @* ğŸ”„ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹: ãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†ä¸­ã®è¡¨ç¤º *@
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">é€ä¿¡ä¸­...</span>
                    </div>
                    <p class="mt-2">ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­...</p>
                </div>
            }
            else if (_emailSent)
            {
                @* âœ… é€ä¿¡å®Œäº†çŠ¶æ…‹: æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º *@
                <div class="alert alert-success" role="alert">
                    <h4 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ
                    </h4>
                    <p class="mb-0">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚
                        ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <hr>
                    <p class="mb-0">
                        <small class="text-muted">
                            ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆã¯ã€è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                            ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ã¯24æ™‚é–“ã§ã™ã€‚
                        </small>
                    </p>
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" type="button" @onclick="BackToLogin">
                        <i class="fas fa-arrow-left me-2"></i>
                        ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                    </button>
                </div>
            }
            else
            {
                @* ğŸ“ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ : ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ› *@
                <EditForm Model="_model" OnValidSubmit="HandleSubmitAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="alert alert-danger" role="alert" />
                    
                    @* âŒ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆADR_007æº–æ‹ ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ *@
                    @if (!string.IsNullOrEmpty(_errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @_errorMessage
                        </div>
                    }
                    
                    <div class="mb-4">
                        <label for="email" class="form-label">
                            <i class="fas fa-envelope me-2"></i>
                            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                        </label>
                        <InputText id="email" class="form-control form-control-lg" 
                                   @bind-Value="_model.Email" 
                                   placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                                   autocomplete="email" />
                        <ValidationMessage For="@(() => _model.Email)" class="text-danger" />
                        <div class="form-text">
                            ç™»éŒ²æ™‚ã«ä½¿ç”¨ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" disabled="@_isProcessing">
                            @* ğŸ¯ Blazor Server: ãƒœã‚¿ãƒ³çŠ¶æ…‹ç®¡ç†ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ *@
                            @if (_isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                @:é€ä¿¡ä¸­...
                            }
                            else
                            {
                                <i class="fas fa-paper-plane me-2"></i>
                                @:ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡
                            }
                        </button>
                        
                        <button class="btn btn-outline-secondary" type="button" @onclick="BackToLogin">
                            <i class="fas fa-arrow-left me-2"></i>
                            ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹
                        </button>
                    </div>
                </EditForm>
            }
        </div>
        
        <div class="card-footer text-center bg-light">
            <small class="text-muted">
                <i class="fas fa-shield-alt me-1"></i>
                ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆ
            </small>
        </div>
    </div>
</div>

@code {
    // ğŸ“‹ ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ‡ãƒ«: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
    private ForgotPasswordModel _model = new();
    private bool _isLoading = false;
    private bool _isProcessing = false;
    private bool _emailSent = false;
    private string? _errorMessage;
    
    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ãƒ‡ãƒ«
    /// </summary>
    public class ForgotPasswordModel
    {
        [Required(ErrorMessage = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å¿…é ˆã§ã™")]
        [EmailAddress(ErrorMessage = "æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")]
        [Display(Name = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹")]
        public string Email { get; set; } = string.Empty;
    }
    
    /// <summary>
    /// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    /// </summary>
    /// <remarks>
    /// ğŸ¯ ADR_007æº–æ‹ : Resultå‹ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    /// ğŸ“Š ADR_008æº–æ‹ : æ§‹é€ åŒ–ãƒ­ã‚°å‡ºåŠ›
    /// ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®: ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšåŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    /// </remarks>
    private async Task HandleSubmitAsync()
    {
        // ğŸ“Š ADR_008æº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãƒ­ã‚°ï¼ˆInformation ãƒ¬ãƒ™ãƒ«ï¼‰
        Logger.LogInformation("Password reset request initiated. Email: {Email}", 
            _model.Email);
        
        _isProcessing = true;
        _errorMessage = null;
        
        // âš¡ Blazor Server: UIæ›´æ–°é€šçŸ¥ - å‡¦ç†é–‹å§‹çŠ¶æ…‹ã‚’å³åº§ã«åæ˜ 
        StateHasChanged();
        
        try
        {
            // ğŸ”‘ Applicationå±¤å‘¼ã³å‡ºã—: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚
            var emailValue = Email.create(_model.Email);
            
            if (emailValue.IsError)
            {
                // âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ADR_007æº–æ‹ ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                _errorMessage = "æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                Logger.LogWarning("Invalid email format in password reset request. Email: {Email}", 
                    _model.Email);
                return;
            }
            
            var result = await AuthService.RequestPasswordResetAsync(emailValue.ResultValue);
            
            // ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®: æˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšåŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹
            // å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚åŒæ§˜ã®å¿œç­”ã‚’è¿”ã™ã“ã¨ã§ã€
            // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå­˜åœ¨ç¢ºèªæ”»æ’ƒã‚’é˜²æ­¢
            _emailSent = true;
            _isLoading = false;
            
            if (result.IsOk)
            {
                // âœ… æˆåŠŸãƒ­ã‚°: ADR_008æº–æ‹ ï¼ˆInformation ãƒ¬ãƒ™ãƒ«ï¼‰
                Logger.LogInformation("Password reset email sent successfully. Email: {Email}", 
                    _model.Email);
            }
            else
            {
                // âš ï¸ å¤±æ•—ãƒ­ã‚°: ADR_008æº–æ‹ ï¼ˆWarning ãƒ¬ãƒ™ãƒ« - ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«é•åï¼‰
                Logger.LogWarning("Password reset request failed. Email: {Email}, Error: {Error}", 
                    _model.Email, result.ErrorValue);
                
                // ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚¨ãƒ©ãƒ¼è©³ç´°ã¯éè¡¨ç¤ºã€ä¸€èˆ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                // ãŸã ã—ã€UIã§ã¯æˆåŠŸã¨ã—ã¦æ‰±ã†
            }
        }
        catch (Exception ex)
        {
            // âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼: ADR_008æº–æ‹ ï¼ˆError ãƒ¬ãƒ™ãƒ«ï¼‰
            Logger.LogError(ex, "Unexpected error during password reset request. Email: {Email}", 
                _model.Email);
            
            // ğŸ¯ ADR_007æº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            _errorMessage = "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
        }
        finally
        {
            _isProcessing = false;
            
            // âš¡ Blazor Server: UIæ›´æ–°é€šçŸ¥ - å‡¦ç†å®Œäº†çŠ¶æ…‹ã‚’åæ˜ 
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®æˆ»ã‚Šå‡¦ç†
    /// </summary>
    /// <remarks>
    /// ğŸŒ Blazor Server: NavigationManagerã«ã‚ˆã‚‹ãƒšãƒ¼ã‚¸é·ç§»
    /// </remarks>
    private void BackToLogin()
    {
        // ğŸ“Š ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³: Debug ãƒ¬ãƒ™ãƒ«ãƒ­ã‚°
        Logger.LogDebug("User navigated back to login from forgot password page");
        
        Navigation.NavigateTo("/auth/login");
    }
}