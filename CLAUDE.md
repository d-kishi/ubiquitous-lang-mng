# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

**ユビキタス言語管理システム**のプロジェクトです。ドメイン駆動設計（DDD）における用語管理を効率化するWebアプリケーションの開発を目的としています。現在は**実装フェーズ**で、Phase A1（基本認証システム）実装開始準備が完了しています。

### プロジェクト構造
- **実装フェーズ進行中**: 設計完了・雛型作成完了・縦方向スライス実装開始準備完了
- **技術基盤**: Clean Architecture（F# Domain/Application + C# Infrastructure/Web + Contracts層）
- **対象ユーザー**: プロジェクト管理者、ドメインエキスパート、DDD開発者

## アーキテクチャ・設計決定

### 主要な設計決定（ADR）
- **ADR_003**: 用語統一 - 日本語では「用語」ではなく「ユビキタス言語」を使用
- **ADR_001**: 図表にMermaid記法を採用
- **ADR_002**: MermaidのER図記法統一
- **ADR_004**: コミュニケーション課題状態管理システム
- **ADR_005**: PostgreSQL Docker Container採用（データ移行コスト削除）

### データベース設計
- **全環境共通**: PostgreSQL（Docker Container → クラウドDBサービス）
- **データ移行**: 不要（全環境PostgreSQL統一により）
- **アーキテクチャ**: Clean Architectureによるレイヤード構造
- **データ階層**: 組織 → プロジェクト → ドメイン → ユビキタス言語
- **PostgreSQL最適化**: TIMESTAMPTZ、JSONB、GINインデックス等固有機能活用

## コミュニケーション・セッション管理

### 🔴 セッション開始時必読（5分以内・標準プロセス）
**毎セッション開始時に必ず以下の順序で実施**:
1. `/CLAUDE.md` - プロジェクト概要・技術構成・フェーズ状況
2. `/Doc/06_Issues/コミュニケーション改善課題.md` - コミュニケーション課題と改善策
3. `/Doc/プロジェクト状況.md` - 最新状況・次回予定・重要な制約（簡潔な現状把握）
4. `/Doc/04_Daily/` 直近3日の作業記録 - 詳細履歴・継続課題・技術的文脈確認
5. **進捗状況・優先事項提示によるセッション目的確認**
   - 読み込んだ情報から現在の進捗状況を整理・提示
   - 今回の優先事項・推奨作業内容を提示
   - ユーザーに今回のセッション目的を明確化してもらう

### 🟡 動的読み込み決定プロセス（3-5分）

#### **Phase 1: 作業範囲特定（1-2分）**
ユーザーとの対話で以下を決定：
```
□ 今回の作業内容・目的確認
□ 必要ADR特定（例: 認証実装 → ADR_007, ADR_010）
□ 必要設計書特定（例: 認証UI → UI設計/01_認証・ユーザー管理画面設計.md）
□ 組織設計適用有無（Phase適応型組織使用するか）
□ 環境・課題情報の必要性確認
```

#### **Phase 2: 選択的読み込み実行（2-3分）**
決定した範囲のみ読み込み実行

### 📋 読み込み対象カテゴリ

#### **ADR（アーキテクチャ決定記録）**
作業内容に応じて選択：
- **ADR_001-003**: 基本記法・用語統一
- **ADR_007-009**: エラーハンドリング・ログ・テスト
- **ADR_010**: 実装規約（Blazor Server・F#コメント）
- **ADR_011**: スクラム開発サイクル

#### **設計書**
作業対象に応じて選択：
- **システム設計書.md**: アーキテクチャ全体
- **データベース設計書.md**: DB関連作業
- **Application層インターフェース設計書.md**: F#↔C#境界
- **UI設計/**: 該当画面設計書

#### **組織・環境・課題**
必要に応じて選択：
- **/Doc/08_Organization/Active/**: Phase適応型組織実行時
- **/Doc/09_Environment/**: 環境設定・DB接続作業時
- **/Doc/06_Issues/課題一覧.md**: 問題解決・技術調査時

### 📋 フェーズ別推奨パターン（参考）

#### **実装フェーズ推奨**
🔴 必読 + 関連ADR + 作業対象設計書 + 組織設計（Phase適応型使用時）

#### **レビュー・修正フェーズ推奨**  
🔴 必読 + 品質関連ADR + 関連設計書 + 組織設計 + 直近実装記録

### 🔚 セッション終了時確認プロセス
**セッション目的達成時に必ず実施**:
- **目的達成確認**: セッション開始時に設定した目的が達成されたかClaudeが判断・報告
- **終了確認**: 目的達成をユーザーに報告し、セッション終了するかどうか確認を取る
- **継続判断**: ユーザーが継続を希望する場合は新たな目的設定を依頼
- **プロジェクト状況更新**: `/Doc/プロジェクト状況.md`の「次回セッション最優先事項」「次回Session読み込み推奨範囲」を自動更新

### 📝 セッション終了時記録チェックリスト

#### **🎯 成果・実績記録**
```
□ 今回セッションの主要成果整理（具体的な完了項目・創出物）
□ 完了・未完了事項の明確化（ToDoリスト状況・継続課題）
□ 技術的知見・学習事項の記録（新発見・ベストプラクティス）
□ 問題解決の経緯記録（エラー対応・解決手法・回避策）
```

#### **🔍 品質・効率評価**
```
□ セッション目的達成度評価（100%/80%/60%等の定量評価）
□ 時間効率測定（予定時間vs実際時間・効率化要因）
□ 適用手法の効果検証（Phase適応型組織・Gemini連携等の効果）
□ 品質評価（成果物品質・プロセス品質・満足度）
```

#### **📋 課題・改善管理**
```
□ 発見された課題・問題点の記録（技術的・プロセス的・コミュニケーション）
□ 継続課題の更新（解決済みマーク・新規追加・優先度変更）
□ コミュニケーション改善事項の確認（COM-XXX課題の状況更新）
□ プロセス改善提案（次回セッション以降の改善案）
```

#### **🚀 次回準備・引き継ぎ**
```
□ 次回セッション予定事項の設定（具体的作業内容・準備事項）
□ 申し送り事項の更新（重要な制約・前提・注意点）
□ 技術的前提条件の整理（開発環境・依存関係・設定状況）
□ Phase状況の更新（現在Phase・次Phase・実装計画）
```

#### **📄 記録・文書化**
```
□ `/Doc/04_Daily/YYYY-MM/YYYY-MM-DD.md`に詳細記録
□ 重要な決定事項のADR化検討（技術選定・アーキテクチャ決定等）
□ `/Doc/プロジェクト状況.md`の次回セッション情報更新（最優先事項・推奨読み込み範囲）
□ 週次総括への反映事項確認（週末セッションの場合）
```

### 📋 セッション終了時記録

詳細な記録テンプレートは以下を参照：
**`/Doc/04_Daily/セッション終了時記録テンプレート.md`**

日次作業記録ファイル（`/Doc/04_Daily/YYYY-MM/YYYY-MM-DD.md`）にテンプレートに従って記録を作成。

### 解決済み課題（2025-07-13完了）
- **COM-001**: 作業範囲確認プロセス ✅ - セッション開始時目的設定で完全解決
- **COM-002**: 継続課題追跡 ✅ - 直近3日作業記録確認プロセス標準化で完全解決  
- **COM-003**: 要求理解深度 ✅ - 雛型100%完了定義明確化で完全解決
- **COM-004**: セッション目的管理 ✅ - 詳細化チェックリスト確立で完全解決

### 課題管理体制
現在すべてのコミュニケーション課題が解決済み。新たな課題管理は以下で実施：
- **詳細管理**: `/Doc/06_Issues/コミュニケーション改善課題.md`
- **新規課題**: セッション終了時記録での継続的発見・管理

## 実装指針

### 🎯 **重要**: Blazor Server・F#初学者対応コメント徹底

プロジェクトオーナーがBlazor ServerとF#の初学者のため、これらの分野では**特に詳細なコメント**を必須とする。

**📋 詳細仕様**: [ADR_010: 実装規約](/Doc/07_Decisions/ADR_010_実装規約.md)

**🎯 実装時の重要ポイント**:
- **Blazor Server**: コンポーネントライフサイクル・StateHasChanged・SignalR接続の詳細コメント必須
- **F#**: パターンマッチング・Option型・Result型・関数型プログラミング概念の説明必須
- **ドキュメント継承**: C#では`/// <inheritdoc/>`活用、F#では`<seealso>`タグ活用

### 📋 開発コマンド

#### **ビルドコマンド**
```bash
# 全プロジェクトビルド
dotnet build

# 特定プロジェクトのビルド
dotnet build src/UbiquitousLanguageManager.Web
```

#### **テストコマンド**
```bash
# 全テスト実行
dotnet test

# 特定テストプロジェクトのみ実行
dotnet test tests/UbiquitousLanguageManager.Tests
```

#### **開発サーバー起動**
```bash
# Webアプリケーション起動
dotnet run --project src/UbiquitousLanguageManager.Web

# Docker環境でのPostgreSQL起動
docker-compose up -d postgresql
```

#### **その他のコマンド**
```bash
# NuGetパッケージ復元
dotnet restore

# プロジェクトクリーン
dotnet clean
```

## ファイル構成

- `/Doc/01_Requirements/` - 要件・仕様書
- `/Doc/02_Design/` - システム・データベース設計
- `/Doc/03_Meetings/` - 会議録・申し送り事項
- `/Doc/04_Daily/` - 日次作業記録・進捗
- `/Doc/06_Issues/` - 課題追跡・解決
- `/Doc/07_Decisions/` - アーキテクチャ決定記録（ADR）
- `/Doc/08_Organization/` - Phase適応型組織設計・実績記録

## 重要事項

- **用語統一**: 日本語では「用語」ではなく「ユビキタス言語」を使用
- **セッション効率化**: 上記読み込みガイドに従って迅速な状況把握
- **課題追跡**: 問題発生時はコミュニケーション改善課題ファイルを更新
- **決定記録**: 重要な技術決定はADRとして記録

## 【MUST GLOBAL】開発手法の正式採用

### 🏆 戦略的アプローチ（Phase適応型組織化）
**2025-07-08実験結果＋2025-07-13 Claude Code Max Plan統合による正式採用**

#### **Phase分割による段階的問題解決**
複雑な技術課題を以下の段階に分割し、**Phase適応型並列組織**で体系的に解決：

1. **Phase 1: 設計理解と構造整理（並列分析）**
   - 既存プロジェクト構造の完全把握（プロジェクト間依存関係の図示）
   - 各層の責任範囲確認（F#↔C#境界の設計意図理解）
   - 最小構成での段階的構築（1つのエンティティに絞った縦方向実装）
   - Domain → Application → Contracts → Infrastructure → Web の順序
   - 各段階でのビルド成功確認

2. **Phase 2: 技術課題の特定と解決（並列解決）**
   - 根本原因の特定（症状ではなく原因への着手）
   - 体系的な解決アプローチ（場当たり的修正の回避）
   - F#構文パターンの標準化（クラス定義・member配置のベストプラクティス確立）
   - C#⇔F#連携の型変換システム確立（Contracts層での適切なDTO設計）
   - 段階的な検証・修正（各段階でのビルド成功確認）

3. **Phase 3: 品質向上と拡張（並列検証）**
   - 機能の充実化（基本構造確立後の機能追加）
   - 統合テストと品質保証
   - 実用レベルへの向上（各段階でのビルド成功確認）

#### **Phase適応型組織による構造化専門分析**
**Claude Code Max Plan Rate Limit活用**：Phase特性に応じた専門チーム役割による構造化分析・実装

**組織管理システム**：
- **記録場所**: `/Doc/08_Organization/` - 組織設計・実績・パターン集
- **実行サイクル**: Phase開始前組織設計 → 実行中効果測定 → 完了後パターン蓄積
- **Phase特性による専門役割数調整**:
  - シンプルPhase: 3-4専門役割
  - 中程度Phase: 4-6専門役割  
  - 複雑Phase: 6-8専門役割

**構造化分析プロセス**：
```
Phase 1: 専門役割による課題発見（30分）
├── 各専門役割を順次実行
├── 役割毎のGemini技術調査
├── 課題・リスク・ベストプラクティス抽出
└── 実装アプローチ候補の列挙

Phase 2: 集約・優先順位付け（30分）
├── 各役割結果の統合・重複排除
├── 相互依存関係の整理
├── 影響度・緊急度による優先順位付け
└── 実装順序決定

Phase 3: 統合解決策立案（60分）
├── 高優先課題の統合解決策検討
├── 各専門観点の実装パターン統合
├── Clean Architecture実装順序確定
└── 次Session具体的作業計画策定
```

#### **効果実績・目標**
- **従来手法**: 50%短縮・成功率100%実績（2025-07-08）
- **構造化組織目標**: 専門性向上・課題網羅性向上・品質向上実現（2025-07-13～）
- **品質**: 場当たり的修正を回避し、体系的解決を実現

### 🤝 Claude Code × Gemini連携（正式採用）

#### **三位一体の開発原則**
- **ユーザー**：プロジェクトの目的・要件・最終ゴールを定義し、最終的な意思決定を行う**意思決定者**
- **Claude**：高度な計画力・高品質な実装・リファクタリング・ファイル操作・タスク管理を担う**実行者**
- **Gemini**：深いコード理解・Web検索による最新情報へのアクセス・多角的な視点からの助言・技術的検証を行う**助言者**


#### **実践ガイド**
- **ユーザーの要求を受けたら即座に`gemini -p <質問内容>`で壁打ち**を必ず実施
- Geminiの意見を鵜呑みにせず、1意見として判断。聞き方を変えて多角的な意見を抽出
- **Claude Code内蔵のWebSearchツールは使用しない**
- **o3 MCPツール使用禁止**: 現在o3 MCPは登録済みだが有効化されていないため使用不可
  - `mcp__o3-low__o3-search`、`mcp__o3__o3-search`、`mcp__o3-high__o3-search`は使用しない
  - 将来的に有効化予定だが、現時点では金銭的事情により無効
  - Web検索・技術調査は**Gemini**を活用する

#### **Gemini連携の具体的パターン**
**複雑な技術課題解決時の実証済み質問パターン**：

**📋 各層での専門的質問例**：
```
🔍 Domain層分析時：
- "F#でのDDD Value Object実装のベストプラクティス"
- "F#のResult型エラーハンドリングの最新パターン"
- "F#での判別共用体を活用したドメインモデリング手法"

🔍 Infrastructure層分析時：
- "Entity Framework Core .NET 8での最新設定パターン"
- "PostgreSQLとEF Coreのパフォーマンス最適化手法"
- "F#エンティティとEF Coreの統合パターン"

🔍 Application層分析時：
- "Clean ArchitectureでのF#アプリケーションサービス実装"
- "F#のuse caseとC#のcontroller連携パターン"
- "F#でのコマンド・クエリ分離実装手法"

🔍 Contracts層分析時：
- "F#の判別共用体をC#からアクセスする最新手法"
- "F#のOption型・Result型のC#変換パターン"
- "マルチ言語プロジェクトでの型変換自動化手法"

🔍 Architecture統合時：
- "マルチ言語Clean Architectureプロジェクト構成ベストプラクティス"
- "F#とC#混在プロジェクトでのビルド順序とエラー対処"
- "Clean Architectureでの依存性注入設定パターン"
```

**📋 多角的質問による深堀りパターン**：
```
初回質問 → 基本的な実装パターン確認
追加質問1 → 「この手法での具体的なエラー対処法は？」
追加質問2 → 「パフォーマンスやメンテナンス性での注意点は？」
追加質問3 → 「.NET 8 + F# 9.0での最新の改善点は？」
統合確認 → 「これらを統合した場合の潜在的な問題は？」
```

#### **主要な活用場面**
1. **技術調査**: 最新情報・エラー解決・ドキュメント検索・調査方法の確認
2. **設計検証**: アーキテクチャ・実装方針の妥当性確認
3. **コードレビュー**: 品質・保守性・パフォーマンスの評価
4. **計画立案**: タスクの実行計画レビュー・改善提案
5. **前提確認**: ユーザー、Claude自身に思い込みや勘違い、過信がないかどうか逐一確認

#### **統合判断時の具体的基準と実行手順**
**Architecture統合Claudeでの最終判断プロセス**：

**📋 統合判断の具体的基準**：
```
1. **技術的一貫性チェック**
   ✅ 各層の提案が同じ技術スタック・パターンに基づいているか
   ✅ F#↔C#境界での型変換方式が統一されているか
   ✅ エラーハンドリングパターンが全層で一貫しているか

2. **アーキテクチャ整合性チェック**
   ✅ Clean Architectureの依存性の方向が正しいか
   ✅ 各層の責任範囲が適切に分離されているか
   ✅ ドメインルールがインフラに依存していないか

3. **実装可能性チェック**
   ✅ 各層の提案を統合してビルドが成功するか
   ✅ 複雑すぎて実装・保守が困難ではないか
   ✅ 既存コードとの競合・矛盾がないか

4. **品質・保守性チェック**
   ✅ 後続開発者が理解・拡張しやすいパターンか
   ✅ テスタビリティが確保されているか
   ✅ パフォーマンスへの悪影響がないか
```

**📋 最終判断の実行手順**：
```
Phase A: 各層提案の収集・整理
├── Domain層Claudeの分析結果まとめ
├── Infrastructure層Claudeの分析結果まとめ  
├── Application層Claudeの分析結果まとめ
├── Contracts層Claudeの分析結果まとめ
└── 矛盾点・競合点の洗い出し

Phase B: 統合可能性の技術検証
├── `gemini -p "各層提案を統合した場合の技術的リスク評価"`
├── `gemini -p "提案された技術パターンの実装複雑度評価"`
└── 実装優先順位の決定

Phase C: 最終方針の決定・計画策定
├── 採用技術パターンの最終決定
├── 実装手順の具体化（Phase 1→2→3の詳細計画）
├── 品質確認ポイントの設定
└── 次回セッションでの具体的作業項目リスト作成
```

#### **開発哲学・品質基準**
- **一貫性最優先**: 複数の技術選択肢がある場合、プロジェクト全体の一貫性を最重視
- **既存設計との整合性**: 新機能は既存のアーキテクチャ・パターンに準拠
- **最終判断の明確化**: 外部助言（Gemini等）は参考とし、最終的な技術判断は一貫した基準で実施
- **保守性重視**: 後続開発者が理解しやすい、予測可能な実装パターンを維持
- **設計思想の継承**: 既存コードから新機能の実装方針が推測できる統一されたパターンを維持

#### **戦略的アプローチ適用時の重要な前提・制約**
**実装フェーズでの成功要因**：
```
🎯 目的の明確化：
- 動作するソフトウェアの段階的実装
- ビルド成功維持・品質確保・機能完成の両立
- Phase毎の価値提供・技術検証・ユーザビリティ確保

⚠️ 避けるべきパターン：
- 場当たり的修正（症状対処ではなく原因解決）
- 過度な最適化（Phase完了を阻害する複雑化）
- 機能削除による回避（本質的解決ではない）
- スコープクリープ（Phase境界を超えた実装）

✅ 成功パターン：
- 段階的実装（最小動作版→基本機能→拡張機能）
- 戦略的思考（問題の本質を見極めて方針決定）
- 品質管理（ビルド成功・テスト・コードレビュー）
- 根本原因解決（アーキテクチャ整合性・設計思想継承）
```

### 🔄 スクラム開発サイクル（正式採用）
**2025-07-09決定：縦方向スライス実装での標準開発サイクル**

**📋 詳細仕様**: [ADR_011: スクラム開発サイクル採用](/Doc/07_Decisions/ADR_011_スクラム開発サイクル採用.md)

**開発サイクル**: `計画 → 実装 → テスト → フィードバック → 修正 → テスト → ...`

**対象**: 縦方向スライス実装（ユーザー管理・プロジェクト管理・ドメイン管理・ユビキタス言語管理）

### 📈 継続的改善の実施
日次セッション記録に以下を記録し、手法の継続的改善を実施：
- **改善点**: 実施中に発見された問題点・非効率な部分
- **改善案**: 次回セッション以降での改善策
- **効果測定**: 改善策の実施効果評価
- **知見蓄積**: 成功パターン・失敗パターンの体系化

### 📋 週次振り返りでの体系見直し
週次総括時に以下の継続的改善を実施：
- **CLAUDE.md妥当性チェック**: 論理的矛盾・古い情報・不要セクションの確認
- **ドキュメント運用評価**: ファイル配置・命名・役割分担の適切性確認
- **セッション管理最適化**: 読み込みパターン・チェックリストの効率性確認
- **プロセス改善提案**: 発見された非効率な部分の改善策検討