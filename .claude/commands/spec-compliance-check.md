# 仕様準拠確認Command

**目的**: 実装の仕様準拠を95点以上の高精度でチェック
**対象**: 全実装作業完了時
**連携**: spec-analysis, spec-compliance SubAgent
**強化内容**: SpecKit概念統合・加重スコアリング・自動証跡記録

## 🎯 強化版スコアリング体系（100点満点）

### 加重スコアリング構成
```yaml
肯定的仕様準拠度: 50点満点（重要度: 最高）
  - 必須機能実装: 30点
  - 推奨機能実装: 15点
  - 拡張機能実装: 5点

否定的仕様遵守度: 30点満点（重要度: 高）
  - 禁止事項遵守: 20点
  - 制約条件遵守: 10点

実行可能性・品質: 20点満点（重要度: 中）
  - テストカバレッジ: 8点
  - パフォーマンス: 6点
  - 保守性: 6点
```

## コマンド実行内容

### 1. 強化版仕様準拠マトリックス確認
```bash
# 加重スコアリング仕様準拠マトリックス確認
echo "🔍 加重スコアリング仕様準拠マトリックス確認を開始..."
```

**確認項目**:
- [ ] `/Doc/08_Organization/Active/Phase_XX/Research/Spec_Compliance_Matrix.md` の全項目チェック
- [ ] **新規**: 重要度による加重スコア計算（critical: x3, high: x2, medium: x1）
- [ ] **新規**: 肯定的仕様・否定的仕様の分離評価
- [ ] **新規**: リアルタイムスコア計算・表示

### 2. 実行可能仕様（Executable Specifications）確認

**肯定的仕様（実装すべき機能）- 50点満点**:
- [ ] 機能仕様書の要求事項が全て実装されているか（30点）
  - 必須機能: 各5点 x 6項目 = 30点
- [ ] UI設計書の画面要素が適切に配置されているか（15点）
  - レイアウト準拠: 10点
  - インタラクション準拠: 5点
- [ ] ビジネスルールが正しく実装されているか（5点）
  - 複雑ビジネスロジック: 5点

**否定的仕様（実装してはいけない機能）- 30点満点**:
- [ ] セキュリティ要件に反する実装がないか（20点）
  - 認証回避: -20点リスク
  - データ漏洩リスク: -15点リスク
  - XSS/SQLi脆弱性: -10点リスク
- [ ] パフォーマンス制約に違反する実装がないか（10点）
  - 応答時間制約違反: -10点リスク
  - メモリリーク: -8点リスク

### 3. 自動証跡記録・コードスニペット収集（新機能）

```bash
echo "📋 実装証跡の自動収集を開始..."
```

**証跡収集項目**:
- [ ] **実装箇所自動検出**: 仕様項番コメントからの逆引き
- [ ] **コードスニペット収集**: 重要実装部分の自動抽出
- [ ] **スクリーンショット証跡**: 動作確認画面の自動キャプチャ（概念のみ）
- [ ] **実装行番号マッピング**: 仕様項番 ↔ ソースコード行番号対応表

**出力ファイル**:
- `/Doc/08_Organization/Active/Phase_XX/Research/Spec_Compliance_Evidence.md` （新規自動生成）
- `/Doc/08_Organization/Active/Phase_XX/Research/Implementation_Mapping.json` （新規・構造化データ）

**コード内仕様書項番コメント確認**:
```csharp
// 例: 仕様2.1.1準拠コメント確認
// 仕様2.1.1: ユーザー名バリデーション（2-50文字）
RuleFor(x => x.Name)
    .MinimumLength(2).WithMessage("ユーザー名は2文字以上で入力してください。");
```

- [ ] 重要な実装箇所に仕様書項番コメントが記載されている
- [ ] コメント内容と実装内容が一致している
- [ ] 仕様変更時にコメントも更新されている

### 4. データベース設計準拠確認（継続）
- [ ] テーブル構造が設計書通りに実装されている
- [ ] 制約（主キー・外部キー・一意制約）が適切に設定されている
- [ ] PostgreSQL固有機能（TIMESTAMPTZ、JSONB等）が活用されている

### 5. リアルタイム品質監視（新機能）

**自動監査トリガー**:
```bash
# Git pre-commit hookとしての実行（提案）
echo "🔄 リアルタイム品質監視を設定..."
```
- [ ] **コミット前自動チェック**: pre-commit hook設定
- [ ] **PR作成時必須チェック**: GitHub Actions連携
- [ ] **日次定期監査**: 夜間バッチによる全体スキャン
- [ ] **Step完了時必須監査**: 現行維持

**エラーハンドリング・ユーザビリティ確認**:
- [ ] 適切なエラーメッセージが表示される
- [ ] バリデーションエラーがユーザーフレンドリーな形で表示される
- [ ] 例外処理が適切に実装されている

## 🎯 強化版品質判定（加重スコアリング）

### 総合品質判定（目標95点以上）
✅ **98-100点**: 最優秀品質 → 即座リリース・ベストプラクティス認定
✅ **95-97点**: 優秀品質 → 即座リリース可能・軽微改善提案あり
⚠️ **90-94点**: 良好品質 → 重要指摘事項改善後リリース可能
⚠️ **85-89点**: 改善必要 → 項目的改善・再チェック必須
❌ **85点未満**: 品質不適格 → 大幅実装修正・全面見直し

### 分野別スコア閾値
- **肯定的仕様準拠**: 45点以上必須（90%以上）
- **否定的仕様遵守**: 27点以上必須（90%以上）
- **実行可能性・品質**: 18点以上推奨（90%以上）

### 個別スコア対応
- **仕様準拠スコア 90点未満**: spec-compliance再実行必要
- **設計品質スコア 85点未満**: design-review再実行必要
- **重複実装検出**: 統一作業必要（優先度高）
- **原典照合エラー**: 仕様書再読み込み必要

## SubAgent連携（強化版フロー）

### 強化版SubAgent実行順序
```yaml
1. spec-analysis:
   purpose: 原典仕様書分析 + 重要度判定
   output: 加重スコアリング対応仕様マトリックス

2. spec-compliance:
   purpose: 加重スコア準拠監査 + 証跡自動記録
   input: 強化版仕様マトリックス
   output: 95点以上品質レポート + 実装証跡

3. spec-validate（新規）:
   purpose: 仕様完全性・実行可能性検証
   output: 検証レポート + 改善提案
```

### 並列実行最適化
- **spec-compliance** + **code-review**: 品質監査並列実行
- **unit-test** + **integration-test**: テスト品質並列確認
- **design-review**: 設計品質スコアリング（必要時）

## 🔄 継続改善機能（新機能）

### 学習機能
- [ ] **過去品質データ分析**: Phase間での品質向上トレンド
- [ ] **頻出問題パターン**: 改善提案の自動化
- [ ] **ベストプラクティス蓄積**: 高品質実装パターンの記録

### 品質メトリクス
- [ ] **品質向上率**: Phase間での改善度測定
- [ ] **準拠度安定性**: 品質のばらつき測定
- [ ] **実装効率**: 品質維持での開発速度

## 実行後アクション

### ✅ 95点以上達成時
```bash
echo "🎉 品質目標達成！次Phase実装準備完了"
# Serena memory更新: 品質実績・学習事項記録
# GitHub Issues自動クローズ（品質関連Issue）
```

### ⚠️ 95点未満時
```bash
echo "⚠️ 品質改善が必要です"
# 改善計画の自動生成
# 優先度付き改善タスクリスト作成
# 再実行スケジュール提案
```

---

**変更履歴**:
- 2025-09-25: 強化版統合（SpecKit概念統合・加重スコアリング・証跡自動記録）
- 初版: 基本的な仕様準拠チェック機能