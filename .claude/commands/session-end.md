# セッション終了Command

**目的**: セッション終了時の必須プロセスを自動実行  
**対象**: 全セッション  
**実行タイミング**: ユーザーが「セッション終了」宣言時

## コマンド実行内容

### 1. セッション目的達成確認（必須）
- [ ] **目的達成判定**: セッション開始時に設定した具体的目的と実績を照合・達成率算出
- [ ] **完了事項確認**: TodoWriteツールで管理されたタスクの完了状況確認
- [ ] **未完了事項整理**: 継続が必要な作業・課題の明確化・次回優先度設定
- [ ] **ユーザー報告**: 目的達成度・完了事項・継続事項を報告しセッション終了承認取得

### 2. Step終了時Command実行（Step完了時）
- [ ] `step-end-review` Command: 包括的品質・進捗確認
- [ ] `spec-compliance-check` Command: 仕様準拠監査（実装作業完了時）
- [ ] `tdd-practice-check` Command: TDD実践確認（実装作業時）

### 3. 成果・実績記録
- [ ] **主要成果整理**: 具体的な完了項目・作成ファイル・変更内容の詳細記録
- [ ] **技術的知見記録**: 新発見・ベストプラクティス・学習事項の具体的記録
- [ ] **問題解決記録**: 発生エラー・解決手法・回避策・再発防止策の詳細記録
- [ ] **創出物確認**: 新規作成ファイル・更新ファイルの品質・内容確認

### 4. 品質・効率評価
- [ ] **目的達成度定量評価**: 100%/80%/60%等の数値化・未達成要因分析
- [ ] **時間効率測定**: 予定時間vs実際時間の比較・効率化要因・時間ロス要因特定
- [ ] **適用手法効果検証**: SubAgent・Commands・並列実行等の具体的効果測定
- [ ] **品質評価**: 成果物品質（0エラー0警告等）・プロセス品質・ユーザー満足度

### 5. 課題・改善管理
- [ ] 発見された課題・問題点の記録（技術的・プロセス的・コミュニケーション）
- [ ] 継続課題の更新（解決済みマーク・新規追加・優先度変更）
- [ ] コミュニケーション改善事項の確認（COM-XXX課題の状況更新）
- [ ] プロセス改善提案（次回セッション以降の改善案）

### 6. Command実行品質確認（必須）
- [ ] **🔧 command-quality-check Command実行** → 今回セッションで実行したCommand品質確認
- [ ] **実行Command一覧確認**: session-start・phase-start・step-start・step-end-review等の実行確認
- [ ] **品質評価記録**: 各Command実行の具体性・完全性・実効性評価
- [ ] **改善提案記録**: Command改善点・プロセス最適化提案の記録

### 7. 次回準備・引き継ぎ
- [ ] 次回セッション予定事項の設定（具体的作業内容・準備事項）
- [ ] 申し送り事項の更新（重要な制約・前提・注意点）
- [ ] 技術的前提条件の整理（開発環境・依存関係・設定状況）
- [ ] Phase状況の更新（現在Phase・次Phase・実装計画）

### 8. 記録・文書化（必須）
- [ ] **セッション記録作成（Issue #34完了まで）**: `/Doc/04_Daily/YYYY-MM/YYYY-MM-DD-{セッション番号}-{セッション概要}.md`に詳細記録
- [ ] **ADR化検討**: 重要な技術選定・アーキテクチャ決定・プロセス決定のADR化要否判断
- [ ] **プロジェクト状況更新**: Serenaメモリー`project_overview`の以下セクション更新
  - 現在のプロジェクト状況（Phase進捗・完了事項）
  - 次回セッション推奨範囲（最優先事項・読み込み推奨ファイル・予想時間配分）
- [ ] **週次総括反映**: 週末セッションの場合は週次総括への重要事項反映確認

### 9. Serenaメモリー更新（必須・直接ファイル編集方式）

#### 🔴 重要：Context効率化のため直接ファイル編集を使用
**理由**: Context消費87.5%削減・時間75%短縮達成
**適用範囲**: session-endコマンド実行時のみ（手動操作・他コマンドでは従来通り`write_memory`使用可能）
**禁止事項**: session-end時は`mcp__serena__read_memory` / `mcp__serena__write_memory`使用禁止

#### 更新手順（全メモリー共通）
1. **Grepツール**: 更新対象セクション・行を検索
2. **Readツール**: 必要箇所のみ部分読み込み（limit指定推奨）
3. **Editツール**: 該当箇所のみ差分更新（置換・追記・削除）

#### 各メモリー更新詳細

- [ ] **daily_sessions更新（`.serena/memories/daily_sessions.md`）**:
  ```
  1. Readツールで先頭100行読み込み（本日日付セクション有無確認）
  2. Editツールで以下のいずれかを実行:
     - 既存日付セクションがある場合: 該当セクション内に「セッション2」「セッション3」追記
     - 既存日付セクションがない場合: 新規日付セクション作成後「セッション1」追記
  3. 30日超の古い記録削除が必要な場合: Grepで特定→Editで削除
  ```

- [ ] **project_overview更新（`.serena/memories/project_overview.md`）**:
  ```
  変更がある場合のみ:
  1. Grep "## 現在のプロジェクト状況" で該当セクション特定
  2. Read該当セクション周辺（100-200行程度）
  3. Editツールで該当セクションのみ置換
  変更がない場合: スキップ
  ```

- [ ] **development_guidelines更新（`.serena/memories/development_guidelines.md`）**:
  ```
  変更がある場合のみ:
  1. Grep該当セクション名（例: "## 🔧 SubAgent責務境界原則"）で特定
  2. Read該当セクション周辺
  3. Editツールで新規セクション追記 or 既存セクション更新
  変更がない場合: スキップ
  ```

- [ ] **tech_stack_and_conventions更新（`.serena/memories/tech_stack_and_conventions.md`）**:
  ```
  変更がある場合のみ:
  1. Grep該当セクション名（例: "## F# 実装規約・パターン"）で特定
  2. Read該当セクション周辺
  3. Editツールで新規追記 or セクション更新
  変更がない場合: スキップ
  ```

- [ ] **task_completion_checklist更新（`.serena/memories/task_completion_checklist.md`）**:
  ```
  1. Grep該当タスク名で特定
  2. Editツールでタスク状態更新（`- [ ]` → `- [x]`）
  3. 新規タスク追加が必要な場合: Editで該当優先度位置に追記
  ```

- [ ] **メモリー更新品質確認**:
  - 各メモリーの差分更新が適切に実行されたか確認
  - 既存重要情報が維持されているか確認（破壊的変更なし）
  - 次回セッションで参照可能な状態か確認

### 10. Command実行完了確認・継続判断

#### 🔴 必須実行確認（自己チェック）
**実行証跡必須確認**:
- [ ] **Write/Editツール実行結果確認**: 以下の必須ファイル作成・更新が実際に実行されたか
  - [ ] `/Doc/04_Daily/YYYY-MM/YYYY-MM-DD.md` 作成済み（Issue #34完了まで・オプション）

- [ ] **Readツール実行確認**: 各メモリー更新に必要な箇所の部分読み込み実行
  - [ ] daily_sessions部分読み込み済み（先頭100行程度）
  - [ ] project_overview該当セクション読み込み済み（変更がある場合のみ）
  - [ ] development_guidelines該当セクション読み込み済み（変更がある場合のみ）
  - [ ] tech_stack_and_conventions該当セクション読み込み済み（変更がある場合のみ）
  - [ ] task_completion_checklist該当タスク周辺読み込み済み（変更がある場合のみ）

- [ ] **Editツール実行確認**: 差分更新で5種類のメモリー更新
  - [ ] daily_sessions差分追記実行済み（本日セッション追加・30日超削除含む）
  - [ ] project_overview差分更新実行済み（変更がある場合のみ・スキップ可）
  - [ ] development_guidelines差分追記実行済み（変更がある場合のみ・スキップ可）
  - [ ] tech_stack_and_conventions差分追記実行済み（変更がある場合のみ・スキップ可）
  - [ ] task_completion_checklist状態更新実行済み（変更がある場合のみ・スキップ可）

- [ ] **write_memory不使用確認**: session-end時は`mcp__serena__write_memory`使用していないことを確認

- [ ] **実行内容品質確認**: 各更新内容が具体的・実用的で次回セッションで参照可能か

#### 🔴 実行漏れ防止チェック
- [ ] **抽象的報告の排除**: 「実施しました」ではなく実際のツール呼び出し実行済み
- [ ] **段階的実行**: 各項目を順次実行し実行結果確認してから次項目へ進行済み
- [ ] **自己検証完了**: 上記全項目の実行証跡確認済み

#### 継続・終了判断
- [ ] **Command実行完了確認**: 上記自己チェック全項目が実行完了していることを確認
- [ ] **継続判断**: ユーザーが継続を希望する場合は新たな目的設定を依頼
- [ ] **継続処理**: 継続の場合は新セッション開始プロセスへ移行
- [ ] **終了処理**: 終了の場合は全記録完了確認・次回セッション準備完了宣言

## 実行後アクション
✅ セッション完了 → プロジェクト状況更新・記録完了  
🔄 継続希望 → 新セッション目的設定・session-start Command実行  
⚠️ 未完了事項あり → 該当項目を次回最優先事項に設定

## 関連プロセス
- SubAgent活用: step-end-review, spec-compliance-check, tdd-practice-check Commands
- 記録テンプレート: `/Doc/04_Daily/セッション終了時記録テンプレート.md`
- 管理更新: `/Doc/プロジェクト状況.md`

## 自動実行トリガー
- ユーザー発言: "セッション終了"
- ユーザー発言: "セッションを終了します"  
- ユーザー発言: "終了します"（セッション文脈時）
- ユーザー発言: "セッション終了宣言"