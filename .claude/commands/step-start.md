# Step開始準備Command

**目的**: Step開始時の必須準備プロセス・組織設計を自動実行  
**対象**: 全Step開始時（Step1, Step2, Step3...）  
**実行タイミング**: ユーザーが「Step開始」「StepXX開始」「次Step開始」宣言時

## コマンド実行内容

### 1. Step情報収集・確認（必須）
- [ ] **Phase状況確認**: `/Doc/08_Organization/Active/Phase_XX/`配下の現在Phase状況確認
- [ ] **前Step完了確認**: 前Step完了レビュー結果・成果物出力状況確認
- [ ] **Phase計画確認**: `Phase_Summary.md`から全Step構成・当該Step位置確認
- [ ] **次Step判定**: Phase計画から実行すべき次Stepの自動判定
- [ ] **🆕 Step1成果物参照準備**: `Phase_Summary.md`の「Step間成果物参照マトリックス」から当該Step必須参照ファイル特定

### 2. Step組織設計（簡素化・効率化）
- [ ] **Step特性判定**: 当該Stepの作業特性判断（分析/実装/テスト/統合/品質保証）
- [ ] **段階種別判定**: Phase B/C/D対応・段階種別の自動判定
  - **基本実装段階（1-3）**: 基本CRUD・関連機能・機能完成
  - **品質保証段階（4-6）**: 技術負債解消・UI/UX最適化・統合テスト
  - **拡張段階（7-8）**: 高度機能・外部連携・運用最適化
- [ ] **🎯 SubAgent組み合わせ選択**: 特性・段階に応じたPattern A/B/C/D/Eから選択
  - **Pattern A**: 新機能実装 (Domain→Application→Infrastructure→Web UI)
  - **Pattern B**: 機能拡張 (影響分析→実装・統合→品質保証)
  - **Pattern C**: 品質改善 (課題分析→改善実装→検証・完成)
  - **Pattern D**: 品質保証段階 (技術負債特定→品質改善→統合検証)
  - **Pattern E**: 拡張段階 (外部連携設計→拡張実装→運用準備)
- [ ] **🚀 並列実行必須**: 選択SubAgentを同一メッセージ内で複数Task実行
- [ ] **StepXX_[内容].md作成**: Step組織設計記録ファイル作成（簡素化テンプレート）
- [ ] **🆕 Step1成果物必須参照セクション追加**: 当該Step組織設計記録にStep1分析成果の必須参照リスト自動追加

### 2.5 タスク分解・TodoList生成（🆕 新機能追加）
```bash
echo "📋 Step作業のタスク分解・TodoList生成を開始..."
```
- [ ] **🔧 task-breakdown Command自動実行**: 当該Stepの作業を構造化・タスク分解
  - **GitHub Issue読み込み**: 関連Issue（特に高優先度・phase-B1ラベル）の自動取得
  - **Step作業の層別分解**: Clean Architecture層別（Domain→Application→Infrastructure→Web）
  - **テスト作業分解**: 単体テスト・統合テスト・E2Eテスト・権限テスト
  - **品質確認作業**: spec-compliance・code-review・TDD実践
  - **依存関係・実行順序決定**: 並列実行可能タスクとシーケンシャルタスクの識別

- [ ] **TodoList自動生成・反映**: task-breakdown結果をTodoWriteツールに自動反映
  - **高優先度タスク設定**: Issue対応・設計書作成等を`in_progress`で開始
  - **工数見積もり付与**: 各タスクに概算時間（30分/1時間/2時間等）
  - **並列実行タスク識別**: 同時実行可能タスクのグルーピング
  - **Stage構成連携**: Step内Stage構成とタスク実行順序の対応

- [ ] **タスクリスト提示・確認**: 生成されたタスクリストをユーザーに提示
  - **分解結果概要**: 「XX個のタスクに分解、推定YY時間、Z個並列実行可能」
  - **高優先度タスク確認**: Issue対応・設計不備改善等の優先実行確認
  - **実行順序確認**: 依存関係を考慮した実行計画の妥当性確認
  - **ユーザー承認**: タスクリスト・実行計画の最終承認取得

### 3. Step Stage構成設計（段階種別対応・品質チェックStage組み込み）
- [ ] **🎯 Step内Stage構成設計（段階種別対応）**:
  ```
  【基本実装段階（1-3）用構成】
  Stage 1: 設計・技術調査
  Stage 2: TDD Red（テスト作成）
  Stage 3: TDD Green（実装）
  Stage 4: 品質チェック＆リファクタリング統合
  Stage 5: 統合確認

  【品質保証段階（4-6）用構成】
  Stage 1: 技術負債特定・改善計画
  Stage 2: 品質改善実装（リファクタリング）
  Stage 3: 品質チェック重点実行
    - code-review（品質レビュー）
    - spec-compliance（仕様準拠確認）
    - integration-test（統合テスト）
  Stage 4: UI/UX最適化（該当時）
  Stage 5: E2E検証・パフォーマンステスト

  【拡張段階（7-8）用構成】
  Stage 1: 外部連携設計・セキュリティ要件
  Stage 2: 拡張機能実装
  Stage 3: 外部連携テスト
  Stage 4: セキュリティ・性能確認
  Stage 5: 運用準備・監視設定
  ```
- [ ] **成果物出力先更新**: `/Doc/08_Organization/Active/Phase_XX/Research/`配下
- [ ] **仕様書照合確認**: Step対象機能の機能仕様書セクション特定

### 4. 技術的前提条件確認
- [ ] **開発環境確認**: 必要な開発環境・ツール・依存関係の確認
- [ ] **技術基盤継承**: 前Stepで確立された技術基盤・パターンの継承確認
- [ ] **データベース状況確認**: マイグレーション・テストデータの状況確認
- [ ] **ビルド・テスト状況確認**: 0エラー0警告状態・テスト成功率確認

### 5. TDD実践必須化（ルール組み込み）
- [ ] **✅ TDD必須宣言**: 実装系SubAgent全てでTDD実践を必須化
- [ ] **TDDサイクル開始**: Red-Green-Refactorサイクル明示開始
- [ ] **テストファースト**: 必ずテストから作成するルール確認
- [ ] **品質バリア設定**: 0エラー0警告・テスト100%成功の維持

### 5.6. テストプロジェクト作成判定・ガイダンス（🆕 Issue #40再発防止）
**条件**: unit-test/integration-testAgentが選択され、かつ新規テストプロジェクト作成が予想される場合
**目的**: Issue #40再発防止・テストアーキテクチャ標準遵守

- [ ] **🧪 テストプロジェクト作成判定**:
  - Step作業内容から新規テストプロジェクト作成の必要性判定
  - 既存プロジェクト一覧との照合（tests/配下のスキャン）

- [ ] **📚 必須ドキュメント参照指示**:
  - SubAgentへの指示に以下を自動追加：
    * ADR_020: テストアーキテクチャ決定
    * `/Doc/02_Design/テストアーキテクチャ設計書.md`
    * `/Doc/08_Organization/Rules/新規テストプロジェクト作成ガイドライン.md`

- [ ] **✅ チェックリスト実施確認**:
  - SubAgent実行前に必須確認事項の明示的提示
  - ユーザー承認時に「ガイドライン確認完了」の明示的確認

### 5.5. Step1完了時特別処理（🆕 調査分析Step専用）
**条件**: Step特性 == "分析段階" AND Step番号 == 1
**目的**: Step1調査分析成果の後続Step確実活用体制確立

- [ ] **📊 Step間成果物参照マトリックス自動生成**:
  - Research/配下の全成果物自動スキャン・分析
  - 後続Step2-5の作業内容との対応関係自動分析
  - Step別必須参照ファイル・重点セクション・活用目的の自動マッピング
  - Phase_Summary.mdの「Step間成果物参照マトリックス」セクション自動更新

- [ ] **📋 後続Step組織設計記録への参照リスト準備**:
  - Step2-5の各Step組織設計記録ファイル用参照テンプレート作成
  - 各Stepに固有な必須参照セクション・確認事項の事前準備
  - SubAgent実行指示への参照ファイルパス埋め込み準備

- [ ] **🎯 Step1成果活用体制完成確認**:
  - Phase_Summary.md参照マトリックス記載確認
  - Step2-5参照テンプレート準備完了確認
  - step-start Command自動参照機能動作確認

### 6. Step開始承認（簡素化）
- [ ] **Step目的・成果物明示**: 当該Stepの具体的目的・期待成果の明示
- [ ] **SubAgent並列実行計画提示**: 選択SubAgent・並列実行計画をユーザーに提示
- [ ] **🆕 Step1成果物必須参照提示**: 当該Step必須参照ファイル・重点セクションをユーザーに明示
- [ ] **❗ ユーザー承認取得**: Step開始・SubAgent並列実行の最終承認（必須）

## StepXX.md作成テンプレート

### Step1（分析）の場合
```markdown
# Step 01 組織設計・実行記録

## 📋 Step概要
- Step名: Step01 Analysis
- 作業特性: 分析・技術調査・計画詳細化
- 推定期間: XX セッション
- 開始日: YYYY-MM-DD

## 🏢 組織設計
### SubAgent構成
[subagent-selection Command実行結果に基づく]

### 並列実行計画
[subagent-selection Command実行結果に基づく並列実行戦略]

## 🎯 Step成功基準
- 包括的分析完了・技術検証完了
- 実装計画詳細化・次Step準備完了
- 成果物品質確認・活用準備完了
- **🆕 Step間成果物参照マトリックス生成完了**（Phase_Summary.md更新）

## 📊 Step実行記録（随時更新）
[実施中に更新]

## ✅ Step終了時レビュー

### 🆕 Step1完了時必須処理（5.5節準拠）

#### 📊 Step間成果物参照マトリックス生成
**Phase_Summary.mdに以下のマトリックスセクションを追加**:

```markdown
## 📊 Step間成果物参照マトリックス

### Step1成果物の後続Step活用計画
| Step | 作業内容 | 必須参照（Step1成果物） | 重点参照セクション | 活用目的 |
|------|---------|----------------------|-------------------|---------|
| **Step2** | [作業内容] | [参照ファイル名] | [セクション名] | [活用目的] |
| **Step3** | [作業内容] | [参照ファイル名] | [セクション名] | [活用目的] |
...

### 成果物ファイル所在
**出力ディレクトリ**: `/Doc/08_Organization/Active/Phase_XX/Research/`
- [成果物1ファイル名] - [概要説明]
- [成果物2ファイル名] - [概要説明]
...

**前Phase成果物**（継承・参照が必要な場合）:
- [継承元ファイルパス] - [参照目的]
...
```

**生成手順**:
1. Research/配下の全成果物ファイルスキャン・内容分析
2. Phase_Summary.mdの「全Step実行プロセス」から後続Step作業内容確認
3. 各Stepの作業内容と成果物セクションの対応関係分析
4. Step別必須参照ファイル・重点セクション・活用目的をマトリックス化
5. 成果物ファイル所在情報の明記
6. 前Phase成果物の継承・参照情報記載（該当時）

**参考実績**: `/Doc/08_Organization/Completed/Phase_B1/Phase_Summary.md` 251-278行

[Step完了時に更新]
```

### Step2以降（実装）の場合
```markdown
# Step XX 組織設計・実行記録

## 📋 Step概要
- Step名: Step02 [実装内容]
- 作業特性: 実装・テスト・統合
- 推定期間: XX セッション
- 開始日: YYYY-MM-DD

## 🏢 組織設計
### SubAgent構成
[Step作業特性に応じた構成]

### Step1分析結果活用
- 活用する分析結果・技術調査結果
- 実装方針・技術選択の根拠

## 🎯 Step成功基準
[Step固有の成功基準]

## 📊 Step実行記録（随時更新）
[実施中に更新]

## ✅ Step終了時レビュー
[Step完了時に更新]
```

## 実行後アクション

### Step準備完了時
✅ **Step開始準備完了** → ユーザー承認取得後にSubAgent並列実行・Step作業開始  
⚠️ **準備不足項目あり** → 不足項目完了・再確認実施  
❌ **前Step未完了** → 前Step完了確認・完了後再実行

### SubAgent実行開始条件
- **必須**: ユーザーによるSubAgent実行計画承認
- **確認事項**: 選択SubAgent・並列実行戦略・推定所要時間の最終承認
- **実行開始**: 承認取得後にSubAgent並列実行開始

### 次プロセス連携
- **SubAgent並列実行**: ユーザー承認後の専門作業実行
- **step-end-review**: Step完了時の包括的品質確認・レビュー
- **次step-start**: 当Step完了後の次Step準備

## 実行トリガー
- ユーザー発言: "Step開始"、"次Step開始"
- ユーザー発言: "StepXX開始"、"Step XX開始してください"
- ユーザー発言: "Step開始準備"、"次のStep準備"
- Phase実行中の自然な次Step移行時

## 関連Command・プロセス
- **前提**: phase-start完了または前Step完了
- **連携**: SubAgent並列実行 → step-end-review → 次step-start
- **参考**: 組織管理運用マニュアル・ファイル管理規約準拠