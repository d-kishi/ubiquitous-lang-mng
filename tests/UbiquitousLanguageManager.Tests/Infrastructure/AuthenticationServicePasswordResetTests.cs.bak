using System;
using System.Threading.Tasks;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Logging;
using Microsoft.FSharp.Core;
using Moq;
using Xunit;
using UbiquitousLanguageManager.Application;
using UbiquitousLanguageManager.Domain;
using UbiquitousLanguageManager.Infrastructure.Services;

namespace UbiquitousLanguageManager.Tests.Infrastructure;

/// <summary>
/// AuthenticationService ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹
/// 
/// ã€F#åˆå­¦è€…å‘ã‘è§£èª¬ã€‘
/// Phase A3ã§å®Ÿè£…ã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®å˜ä½“ãƒ†ã‚¹ãƒˆã€‚
/// ADR_013ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆé–‹ç™ºã«å¾“ã„ã€å®Ÿè£…å‰ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã€‚
/// 
/// ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®ãŸã‚ã€å¢ƒç•Œå€¤ãƒ»ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã‚’ç¶²ç¾…çš„ã«ãƒ†ã‚¹ãƒˆ
/// ğŸ“Š ADR_008æº–æ‹ : ãƒ­ã‚°å‡ºåŠ›ã®æ¤œè¨¼ã‚‚å«ã‚€
/// </summary>
public class AuthenticationServicePasswordResetTests
{
    private readonly Mock<Microsoft.Extensions.Logging.ILogger<AuthenticationService>> _loggerMock;
    private readonly Mock<UserManager<IdentityUser>> _userManagerMock;
    private readonly Mock<INotificationService> _notificationServiceMock;
    private readonly Mock<IUserRepository> _userRepositoryMock;
    private readonly AuthenticationService _authenticationService;

    /// <summary>
    /// ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
    /// </summary>
    /// <remarks>
    /// ğŸ”§ Blazor Serverãƒ»F#åˆå­¦è€…å‘ã‘è§£èª¬:
    /// UserManager<IdentityUser>ã®ãƒ¢ãƒƒã‚¯ä½œæˆã¯è¤‡é›‘ãªãŸã‚ã€å°‚ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
    /// </remarks>
    public AuthenticationServicePasswordResetTests()
    {
        _loggerMock = new Mock<Microsoft.Extensions.Logging.ILogger<AuthenticationService>>();
        _userManagerMock = CreateUserManagerMock();
        _notificationServiceMock = new Mock<INotificationService>();
        _userRepositoryMock = new Mock<IUserRepository>();

        _authenticationService = new AuthenticationService(
            _loggerMock.Object,
            _userManagerMock.Object,
            _notificationServiceMock.Object,
            _userRepositoryMock.Object);
    }

    #region RequestPasswordResetAsync Tests

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ - æ­£å¸¸ã‚±ãƒ¼ã‚¹
    /// </summary>
    [Fact]
    public async Task RequestPasswordResetAsync_ValidUser_ShouldSucceed()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var identityUser = new IdentityUser { Email = email.Value, EmailConfirmed = true };
        var resetToken = "valid_reset_token_123";

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);
        _userManagerMock.Setup(x => x.IsEmailConfirmedAsync(identityUser))
            .ReturnsAsync(true);
        _userManagerMock.Setup(x => x.GeneratePasswordResetTokenAsync(identityUser))
            .ReturnsAsync(resetToken);
        _notificationServiceMock.Setup(x => x.SendPasswordResetEmailAsync(
                It.IsAny<Email>(), It.IsAny<string>(), It.IsAny<string>()))
            .ReturnsAsync(FSharpResult<Unit, string>.NewOk(null));

        // Act
        var result = await _authenticationService.RequestPasswordResetAsync(email);

        // Assert
        Assert.True(result.IsOk);
        
        // ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
        _notificationServiceMock.Verify(x => x.SendPasswordResetEmailAsync(
            email, It.IsAny<string>(), It.IsAny<string>()), Times.Once);
            
        // ğŸ“Š ADR_008æº–æ‹ : é©åˆ‡ãªãƒ­ã‚°å‡ºåŠ›ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Information, "Password reset requested");
        VerifyLogCalled(LogLevel.Information, "Password reset email sent successfully");
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ - å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ï¼‰
    /// </summary>
    [Fact]
    public async Task RequestPasswordResetAsync_NonExistentUser_ShouldSucceedSecurely()
    {
        // Arrange
        var email = Email.Create("nonexistent@example.com").Value;
        
        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync((IdentityUser)null);

        // Act
        var result = await _authenticationService.RequestPasswordResetAsync(email);

        // Assert
        // ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®: å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚æˆåŠŸã¨ã—ã¦è¿”ã™ï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ—æŒ™æ”»æ’ƒå¯¾ç­–ï¼‰
        Assert.True(result.IsOk);
        
        // ğŸ“® ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å‘¼ã°ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼
        _notificationServiceMock.Verify(x => x.SendPasswordResetEmailAsync(
            It.IsAny<Email>(), It.IsAny<string>(), It.IsAny<string>()), Times.Never);
            
        // ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Warning, "Password reset requested for non-existent user");
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ - ãƒ¡ãƒ¼ãƒ«æœªç¢ºèªãƒ¦ãƒ¼ã‚¶ãƒ¼
    /// </summary>
    [Fact]
    public async Task RequestPasswordResetAsync_UnconfirmedEmail_ShouldFail()
    {
        // Arrange
        var email = Email.Create("unconfirmed@example.com").Value;
        var identityUser = new IdentityUser { Email = email.Value, EmailConfirmed = false };

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);
        _userManagerMock.Setup(x => x.IsEmailConfirmedAsync(identityUser))
            .ReturnsAsync(false);

        // Act
        var result = await _authenticationService.RequestPasswordResetAsync(email);

        // Assert
        Assert.True(result.IsError);
        Assert.Contains("ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå®Œäº†ã—ã¦ã„ãªã„", result.ErrorValue);
        
        // ğŸ“® ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯å‘¼ã°ã‚Œãªã„ã“ã¨ã‚’æ¤œè¨¼
        _notificationServiceMock.Verify(x => x.SendPasswordResetEmailAsync(
            It.IsAny<Email>(), It.IsAny<string>(), It.IsAny<string>()), Times.Never);
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ - ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—
    /// </summary>
    [Fact]
    public async Task RequestPasswordResetAsync_EmailSendFails_ShouldReturnError()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var identityUser = new IdentityUser { Email = email.Value, EmailConfirmed = true };
        
        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);
        _userManagerMock.Setup(x => x.IsEmailConfirmedAsync(identityUser))
            .ReturnsAsync(true);
        _userManagerMock.Setup(x => x.GeneratePasswordResetTokenAsync(identityUser))
            .ReturnsAsync("token");
        _notificationServiceMock.Setup(x => x.SendPasswordResetEmailAsync(
                It.IsAny<Email>(), It.IsAny<string>(), It.IsAny<string>()))
            .ReturnsAsync(FSharpResult<Unit, string>.NewError("SMTP connection failed"));

        // Act
        var result = await _authenticationService.RequestPasswordResetAsync(email);

        // Assert
        Assert.True(result.IsError);
        Assert.Contains("ãƒ¡ãƒ¼ãƒ«é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼", result.ErrorValue);
        
        // ğŸ“Š ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Error, "Failed to send password reset email");
    }

    #endregion

    #region ResetPasswordAsync Tests

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ - æ­£å¸¸ã‚±ãƒ¼ã‚¹
    /// </summary>
    [Fact]
    public async Task ResetPasswordAsync_ValidTokenAndPassword_ShouldSucceed()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var token = "dGVzdF90b2tlbg=="; // Base64UrlEncoded "test_token"
        var newPassword = Password.Create("NewSecurePass123!").Value;
        var identityUser = new IdentityUser { Email = email.Value };

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);
        _userManagerMock.Setup(x => x.ResetPasswordAsync(identityUser, "test_token", newPassword.Value))
            .ReturnsAsync(IdentityResult.Success);
        _userManagerMock.Setup(x => x.UpdateSecurityStampAsync(identityUser))
            .ReturnsAsync(IdentityResult.Success);
        _notificationServiceMock.Setup(x => x.SendPasswordResetConfirmationAsync(email))
            .ReturnsAsync(FSharpResult<Unit, string>.NewOk(null));

        // Act
        var result = await _authenticationService.ResetPasswordAsync(email, token, newPassword);

        // Assert
        Assert.True(result.IsOk);
        
        // ğŸ”„ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
        _userManagerMock.Verify(x => x.UpdateSecurityStampAsync(identityUser), Times.Once);
        
        // ğŸ“§ ç¢ºèªãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼
        _notificationServiceMock.Verify(x => x.SendPasswordResetConfirmationAsync(email), Times.Once);
        
        // ğŸ“Š æˆåŠŸãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Information, "Password reset completed successfully");
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ - å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼
    /// </summary>
    [Fact]
    public async Task ResetPasswordAsync_NonExistentUser_ShouldFail()
    {
        // Arrange
        var email = Email.Create("nonexistent@example.com").Value;
        var token = "dGVzdF90b2tlbg==";
        var newPassword = Password.Create("NewSecurePass123!").Value;

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync((IdentityUser)null);

        // Act
        var result = await _authenticationService.ResetPasswordAsync(email, token, newPassword);

        // Assert
        Assert.True(result.IsError);
        Assert.Contains("ç„¡åŠ¹ãªãƒªã‚»ãƒƒãƒˆè¦æ±‚", result.ErrorValue);
        
        // ğŸ“Š è­¦å‘Šãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Warning, "Password reset attempted for non-existent user");
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ - ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼
    /// </summary>
    [Fact]
    public async Task ResetPasswordAsync_InvalidTokenFormat_ShouldFail()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var invalidToken = "invalid_base64_token!@#";
        var newPassword = Password.Create("NewSecurePass123!").Value;
        var identityUser = new IdentityUser { Email = email.Value };

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);

        // Act
        var result = await _authenticationService.ResetPasswordAsync(email, invalidToken, newPassword);

        // Assert
        Assert.True(result.IsError);
        Assert.Contains("ç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ", result.ErrorValue);
        
        // ğŸ“Š è­¦å‘Šãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Warning, "Invalid token format in password reset");
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ - Identity ãƒªã‚»ãƒƒãƒˆå¤±æ•—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œç­‰ï¼‰
    /// </summary>
    [Fact]
    public async Task ResetPasswordAsync_IdentityResetFails_ShouldReturnUserFriendlyError()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var token = "dGVzdF90b2tlbg==";
        var newPassword = Password.Create("NewSecurePass123!").Value;
        var identityUser = new IdentityUser { Email = email.Value };

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);
        
        // ASP.NET Core Identity ãƒªã‚»ãƒƒãƒˆå¤±æ•—ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        var identityErrors = new[]
        {
            new IdentityError { Code = "InvalidToken", Description = "Invalid token." }
        };
        _userManagerMock.Setup(x => x.ResetPasswordAsync(identityUser, "test_token", newPassword.Value))
            .ReturnsAsync(IdentityResult.Failed(identityErrors));

        // Act
        var result = await _authenticationService.ResetPasswordAsync(email, token, newPassword);

        // Assert
        Assert.True(result.IsError);
        // ğŸ¯ ADR_007æº–æ‹ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
        Assert.Contains("ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ", result.ErrorValue);
        
        // ğŸ“Š è­¦å‘Šãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Warning, "Password reset failed");
    }

    #endregion

    #region ValidatePasswordResetTokenAsync Tests

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ - æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³
    /// </summary>
    [Fact]
    public async Task ValidatePasswordResetTokenAsync_ValidToken_ShouldReturnTrue()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var token = "dGVzdF90b2tlbg==";
        var identityUser = new IdentityUser { Email = email.Value };

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);
        _userManagerMock.Setup(x => x.VerifyUserTokenAsync(
                identityUser, 
                It.IsAny<string>(), 
                "ResetPassword", 
                "test_token"))
            .ReturnsAsync(true);

        // Act
        var result = await _authenticationService.ValidatePasswordResetTokenAsync(email, token);

        // Assert
        Assert.True(result.IsOk);
        Assert.True(result.ResultValue);
        
        // ğŸ“Š Debug ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Debug, "Password reset token validation");
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ - å­˜åœ¨ã—ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼
    /// </summary>
    [Fact]
    public async Task ValidatePasswordResetTokenAsync_NonExistentUser_ShouldReturnFalse()
    {
        // Arrange
        var email = Email.Create("nonexistent@example.com").Value;
        var token = "dGVzdF90b2tlbg==";

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync((IdentityUser)null);

        // Act
        var result = await _authenticationService.ValidatePasswordResetTokenAsync(email, token);

        // Assert
        Assert.True(result.IsOk);
        Assert.False(result.ResultValue);
    }

    /// <summary>
    /// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ - ç„¡åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼
    /// </summary>
    [Fact]
    public async Task ValidatePasswordResetTokenAsync_InvalidTokenFormat_ShouldReturnFalse()
    {
        // Arrange
        var email = Email.Create("test@example.com").Value;
        var invalidToken = "invalid_token_format";
        var identityUser = new IdentityUser { Email = email.Value };

        _userManagerMock.Setup(x => x.FindByEmailAsync(email.Value))
            .ReturnsAsync(identityUser);

        // Act
        var result = await _authenticationService.ValidatePasswordResetTokenAsync(email, invalidToken);

        // Assert
        Assert.True(result.IsOk);
        Assert.False(result.ResultValue);
        
        // ğŸ“Š Debug ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’æ¤œè¨¼
        VerifyLogCalled(LogLevel.Debug, "Token decode failed in validation");
    }

    #endregion

    #region Helper Methods

    /// <summary>
    /// UserManager<IdentityUser> ã®ãƒ¢ãƒƒã‚¯ã‚’ä½œæˆ
    /// </summary>
    /// <remarks>
    /// UserManager ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒè¤‡é›‘ãªãŸã‚ã€å°‚ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
    /// </remarks>
    private static Mock<UserManager<IdentityUser>> CreateUserManagerMock()
    {
        var store = new Mock<IUserStore<IdentityUser>>();
        var mgr = new Mock<UserManager<IdentityUser>>(
            store.Object, null, null, null, null, null, null, null, null);
        mgr.Object.UserValidators.Add(new UserValidator<IdentityUser>());
        mgr.Object.PasswordValidators.Add(new PasswordValidator<IdentityUser>());
        return mgr;
    }

    /// <summary>
    /// ãƒ­ã‚°å‡ºåŠ›ã®æ¤œè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
    /// </summary>
    /// <param name="expectedLevel">æœŸå¾…ã™ã‚‹ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«</param>
    /// <param name="expectedMessage">æœŸå¾…ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¸€éƒ¨</param>
    /// <remarks>
    /// ğŸ“Š ADR_008æº–æ‹ : ãƒ­ã‚°å‡ºåŠ›ã®æ¤œè¨¼
    /// </remarks>
    private void VerifyLogCalled(LogLevel expectedLevel, string expectedMessage)
    {
        _loggerMock.Verify(
            x => x.Log(
                expectedLevel,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((v, t) => v.ToString().Contains(expectedMessage)),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception, string>>()),
            Times.AtLeastOnce);
    }

    #endregion
}